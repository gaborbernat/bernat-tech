{{ $p := .project }}
{{ $cols := .cols }}
{{ $name := $p.name }}
{{ $org := $p.org }}
{{ $repo := or $p.repo $name }}
{{ $label := or $p.label $name }}
{{ $showPypi := ne (or $p.pypi "") "false" }}
{{ $jetbrainsId := $p.jetbrains_id }}
{{ $jetbrainsSlug := $p.jetbrains_slug }}
{{ $noRelease := eq (or $p.no_release "") "true" }}
{{ $ghOpts := dict }}{{ with getenv "HUGO_GITHUB_TOKEN" }}{{ $ghOpts = dict "headers" (dict "Authorization" (printf "Bearer %s" .)) }}{{ end }}

{{ $errors := slice }}
{{ $repoData := dict }}
{{ $result := try (resources.GetRemote (printf "https://api.github.com/repos/%s/%s" $org $repo) $ghOpts) }}
{{ with $result.Value }}{{ $repoData = . | transform.Unmarshal }}{{ end }}
{{ with $result.Err }}{{ $errors = $errors | append (printf "repo-info: %s" .) }}{{ end }}
{{ $defaultBranch := or $repoData.default_branch "main" }}

{{ $lastCommitDate := "" }}
{{ $result = try (resources.GetRemote (printf "https://api.github.com/repos/%s/%s/commits?sha=%s&per_page=1" $org $repo $defaultBranch) $ghOpts) }}
{{ with $result.Value }}
  {{ $commits := . | transform.Unmarshal }}
  {{ with index $commits 0 }}{{ $lastCommitDate = .commit.committer.date }}{{ end }}
{{ end }}
{{ with $result.Err }}{{ $errors = $errors | append (printf "commits: %s" .) }}{{ end }}

{{ $releaseData := dict }}
{{ $result = try (resources.GetRemote (printf "https://api.github.com/repos/%s/%s/releases/latest" $org $repo) $ghOpts) }}
{{ with $result.Value }}{{ $releaseData = . | transform.Unmarshal }}{{ end }}
{{ with $result.Err }}{{ $errors = $errors | append (printf "release: %s" .) }}{{ end }}

{{ $pypiVersion := "" }}
{{ $pypiReleaseDate := "" }}
{{ if $showPypi }}
  {{ $result = try (resources.GetRemote (printf "https://pypi.org/pypi/%s/json" $name)) }}
  {{ with $result.Value }}
    {{ $pypiData := . | transform.Unmarshal }}
    {{ $pypiVersion = $pypiData.info.version }}
    {{ with index $pypiData.urls 0 }}{{ $pypiReleaseDate = .upload_time_iso_8601 }}{{ end }}
  {{ end }}
  {{ with $result.Err }}{{ $errors = $errors | append (printf "pypi-version: %s" .) }}{{ end }}
{{ end }}

{{ $pypiDownloads := 0 }}
{{ if $showPypi }}
  {{ $result = try (resources.GetRemote (printf "https://pypistats.org/api/packages/%s/recent" $name)) }}
  {{ with $result.Value }}
    {{ $parsed := (. | transform.Unmarshal).data.last_month }}
    {{ $pypiDownloads = int $parsed }}
  {{ end }}
  {{ with $result.Err }}{{ $errors = $errors | append (printf "pypi-downloads: %s" .) }}{{ end }}
{{ end }}

{{ $ghDownloads := 0 }}
{{ $ghDownloadLabel := "total" }}
{{ if and (not $showPypi) (not $jetbrainsId) }}
  {{ $rawType := split (or $p.type "") "," }}
  {{ if not (or (in $rawType "github-action") (in $rawType "pre-commit")) }}
    {{ $result = try (resources.GetRemote (printf "https://api.github.com/repos/%s/%s/releases?per_page=100" $org $repo) $ghOpts) }}
    {{ with $result.Value }}
      {{ range (. | transform.Unmarshal) }}
        {{ range .assets }}
          {{ $ghDownloads = add $ghDownloads (int .download_count) }}
        {{ end }}
      {{ end }}
    {{ end }}
    {{ with $result.Err }}{{ $errors = $errors | append (printf "gh-releases: %s" .) }}{{ end }}
  {{ end }}
  {{ if eq $ghDownloads 0 }}
    {{ $result = try (resources.GetRemote (printf "https://api.github.com/repos/%s/%s/traffic/clones" $org $repo) $ghOpts) }}
    {{ with $result.Value }}
      {{ $ghDownloads = int (. | transform.Unmarshal).count }}
      {{ $ghDownloadLabel = "clones/14d" }}
    {{ end }}
    {{ with $result.Err }}{{ $errors = $errors | append (printf "gh-clones: %s" .) }}{{ end }}
  {{ end }}
{{ end }}

{{ $jbDownloads := 0 }}
{{ $jbVersion := "" }}
{{ $jbReleaseUnix := 0 }}
{{ if $jetbrainsId }}
  {{ $result = try (resources.GetRemote (printf "https://plugins.jetbrains.com/api/plugins/%s" $jetbrainsId)) }}
  {{ with $result.Value }}
    {{ $jbDownloads = int (. | transform.Unmarshal).downloads }}
  {{ end }}
  {{ with $result.Err }}{{ $errors = $errors | append (printf "jb-downloads: %s" .) }}{{ end }}
  {{ $result = try (resources.GetRemote (printf "https://plugins.jetbrains.com/api/plugins/%s/updates?channel=&size=1" $jetbrainsId)) }}
  {{ with $result.Value }}
    {{ $updates := . | transform.Unmarshal }}
    {{ with index $updates 0 }}
      {{ $jbVersion = .version }}
      {{ $jbReleaseUnix = div (int .cdate) 1000 }}
    {{ end }}
  {{ end }}
  {{ with $result.Err }}{{ $errors = $errors | append (printf "jb-version: %s" .) }}{{ end }}
{{ end }}

{{ $stars := 0 }}
{{ with $repoData.stargazers_count }}{{ $stars = int . }}{{ end }}
{{ $openTotal := 0 }}
{{ with $repoData.open_issues_count }}{{ $openTotal = int . }}{{ end }}
{{ $openPRs := 0 }}
{{ $result = try (resources.GetRemote (printf "https://api.github.com/repos/%s/%s/pulls?state=open&per_page=100" $org $repo) $ghOpts) }}
{{ with $result.Value }}{{ $openPRs = len (. | transform.Unmarshal) }}{{ end }}
{{ with $result.Err }}{{ $errors = $errors | append (printf "gh-pulls: %s" .) }}{{ end }}
{{ $openIssues := sub $openTotal $openPRs }}
{{ $logParts := slice (printf "stars=%d" $stars) (printf "issues=%d prs=%d" $openIssues $openPRs) (printf "last-commit=%s" (or $lastCommitDate "?")) }}
{{ if $showPypi }}
  {{ $logParts = $logParts | append (printf "pypi-version=%s" (or $pypiVersion "?")) (printf "pypi-downloads=%d" $pypiDownloads) }}
{{ else if $jetbrainsId }}
  {{ $logParts = $logParts | append (printf "jb-version=%s" (or $jbVersion "?")) (printf "jb-downloads=%d" $jbDownloads) }}
{{ else }}
  {{ $logParts = $logParts | append (printf "gh-downloads=%d(%s)" $ghDownloads $ghDownloadLabel) }}
{{ end }}
{{ with $releaseData.tag_name }}{{ $logParts = $logParts | append (printf "release=%s" .) }}{{ end }}
{{ if $errors }}
  {{ warnf "project %s/%s: %s | errors: %s" $org $repo (delimit $logParts " ") (delimit $errors "; ") }}
{{ else }}
  {{ warnf "project %s/%s: %s" $org $repo (delimit $logParts " ") }}
{{ end }}

{{ $nowUnix := now.Unix }}

{{ $type := "other" }}
{{ if $p.monorepo }}{{ $type = "monorepo" }}
{{ else if $jetbrainsId }}{{ $type = "jetbrains" }}
{{ else if $showPypi }}{{ $type = "python" }}
{{ end }}
{{ with $p.type }}{{ $type = . }}{{ end }}

{{ $typeIcons := dict "python" "fab fa-python" "rust" "fab fa-rust" "jetbrains" "fas fa-plug" "monorepo" "fas fa-layer-group" "pre-commit" "fab fa-git-alt" "github-action" "fas fa-bolt" "other" "fab fa-github" }}
{{ $typeLabels := dict "python" "Python" "rust" "Rust" "jetbrains" "JetBrains plugin" "monorepo" "Monorepo" "pre-commit" "Pre-commit hook" "github-action" "GitHub Action" "other" "Repository" }}

{{ $types := split $type "," }}

<tr{{ with $p.role }} class="{{ . }}"{{ end }}>
  <td class="row-num"></td>
  <td>
    {{- $tipText := "" -}}
    {{- with $p.monorepo }}{{ $tipText = . }}{{ else }}{{ $labels := slice }}{{ range $types }}{{ $labels = $labels | append (index $typeLabels (trim . " ")) }}{{ end }}{{ $tipText = delimit $labels " + " }}{{ end -}}
    {{- range $types -}}<span class="pkg-type has-tip"><i class="{{ index $typeIcons (trim . " ") }}"></i><span class="tip">{{ $tipText }}</span></span>{{- end -}}
    {{- if ne $repo $name -}}
      <a href="https://github.com/{{ $org }}/{{ $repo }}/tree/{{ $defaultBranch }}/{{ $name }}">{{ $label }}</a>
    {{- else -}}
      <a href="https://github.com/{{ $org }}/{{ $repo }}">{{ $label }}</a>
    {{- end -}}
  </td>
  {{- range $cols -}}
    {{- $col := trim . " " -}}
    {{- if eq $col "version" -}}
  <td class="col-data">
      {{- if $showPypi -}}
        {{- if $pypiVersion -}}
          <a href="https://pypi.org/project/{{ $name }}"><span class="badge badge-blue">{{ $pypiVersion }}</span></a>
        {{- end -}}
      {{- else if $jetbrainsId -}}
        {{- if $jbVersion -}}
          <a href="https://plugins.jetbrains.com/plugin/{{ $jetbrainsId }}-{{ $jetbrainsSlug }}/versions"><span class="badge badge-blue">{{ $jbVersion }}</span></a>
        {{- end -}}
      {{- else if not $noRelease -}}
        {{- with $releaseData.tag_name -}}
          <a href="https://github.com/{{ $org }}/{{ $repo }}/releases"><span class="badge badge-blue">{{ strings.TrimPrefix "v" . }}</span></a>
        {{- end -}}
      {{- end -}}
  </td>
    {{- else if eq $col "downloads" -}}
      {{- if $noRelease -}}
  <td class="col-data"></td>
      {{- else -}}
      {{- $downloads := 0 -}}
      {{- $sortValue := 0 -}}
      {{- if $showPypi -}}
        {{- $downloads = $pypiDownloads -}}
        {{- $sortValue = div $pypiDownloads 30 -}}
      {{- else if $jetbrainsId -}}
        {{- $downloads = $jbDownloads -}}
      {{- else if gt $ghDownloads 0 -}}
        {{- $downloads = $ghDownloads -}}
        {{- if eq $ghDownloadLabel "clones/14d" -}}
          {{- $sortValue = div $ghDownloads 14 -}}
        {{- end -}}
      {{- end -}}
      {{- $formatted := replace (lang.FormatNumber 0 $downloads) "," "_" -}}
  <td class="dl-cell col-data" data-value="{{ $sortValue }}">
      {{- if $showPypi -}}
        <a href="https://pepy.tech/projects/{{ $name }}"><span class="badge badge-green">{{ $formatted }}/mo</span></a>
      {{- else if $jetbrainsId -}}
        <a href="https://plugins.jetbrains.com/plugin/{{ $jetbrainsId }}-{{ $jetbrainsSlug }}"><span class="badge badge-green">{{ $formatted }} total</span></a>
      {{- else if gt $ghDownloads 0 -}}
        <a href="https://github.com/{{ $org }}/{{ $repo }}"><span class="badge badge-green">{{ $formatted }} {{ $ghDownloadLabel }}</span></a>
      {{- end -}}
  </td>
      {{- end -}}
    {{- else if eq $col "release" -}}
      {{- $sortVal := 0 -}}
      {{- $releaseDate := "" -}}
      {{- $releaseLink := "" -}}
      {{- if not $noRelease -}}
        {{- if and $showPypi $pypiReleaseDate -}}
          {{- $releaseDate = $pypiReleaseDate -}}
          {{- $releaseLink = printf "https://pypi.org/project/%s/#history" $name -}}
          {{- $sortVal = (time $releaseDate).Unix -}}
        {{- else if and $jetbrainsId (gt $jbReleaseUnix 0) -}}
          {{- $sortVal = $jbReleaseUnix -}}
          {{- $releaseLink = printf "https://plugins.jetbrains.com/plugin/%s-%s/versions" $jetbrainsId $jetbrainsSlug -}}
        {{- else -}}
          {{- with $releaseData.published_at }}{{ $releaseDate = . }}{{ end -}}
          {{- $releaseLink = printf "https://github.com/%s/%s/releases" $org $repo -}}
          {{- with $releaseDate }}{{ $sortVal = (time .).Unix }}{{ end -}}
        {{- end -}}
      {{- end -}}
      {{- $ago := dict "label" "" "color" "gray" -}}
      {{- if gt $sortVal 0 -}}
        {{- $ago = partial "time-ago.html" (dict "seconds" (sub $nowUnix $sortVal)) -}}
      {{- end -}}
  <td class="col-data" data-value="{{ $sortVal }}">
      {{- if $ago.label -}}
        {{- $isoDate := (time (int $sortVal)).Format "2006-01-02T15:04:05Z" -}}
        <a href="{{ $releaseLink }}"><span class="badge badge-{{ $ago.color }} has-tip">{{ $ago.label }}<span class="tip">{{ $isoDate }}</span></span></a>
      {{- end -}}
  </td>
    {{- else if eq $col "last-commit" -}}
      {{- $sortVal := 0 -}}
      {{- if $lastCommitDate }}{{ $sortVal = (time $lastCommitDate).Unix }}{{ end -}}
      {{- $ago := dict "label" "" "color" "gray" -}}
      {{- if gt $sortVal 0 -}}
        {{- $ago = partial "time-ago.html" (dict "seconds" (sub $nowUnix $sortVal)) -}}
      {{- end -}}
  <td class="col-data" data-value="{{ $sortVal }}">
        {{- if $lastCommitDate -}}
        <a href="https://github.com/{{ $org }}/{{ $repo }}/commits"><span class="badge badge-{{ $ago.color }} has-tip">{{ $ago.label }}<span class="tip">{{ $lastCommitDate }}</span></span></a>
        {{- end -}}
  </td>
    {{- else if eq $col "issues" -}}
  <td class="col-data" data-value="{{ $openTotal }}">
        <span class="badge badge-gray"><a href="https://github.com/{{ $org }}/{{ $repo }}/issues">{{ $openIssues }}</a>/<a href="https://github.com/{{ $org }}/{{ $repo }}/pulls">{{ $openPRs }}</a></span>
  </td>
    {{- else if eq $col "stars" -}}
      {{- $formatted := replace (lang.FormatNumber 0 $stars) "," "_" -}}
  <td class="col-data" data-value="{{ $stars }}">
      {{- if gt $stars 0 -}}
        <span class="badge badge-yellow"><a href="https://github.com/{{ $org }}/{{ $repo }}/stargazers">{{ $formatted }}</a> <a href="https://www.star-history.com/#{{ $org }}/{{ $repo }}">â˜…</a></span>
      {{- end -}}
  </td>
    {{- else if eq $col "ci" -}}
  <td class="col-ci">
      {{- with $p.ci -}}
        {{- $workflows := split . "," -}}
        {{- range $workflows -}}
          {{- $workflow := trim . " " -}}
          {{- $file := $workflow -}}
          {{- if not (or (strings.HasSuffix $workflow ".yaml") (strings.HasSuffix $workflow ".yml")) }}{{ $file = printf "%s.yaml" $workflow }}{{ end -}}
          <a href="https://github.com/{{ $org }}/{{ $repo }}/actions/workflows/{{ $file }}"><img src="https://github.com/{{ $org }}/{{ $repo }}/actions/workflows/{{ $file }}/badge.svg" alt="{{ $workflow }}"></a>
        {{- end -}}
      {{- end -}}
  </td>
    {{- end -}}
  {{- end -}}
</tr>
