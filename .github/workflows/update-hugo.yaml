name: Update Hugo Version
on:
  schedule:
    - cron: "0 0 * * 1"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  workflows: write

jobs:
  update-hugo:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Get current Hugo version
        id: current
        run: |
          CURRENT_VERSION=$(grep -oP 'HUGO_VERSION: "\K[^"]+' .github/workflows/build.yaml)
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      - name: Get latest Hugo version
        id: latest
        run: |
          LATEST_VERSION=$(curl -s https://api.github.com/repos/gohugoio/hugo/releases/latest | jq -r '.tag_name' | sed 's/^v//')
          echo "version=$LATEST_VERSION" >> $GITHUB_OUTPUT

      - name: Check if update needed
        id: check
        run: |
          if [ "${{ steps.current.outputs.version }}" != "${{ steps.latest.outputs.version }}" ]; then
            echo "needed=true" >> $GITHUB_OUTPUT
          else
            echo "needed=false" >> $GITHUB_OUTPUT
          fi

      - name: Update Hugo version
        if: steps.check.outputs.needed == 'true'
        run: |
          sed -i 's/HUGO_VERSION: "[^"]*"/HUGO_VERSION: "${{ steps.latest.outputs.version }}"/' .github/workflows/build.yaml

      - name: Create Pull Request
        if: steps.check.outputs.needed == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            Bump Hugo from ${{ steps.current.outputs.version }} to ${{ steps.latest.outputs.version }}

            Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
          title: "Bump Hugo from ${{ steps.current.outputs.version }} to ${{ steps.latest.outputs.version }}"
          body: |
            ## Update Hugo Version

            This PR updates Hugo from `${{ steps.current.outputs.version }}` to `${{ steps.latest.outputs.version }}`.

            ### Changes
            - Updated HUGO_VERSION in `.github/workflows/build.yaml`

            ### Release Notes
            https://github.com/gohugoio/hugo/releases/tag/v${{ steps.latest.outputs.version }}

            ---
            ðŸ¤– Generated by automated Hugo version update workflow
          branch: update-hugo-${{ steps.latest.outputs.version }}
          delete-branch: true
          labels: |
            dependencies
            automated
