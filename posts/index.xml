<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Posts on Bernát Gábor - Engineering &amp; Open Source</title><link>https://bernat.tech/posts/</link><description>Bernát Gábor's personal website</description><generator>Hugo 0.155.3</generator><language>en</language><lastBuildDate>Sat, 16 May 2020 14:15:00 +0000</lastBuildDate><atom:link href="https://bernat.tech/posts/index.xml" rel="self" type="application/rss+xml"/><item><title>Version numbers: how to use them?</title><link>https://bernat.tech/posts/version-numbers/</link><pubDate>Sat, 16 May 2020 14:15:00 +0000</pubDate><author>Bernát Gábor</author><guid>https://bernat.tech/posts/version-numbers/</guid><description>&lt;p&gt;The &lt;a href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself" class="external-link" target="_blank" rel="noopener"&gt;DRY principle&lt;/a&gt; (an acronym for don&amp;rsquo;t repeat yourself)
encourages software engineers to abstract code into a separate component and reuse it rather than write it over and over
again. If this happens across the system, the best practice is to put it inside a package that lives on its own (a
library) and then pull it in from the applications when required.&lt;/p&gt;
&lt;p&gt;As most of us can&amp;rsquo;t think of every feature that the library might offer or what bugs it might contain, these packages
tend to evolve. Therefore, we need some mechanism to encode these evolutions of the library, and most commonly, this is
a version number.&lt;/p&gt;
&lt;p&gt;Version numbers and their meaning will come up both as a producer or as a consumer of libraries:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;as a producer of libraries, you&amp;rsquo;ll have to decide what versioning system to use,&lt;/li&gt;
&lt;li&gt;as a consumer, you&amp;rsquo;ll have to express what versions of a given library your application/library is compatible.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;What is a great version number, you might ask? If you do a quick search around, you&amp;rsquo;ll find there are
&lt;a href="https://en.wikipedia.org/wiki/Software_versioning" class="external-link" target="_blank" rel="noopener"&gt;multiple schools of thought here&lt;/a&gt;:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://semver.org/" class="external-link" target="_blank" rel="noopener"&gt;semantic versioning&lt;/a&gt; (of which &lt;a href="https://0ver.org/" class="external-link" target="_blank" rel="noopener"&gt;ZeroVer&lt;/a&gt; is an ever-popular subset)&lt;/li&gt;
&lt;li&gt;&lt;a href="https://calver.org/" class="external-link" target="_blank" rel="noopener"&gt;calendar versioning&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;For those who read my articles, you&amp;rsquo;ll know I like to sprinkle my otherwise technically dry posts with some lovely and
cute animal photos to give you at least some moments of relief while you&amp;rsquo;re going through it. In this one, I&amp;rsquo;ll use
pictures from my Yorkshire Terrier puppy, Silky. Without further ado (#ToT!!!)&lt;/p&gt;
&lt;figure&gt;
&lt;img src="https://bernat.tech/posts/version-numbers/silky_tot.webp" alt="Silky the Yorkshire Terrier puppy"
srcset="https://bernat.tech/posts/version-numbers/silky_tot_hu_6e45e4b1848882c8.webp 500w" sizes="(min-width: 35em) 1200px, 100vw"
width="700" height="417"
loading="lazy" decoding="async"&gt;
&lt;/figure&gt;
&lt;h2 id="semantic-and-zerover"&gt;
Semantic and ZeroVer
&lt;a class="heading-link" href="#semantic-and-zerover"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h2&gt;
&lt;p&gt;So, which should you use? Historically, the go-to answer has been semantic versioning. This is defined as a three-number
string (separated with a period) in the format of &lt;code&gt;MAJOR.MINOR.PATCH&lt;/code&gt;. Usually, it starts with &lt;code&gt;0.1.0&lt;/code&gt;. Then depending
on the type of change you make to the library, you increment one of these and set subsequent numbers to zero:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;MAJOR&lt;/code&gt; version if you make backward-incompatible changes,&lt;/li&gt;
&lt;li&gt;&lt;code&gt;MINOR&lt;/code&gt; version if you add a new feature,&lt;/li&gt;
&lt;li&gt;&lt;code&gt;PATCH&lt;/code&gt; version if you fix bugs.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Version two of semantic versioning introduced additional labels to indicate pre-releases and build metadata; these are
appended after a hyphen at the end, for example, &lt;code&gt;1.0.0-beta+exp.sha.5114f8&lt;/code&gt;. For the point of this blog post, these are
not important. ZeroVer (a joke versioning system - released on April 1st) is similar to this with the sole difference
that &lt;code&gt;MAJOR&lt;/code&gt; is always &lt;code&gt;0&lt;/code&gt; and incompatible changes may be introduced at any point. It intended to make fun of people
who use &amp;ldquo;semantic versioning&amp;rdquo; but never make a &lt;code&gt;1.0&lt;/code&gt; release, thus defeating the purpose of semver.&lt;/p&gt;
&lt;p&gt;The version number in this context is used as a contract between the library developer and the systems pulling it in
about how freely they can upgrade. For example, if you wrote your web server against
&lt;a href="https://pypi.org/project/Django/#history" class="external-link" target="_blank" rel="noopener"&gt;Django 3&lt;/a&gt;, you should be good to go with all Django 3 releases that are at
least as new as your current one. This allows you to express your Django dependency in the format of
&lt;code&gt;Django &amp;gt;= 3.0.2, &amp;lt;4&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;By using this format whenever you rebuild your application, you&amp;rsquo;ll automatically pull in any new feature/bugfix/security
releases of &lt;code&gt;Django&lt;/code&gt;, enabling you to use the latest and best version that is still guaranteed to work with your
project. This is great because:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;you enable automatic, compatible security fixes,&lt;/li&gt;
&lt;li&gt;it automatically pulls in bug fixes on the library side,&lt;/li&gt;
&lt;li&gt;your application will keep building and working in the future as it did today because the significant version pin
protects you from pulling in versions whose API would not match.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Does this uphold in practice? For me, &lt;a href="https://hynek.me/" class="external-link" target="_blank" rel="noopener"&gt;Hynek Schlawack&lt;/a&gt; pointed out first that it does not.
Initially, in some &lt;a href="https://twitter.com/llanga/status/1253962015846121472" class="external-link" target="_blank" rel="noopener"&gt;tweets&lt;/a&gt;, and then in more detail within a
talk held at a &lt;a href="https://remote.python.pizza/" class="external-link" target="_blank" rel="noopener"&gt;Remote Python Pizza&lt;/a&gt; conference. Looking back at my experience with this,
I tend to agree.&lt;/p&gt;
&lt;figure&gt;
&lt;img src="https://bernat.tech/posts/version-numbers/silky_sit.webp" alt="Silky sitting"
srcset="https://bernat.tech/posts/version-numbers/silky_sit_hu_cb6cdaf5b409b8ed.webp 500w" sizes="(min-width: 35em) 1200px, 100vw"
width="700" height="696"
loading="lazy" decoding="async"&gt;
&lt;/figure&gt;
&lt;h2 id="whats-the-problem-with-semantic-versioning"&gt;
What&amp;rsquo;s the problem with semantic versioning?
&lt;a class="heading-link" href="#whats-the-problem-with-semantic-versioning"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h2&gt;
&lt;p&gt;On paper, semantic versioning seems to be addressing all we need to encode the evolution and state of our library. I
think the issue is not with the semantic versioning standard itself; indeed, people would like to follow it. However,
&lt;strong&gt;most library maintainers/developers out there don&amp;rsquo;t have enough resources to follow semantic versioning&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;Maintaining a library is very time-consuming. I can attest to that, as I have maintained two myself for a few years now:
tox (3) and virtualenv (2). My experience is within the Python ecosystem, but I can imagine other languages are similar.
Most libraries have just a few active maintainers available, for example:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;tox has 2,&lt;/li&gt;
&lt;li&gt;virtualenv 1,&lt;/li&gt;
&lt;li&gt;pytest around 4,&lt;/li&gt;
&lt;li&gt;pip around 4,&lt;/li&gt;
&lt;li&gt;python-dateutil 1.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;And these are very high-profile libraries. To make things even worse, some of their maintainers overlap (i.e., the same
person is the maintainer of multiple projects). And to complicate matters even further, for most maintainers this is not
a full-time job, but something on the side, part of their free time.&lt;/p&gt;
&lt;p&gt;Given the scarce human resources to maintain a library, in practice, there&amp;rsquo;s a single supported version for any library
at any given point in time: &lt;strong&gt;the latest one&lt;/strong&gt;. Any version before that (be that major, minor, patch) is in essence
abandoned:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;if you want security updates, you need to move to the latest version,&lt;/li&gt;
&lt;li&gt;if you wish to a bugfix you need to move to the newest version,&lt;/li&gt;
&lt;li&gt;if you want a new feature, it is only going to be available in the latest version.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;You get the idea. Unless you&amp;rsquo;re thrilled with your current version, to pull in any change you will need to move to the
last released version (be that security improvement, bugfix, or feature). Otherwise, you&amp;rsquo;ll not get it.&lt;/p&gt;
&lt;figure&gt;
&lt;img src="https://bernat.tech/posts/version-numbers/silky_wind.webp" alt="Silky in the wind"
srcset="https://bernat.tech/posts/version-numbers/silky_wind_hu_43cf71b72b7fc0f.webp 500w" sizes="(min-width: 35em) 1200px, 100vw"
width="700" height="557"
loading="lazy" decoding="async"&gt;
&lt;/figure&gt;
&lt;h3 id="will-a-major-version-bump-always-break-you"&gt;
Will a major version bump always break you?
&lt;a class="heading-link" href="#will-a-major-version-bump-always-break-you"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h3&gt;
&lt;p&gt;At this point, you might think, &amp;ldquo;OK, so I need to pin down to the major version&amp;rdquo;. As in, you need to specify the
dependency in the form of &lt;code&gt;tox&amp;gt;=3, &amp;lt;4&lt;/code&gt;. However, semantic versioning is very strict about changing the API. Any
backward-incompatible change (no matter how small it is) must be followed with a major number bump.&lt;/p&gt;
&lt;p&gt;A major version bump &lt;strong&gt;must&lt;/strong&gt; happen not only when you rewrite an entire library with its complete API, but also when
you&amp;rsquo;re just renaming a single rarely used function (which some may erroneously view as a minor change). Or even worse,
it&amp;rsquo;s not always clear what&amp;rsquo;s part of the public API and what&amp;rsquo;s not.&lt;/p&gt;
&lt;p&gt;You have a library with some incidental, undocumented, and unspecified behavior that you consider to be obviously not
part of the public interface. You change it to solve what seems like a bug to you, and make a patch release, only to
find that you have angry hordes at the gate who, thanks to &lt;a href="https://www.hyrumslaw.com/" class="external-link" target="_blank" rel="noopener"&gt;Hyrum&amp;rsquo;s Law&lt;/a&gt;, depend on the old
behavior.&lt;/p&gt;
&lt;figure&gt;&lt;img src="https://imgs.xkcd.com/comics/workflow.png" alt="XKCD workflow comic"
loading="lazy" decoding="async"&gt;
&lt;/figure&gt;
&lt;p&gt;While every maintainer would like to believe they&amp;rsquo;ve thought of every use case up-front and created the best API for
everything, in practice, hindsight is our best teacher. As we run into more use cases, issues, and users, we get smarter
and work out what would be a better interface for that library, and what confuses the users the most.&lt;/p&gt;
&lt;p&gt;Therefore there will be a lot of moments when, as a maintainer, you would like to change something. Doing a major bump
change every time will make your project quickly reach double-digit major versions, at which point users tend to
consider your project too unstable to be trusted. Often these major number changes only affect a low percentage of your
users (usually those using that one feature you changed in an incompatible fashion).&lt;/p&gt;
&lt;p&gt;With a major version pinning the majority of other users are effectively opting out of bug fixes and security updates
(which should be critical), to defend against a change that in practice will rarely impact them. Sure, they can move on
to the next version by pinning again via something like &lt;code&gt;tox&amp;gt;=4, &amp;lt;5&lt;/code&gt;. However, this involves manual intervention on
their code, and you might not have the time to do this for every one of your projects.&lt;/p&gt;
&lt;p&gt;In my experience, this happens a lot. A lot more at least than when a major version bump breaks you. And then there&amp;rsquo;s
another aspect version pinning will introduce: version conflicts.&lt;/p&gt;
&lt;figure&gt;
&lt;img src="https://bernat.tech/posts/version-numbers/silky_tot_2.webp" alt="Silky the puppy running"
srcset="https://bernat.tech/posts/version-numbers/silky_tot_2_hu_1bba1ed33e0c5f29.webp 500w" sizes="(min-width: 35em) 1200px, 100vw"
width="700" height="648"
loading="lazy" decoding="async"&gt;
&lt;/figure&gt;
&lt;h3 id="version-conflicts"&gt;
Version conflicts
&lt;a class="heading-link" href="#version-conflicts"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h3&gt;
&lt;p&gt;An application or library will have a set of libraries it depends on directly. These are libraries you&amp;rsquo;re directly
importing within the application/library you&amp;rsquo;re maintaining, but then the libraries themselves may rely on other
libraries. This is known as a transitive dependency. Very soon, you&amp;rsquo;ll get to a point where two different components use
the same library, and both of them might express version constraints on it.&lt;/p&gt;
&lt;p&gt;For example, consider the case of &lt;a href="https://pypi.org/project/tenacity/#history" class="external-link" target="_blank" rel="noopener"&gt;tenacity&lt;/a&gt;: a general-purpose retrying
library. Imagine you were using this in your application, and being a religious follower of semantic versioning, you&amp;rsquo;ve
pinned it to the version that was out when you created the app in early 2018: 4.11. The constraint would specify version
4.11 or later, but less than the next major version 5.&lt;/p&gt;
&lt;p&gt;At the same time, you also connect to an HTTP service. This connection is handled by another library, and the maintainer
of that decided to also use tenacity to offer automatic retry functionality. They pinned it similarly following the
semantic versioning convention. Back in 2018, this caused no issues. But then August comes, and version 5.0 is released.&lt;/p&gt;
&lt;p&gt;The service and its library maintainers have a lot more time on their hands (perhaps because they are paid to do so), so
they quickly move to version 5.0. Or perhaps they want to use a feature from the new major version. Now they introduce
the pin greater than five but less than six on tenacity. Their public interface does not change at all at this point, so
they do not bump their major version. It&amp;rsquo;s just a patch release.&lt;/p&gt;
&lt;p&gt;Python can only have one version of a library installed at a given time. At this point, there is a version conflict.
You&amp;rsquo;re requesting a version between four and five, while the service library is requesting a version between five and
six. Both constraints cannot be satisfied.&lt;/p&gt;
&lt;p&gt;If you use a version of &lt;a href="https://pypi.org/project/pip" class="external-link" target="_blank" rel="noopener"&gt;pip&lt;/a&gt; older than 20.2 ­— the release in which it added a
dependency resolver — it will just install a version matching the first constraint it finds and ignore any subsequent
constraints. Versions of pip &lt;em&gt;after&lt;/em&gt; 20.2 would fail with an error indicating that the constraint cannot be satisfied.&lt;/p&gt;
&lt;p&gt;Either way, your application no longer works. The only way to make it work is to either pin the service library down to
the last working patch number, or upgrade your version pinning of tenacity. This is generating extra work for you with
minimal benefit. Often it might not be even possible to use two conflicting libraries until one of them relaxes their
requirements.&lt;/p&gt;
&lt;p&gt;And for those who might think this doesn&amp;rsquo;t happen often, let me say that tenacity released another major version a year
later in November 2019. Thus, the cycle starts all over again. In both cases, your code most likely did not need to
change at all, as just a small part of their public API changed.&lt;/p&gt;
&lt;p&gt;A mildly complex application will easily have close to (or possibly more than) 100 dependencies, so such issues in my
experience start to appear every few months. You need only 5-6 of such cases for every 100 libraries for this issue to
pop up every two months on your plate. And potentially for a multiple of your applications.&lt;/p&gt;
&lt;figure&gt;
&lt;img src="https://bernat.tech/posts/version-numbers/silky_yes.webp" alt="Silky looking up"
srcset="https://bernat.tech/posts/version-numbers/silky_yes_hu_36054eb81236b06.webp 500w" sizes="(min-width: 35em) 1200px, 100vw"
width="700" height="665"
loading="lazy" decoding="async"&gt;
&lt;/figure&gt;
&lt;h2 id="calendar-versioning"&gt;
Calendar Versioning
&lt;a class="heading-link" href="#calendar-versioning"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h2&gt;
&lt;p&gt;&lt;a href="https://en.wikipedia.org/wiki/Software_versioning#Date_of_release" class="external-link" target="_blank" rel="noopener"&gt;CalVer&lt;/a&gt;, which was
&lt;a href="https://sedimental.org/designing_a_version.html#calendar_versioning" class="external-link" target="_blank" rel="noopener"&gt;codified by Mahmoud Hashemi&lt;/a&gt;, suggests version
number to be in format of: &lt;code&gt;YEAR.MONTH.sequence&lt;/code&gt;. For example, &lt;code&gt;20.1&lt;/code&gt; indicates a release in 2020 January, while
&lt;code&gt;20.5.2&lt;/code&gt; indicates a release that occurred in 2020 May, while the 2 indicates this is the third release of the month.&lt;/p&gt;
&lt;p&gt;You can see it looks similar to semantic versioning and has the benefit that a later release qualifies as bigger than an
earlier one within the semantic versioning world (which mandates that a version number must grow monotonically). This
makes it easy to use in all places where semantic versioning can be used.&lt;/p&gt;
&lt;p&gt;The idea here is that if the only maintained version is the latest, then we might as well use the version number to
indicate the release date to signify just how old of a version you&amp;rsquo;re using. You also have the added benefit that you
can make calendar-based promises. For example, Ubuntu offers five years of support, therefore given version &lt;code&gt;20.04&lt;/code&gt; you
can quickly determine that it will be supported up to April 2025.&lt;/p&gt;
&lt;figure&gt;
&lt;img src="https://bernat.tech/posts/version-numbers/silky_jump.webp" alt="Silky jumping"
srcset="https://bernat.tech/posts/version-numbers/silky_jump_hu_fb582372e2c4a68f.webp 500w" sizes="(min-width: 35em) 1200px, 100vw"
width="700" height="734"
loading="lazy" decoding="async"&gt;
&lt;/figure&gt;
&lt;h2 id="a-better-way-to-handle-api-evolution"&gt;
A better way to handle API evolution?
&lt;a class="heading-link" href="#a-better-way-to-handle-api-evolution"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h2&gt;
&lt;p&gt;Semantic versioning uses the major version to defend against breaking changes, and at the same offers maintainers the
freedom to evolve the library without breaking users. Nevertheless, as we could see above in practice, this does not
seem to work that well, as it causes you not to pull in bug fixes/security updates while also introducing version
conflicts. Do we have a better tool at hand for this?&lt;/p&gt;
&lt;p&gt;Hynek suggests instead clear, time-window based deprecation policies, and as an optional sprinkle on top, warning
messages when using deprecated content. When you want to change a public-facing API: release the change under a new
interface, and in parallel, start emitting warning messages whenever someone invokes the old one. Maintain this state
for a migration period of a year, and communicate explicitly in the warning message the timeline for when users have to
migrate (calculate this by adding one year to your release date).&lt;/p&gt;
&lt;p&gt;This gives everyone a year to move to the new interface without breaking their system, and then the library may remove
the change and get rid of the old design chains forever. As an added benefit, only people using the old interface will
ever see the warning, as opposed to affecting everyone (as seen with the semantic versioning major version bump).&lt;/p&gt;
&lt;p&gt;One caveat for this to work is that one should stop upper-pinning dependencies. You should only specify the minimum
version you need to pull in newer versions freely if they exist. Lessons learned from version conflicts, though, might
already prompt you to do so. A major version breaks you a lot less often in practice than semantic versioning leads you
to believe.&lt;/p&gt;
&lt;p&gt;Donald Stufft has also taken on this subject in a blog post titled
&lt;a href="https://caremad.io/posts/2016/02/versioning-software/" class="external-link" target="_blank" rel="noopener"&gt;Versioning Software&lt;/a&gt;. I encourage you to read that too. Besides
the above points, he argues that by using semantic versioning, you&amp;rsquo;re able to communicate to the end-user the intended
impact of a new release.&lt;/p&gt;
&lt;p&gt;A patch version bump indicates no significant change is expected, and users should be able to upgrade quickly. A minor
or major version bump shows that the upgrade might introduce significant changes, and that users should set aside a
considerable amount of time when bumping such dependencies.&lt;/p&gt;
&lt;p&gt;I operate slightly differently in the sense that I don&amp;rsquo;t diff releases. Instead, I tend to &lt;strong&gt;upgrade without version
constraints&lt;/strong&gt;. If the CI fails, I don&amp;rsquo;t merge it; rather I investigate the failure when I have free time on my hands.
Lessons from the trenches suggest that &lt;strong&gt;the only way to ensure an upgrade of any magnitude does not break you is to
have a comprehensive test suite.&lt;/strong&gt; Ideally, your test framework can collect and report whenever and where your code is
calling deprecated functions (&lt;a href="https://docs.pytest.org/en/latest/warnings.html#warnings-capture" class="external-link" target="_blank" rel="noopener"&gt;for example pytest&lt;/a&gt;).&lt;/p&gt;
&lt;figure&gt;
&lt;img src="https://bernat.tech/posts/version-numbers/silky_wise.webp" alt="Silky looking wise"
srcset="https://bernat.tech/posts/version-numbers/silky_wise_hu_c068afdb0fef36bf.webp 500w" sizes="(min-width: 35em) 1200px, 100vw"
width="700" height="696"
loading="lazy" decoding="async"&gt;
&lt;/figure&gt;
&lt;h2 id="summary"&gt;
Summary
&lt;a class="heading-link" href="#summary"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h2&gt;
&lt;p&gt;Is semantic versioning irrevocably broken? Should it never be used? I don&amp;rsquo;t think so. It still makes a lot of sense
where there are ample resources to maintain multiple versions in parallel. A great example of this is Django. However,
it feels less practical for projects that have just a few maintainers.&lt;/p&gt;
&lt;p&gt;In this case, it often leads to opting people out of bug fixes and security updates. It also encourages version
conflicts in environments that can&amp;rsquo;t have multiple versions of the same library, as is the case with Python.
Furthermore, it makes it a lot harder for developers to learn from their mistakes and evolve the API to a better place.
Rotten old design decisions will pull down the library for years to come.&lt;/p&gt;
&lt;p&gt;A better solution at hand can be using CalVer and a time-window based warning system to evolve the API and remove old
interfaces. Does it solve all problems? Absolutely not.&lt;/p&gt;
&lt;p&gt;One thing it makes harder is library rewrites. For example, consider
&lt;a href="https://pypi.org/project/virtualenv/20.0.20/#history" class="external-link" target="_blank" rel="noopener"&gt;virtualenv&amp;rsquo;&lt;/a&gt;s recent rewrite. Version 20 introduced a completely
new API and changed some behaviours to new defaults. For such use cases in a CalVer world, you would likely need to
release the rewritten project under a new name, such as virtualenv2. Then again, such complete rewrites are extremely
rare (in the case of virtualenv, it involved twelve years passing).&lt;/p&gt;
&lt;p&gt;No version scheme will allow you to predict with any certainty how compatible your software will be with potential
future versions of your dependencies. The only reasonable choices are for libraries to choose minimum versions/excluded
versions only, never maximum versions. For applications, do the same thing, but also add in a lock file of known, good
versions with exact pins (this is the fundamental difference between
&lt;a href="https://packaging.python.org/en/latest/discussions/install-requires-vs-requirements/" class="external-link" target="_blank" rel="noopener"&gt;install_requires and requirements.txt&lt;/a&gt;).&lt;/p&gt;
&lt;p&gt;If you got this far you might want to also check the reasoning of
&lt;a href="https://snarky.ca/why-i-dont-like-semver/" class="external-link" target="_blank" rel="noopener"&gt;Brett Cannon - Why I don&amp;rsquo;t like SemVer anymore&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;I want to thank &lt;a href="https://twitter.com/codewithanthony" class="external-link" target="_blank" rel="noopener"&gt;Anthony Sottile&lt;/a&gt;, &lt;a href="https://twitter.com/pganssle" class="external-link" target="_blank" rel="noopener"&gt;Paul Ganssle&lt;/a&gt;,
&lt;a href="https://twitter.com/hynek" class="external-link" target="_blank" rel="noopener"&gt;Hynek Schlawack&lt;/a&gt;, and &lt;a href="https://twitter.com/LisaMcString" class="external-link" target="_blank" rel="noopener"&gt;Lisa McCord&lt;/a&gt; for reviewing this
article in its draft versions and suggesting changes that made it a thousand times better.&lt;/p&gt;
&lt;figure&gt;
&lt;img src="https://bernat.tech/posts/version-numbers/silky_run_happy.webp" alt="Silky running happily"
srcset="https://bernat.tech/posts/version-numbers/silky_run_happy_hu_f7d7be02b1684d4c.webp 500w" sizes="(min-width: 35em) 1200px, 100vw"
width="700" height="525"
loading="lazy" decoding="async"&gt;
&lt;/figure&gt;</description><category>python</category><category>version</category><category>semver</category><category>calver</category><category>0ver</category></item><item><title>Python packaging - Growing Pains</title><link>https://bernat.tech/posts/growing-pain/</link><pubDate>Thu, 07 Feb 2019 13:41:03 +0000</pubDate><author>Bernát Gábor</author><guid>https://bernat.tech/posts/growing-pain/</guid><description>&lt;p&gt;In my previous two posts, I&amp;rsquo;ve gone over [what package types python has](https://bernat.tech/posts/pep-517-and-python-packaging/),
and [how the package building works](https://bernat.tech/posts/pep-517-518/), especially with the introduction of the PEP-517/518.
Although the changes were primarily to make things more robust, we did run into a few issues while implementing it and
releasing it. This post will go over a few, hopefully serving as lessons learned for all of us and presenting some
interesting problems to solve in the future.&lt;/p&gt;
&lt;p&gt;Looking at the changes of PEP-517 and PEP-518, one can identify those build backends (aka setuptools, flit) had very
little to do, only also to expose their functionality via a Python module. Most heavy work is on the build frontend,
which now needs to generate the isolated Python and then invoke the build backends in a new way. When we&amp;rsquo;re talking
about build frontends nowadays, our options are mostly pip or poetry (and tox for developers).&lt;/p&gt;
&lt;p&gt;These projects are maintained by the community, by a handful of active developers, in their free time. They are not
getting paid for it, and they need to be careful to consider the myriad ways these tools are used. Considering this,
it&amp;rsquo;s not much of a surprise it took almost two years after the PEP acceptance to come out with a first implementation.
Planning, testing, and implementation have been going on for over a year in the background.&lt;/p&gt;
&lt;p&gt;Against all the preparations, though, inevitably, the first release did break a few packages, mostly where people
performed some operations that caught the maintainers by surprise. Let&amp;rsquo;s try to understand a few of these examples and
how did they get addressed.&lt;/p&gt;
&lt;figure&gt;
&lt;img src="https://bernat.tech/posts/growing-pain/stand_pug.webp" alt="Standing pug"
srcset="https://bernat.tech/posts/growing-pain/stand_pug_hu_6c52b91bbec06c42.webp 500w" sizes="(min-width: 35em) 1200px, 100vw"
width="700" height="467"
loading="lazy" decoding="async"&gt;
&lt;/figure&gt;
&lt;h2 id="pep-518"&gt;
PEP-518
&lt;a class="heading-link" href="#pep-518"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h2&gt;
&lt;p&gt;The PEP introduces the &lt;a href="https://github.com/toml-lang/toml" class="external-link" target="_blank" rel="noopener"&gt;TOML file format.&lt;/a&gt; A format specially created to be easy to
read/write configurations. While packaging configuration is exposed under the &lt;code&gt;build-system&lt;/code&gt; section, other tools are
free to put their configuration under the &lt;code&gt;tool:name&lt;/code&gt; section if they own the PyPi namespace for the name. Various tools
started to take advantage of this right away (such as &lt;a href="https://pypi.org/project/towncrier/" class="external-link" target="_blank" rel="noopener"&gt;towncrier&lt;/a&gt;,
&lt;a href="https://pypi.org/project/black/" class="external-link" target="_blank" rel="noopener"&gt;black&lt;/a&gt;, etc.).&lt;/p&gt;
&lt;p&gt;When &lt;a href="https://pip.pypa.io/en/stable/news/#id61" class="external-link" target="_blank" rel="noopener"&gt;pip 18.0 (released 2018 July 22&lt;/a&gt;) added support for PEP-518 packages
using the &lt;code&gt;pyproject.toml&lt;/code&gt; initially broke, as the PEP-518 mandated that all packages having the &lt;code&gt;pyproject.toml&lt;/code&gt;
&lt;strong&gt;must&lt;/strong&gt; specify the &lt;code&gt;build-backend&lt;/code&gt; section. But packages beforehand used it only as a configuration file for these
other projects since they didn&amp;rsquo;t specify it pre-emptively; when pip ran into these files, it just raised errors
complaining of invalid &lt;code&gt;pyproject.toml&lt;/code&gt; files.&lt;/p&gt;
&lt;h2 id="pep-517"&gt;
PEP-517
&lt;a class="heading-link" href="#pep-517"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h2&gt;
&lt;h3 id="the-pip-wheel-cache-issue"&gt;
The pip wheel cache issue.
&lt;a class="heading-link" href="#the-pip-wheel-cache-issue"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h3&gt;
&lt;p&gt;The way pip installs in a PEP-517 world is first to generate a wheel and then extract that. To be in PEP-517 world one
&lt;strong&gt;must&lt;/strong&gt; specify the &lt;code&gt;build-backend&lt;/code&gt; key. Otherwise, all frontends per specification need to fallback to using the
&lt;code&gt;setup.py&lt;/code&gt; commands.&lt;/p&gt;
&lt;p&gt;When pip builds wheels, it does it by default via a caching system. This is a speed-up mechanism so that if multiple
virtual environments need the same wheel, we don&amp;rsquo;t keep rebuilding it but instead re-use it. The PEP-517 wheel build
operation also takes advantage of this.&lt;/p&gt;
&lt;p&gt;This becomes troublesome, though, when you disable the cache. Now there&amp;rsquo;s no target folder where to build the wheel. So
the build itself fails &lt;a href="https://github.com/pypa/pip/issues/6158" class="external-link" target="_blank" rel="noopener"&gt;see the attached issue.&lt;/a&gt; The problem manifested early,
though, but en masse, as most CI systems run with this option turned on. Just a day later pip 19.0.1 fixed this.&lt;/p&gt;
&lt;h3 id="pyprojecttoml-not-being-included-into-setuptools"&gt;
&lt;code&gt;pyproject.toml&lt;/code&gt; not being included into setuptools
&lt;a class="heading-link" href="#pyprojecttoml-not-being-included-into-setuptools"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h3&gt;
&lt;p&gt;It turns out there&amp;rsquo;s more work on the build backend than just expose their API as described in PEP-517. The backend also
needs to ensure that &lt;code&gt;pyproject.toml&lt;/code&gt; is attached to the built source package. Otherwise, the build backend on the user
machine will not be able to use it. &lt;a href="https://github.com/pypa/setuptools/pull/1650" class="external-link" target="_blank" rel="noopener"&gt;setuptools 1650&lt;/a&gt; will fix this for
setuptools. One can include &lt;code&gt;pyproject.toml&lt;/code&gt; by specifying it inside &lt;code&gt;MANIFEST.in&lt;/code&gt; on earlier versions.&lt;/p&gt;
&lt;figure&gt;
&lt;img src="https://bernat.tech/posts/growing-pain/chair_pug.webp" alt="Pug on chair"
srcset="https://bernat.tech/posts/growing-pain/chair_pug_hu_65bddb8c16d434c9.webp 500w" sizes="(min-width: 35em) 1200px, 100vw"
width="700" height="469"
loading="lazy" decoding="async"&gt;
&lt;/figure&gt;
&lt;h3 id="importing-the-built-package-from-within-setuppy"&gt;
Importing the built package from within &lt;code&gt;setup.py&lt;/code&gt;
&lt;a class="heading-link" href="#importing-the-built-package-from-within-setuppy"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h3&gt;
&lt;p&gt;Another unexpected issue was when a package was importing from within &lt;code&gt;setup.py&lt;/code&gt;. The version of the package by
convention is exposed both as metadata for the package (in case of setuptools inside the &lt;code&gt;setup.py&lt;/code&gt; as the &lt;code&gt;version&lt;/code&gt;
argument to the &lt;code&gt;setup&lt;/code&gt; function), but also under the &lt;code&gt;__version__&lt;/code&gt; variable at the root of the package. One could
specify the content of the variable in both places, but then it becomes troublesome to keep it in sync.&lt;/p&gt;
&lt;p&gt;As a workaround, many packages started putting it inside a &lt;code&gt;version.py&lt;/code&gt; at the root of the package, and then import it
as &lt;code&gt;from mypy.version import __version__ as version&lt;/code&gt; from both the &lt;code&gt;setup.py&lt;/code&gt; and the package root. This worked because
when someone calls a python script, the current working directory is automatically attached to the &lt;code&gt;sys.path&lt;/code&gt; (so you
can import stuff exposed underneath it).&lt;/p&gt;
&lt;p&gt;This behavior of adding the current working directory though was never mandated. It was more of a side-effect as calling
the build via &lt;code&gt;python setup.py sdist&lt;/code&gt;. As this behavior is a side-effect (not a guarantee) all projects that import from
their &lt;code&gt;setup.py&lt;/code&gt; should explicitly add the scripts folder to the &lt;code&gt;sys.path&lt;/code&gt;, at the start of the build.&lt;/p&gt;
&lt;p&gt;It&amp;rsquo;s up for debate if importing the built package during the packaging (when it&amp;rsquo;s not yet built/distributed) is a good
idea or not (though the Python Packaging group is leaning towards it&amp;rsquo;s not). Nevertheless, the fact of the matter is
that when &lt;code&gt;setuptools&lt;/code&gt; exposed its interface via the &lt;code&gt;setuptools.build_meta&lt;/code&gt;, it chooses not to add the current working
directory to the system path.&lt;/p&gt;
&lt;p&gt;The PEP never mandates for the frontend to do this addition, as most build backend (declarative by nature) will never
need this. Such functionality was deemed to be under the responsibility of the front end. &lt;code&gt;setuptools&lt;/code&gt; respectively
think if users want this functionality, they should be explicit in their &lt;code&gt;setup.py&lt;/code&gt; and prepend the respective path to
the &lt;code&gt;sys.path&lt;/code&gt; manually.&lt;/p&gt;
&lt;p&gt;To simplify the pip code base pip decided to opt in into PEP-517 all people having a &lt;code&gt;pyproject.toml&lt;/code&gt; into the
&lt;code&gt;setuptools&lt;/code&gt; backend. Now with this issue even packages that haven&amp;rsquo;t opted in to PEP-517 started to break. To fix this,
&lt;code&gt;setuptools&lt;/code&gt; added a new build backend (&lt;code&gt;setuptools.build_meta:__legacy__&lt;/code&gt;) designed to be used by frontends as a
default when the build backend is left unspecified; when projects add the &lt;code&gt;build-backend&lt;/code&gt; key, they will have to also
change their &lt;code&gt;setup.py&lt;/code&gt; to either add the source root to their &lt;code&gt;sys.path&lt;/code&gt; or avoid importing from the source root.&lt;/p&gt;
&lt;h3 id="self-bootstrapping-backends"&gt;
self bootstrapping backends
&lt;a class="heading-link" href="#self-bootstrapping-backends"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h3&gt;
&lt;p&gt;Another interesting problem was raised that has a much tighter user base but exposes an interesting problem. In case we
don&amp;rsquo;t want to use wheels, and we provide only via source distribution, how should we resolve the problem of how we
provide the build backend&amp;rsquo;s build backend? For example, &lt;code&gt;setuptools&lt;/code&gt; packages itself via &lt;code&gt;setuptools&lt;/code&gt;. So were
&lt;code&gt;setuptools&lt;/code&gt; specify this via PEP-517, the build frontend would be put inside an infinite loop.&lt;/p&gt;
&lt;p&gt;To install the library &lt;code&gt;pugs&lt;/code&gt; it would first try to create an isolated environment. This environment needs &lt;code&gt;setuptools&lt;/code&gt;,
so the build frontend will need to build a wheel to satisfy it. The wheel build would itself trigger the creation of an
isolated environment, which has build dependency again &lt;code&gt;setuptools&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;How to break this loop? Mandate all build backends must be exposed as wheels? Allow backends that can build themselves?
Should these self-build backends allow to take on dependencies? There&amp;rsquo;s a long discussion with various options, pros and
cons, so if you&amp;rsquo;re interested, make sure to head over the
&lt;a href="https://discuss.python.org/t/pep-517-backend-bootstrapping/789" class="external-link" target="_blank" rel="noopener"&gt;python Discourse board&lt;/a&gt; and give your opinion.&lt;/p&gt;
&lt;figure&gt;
&lt;img src="https://bernat.tech/posts/growing-pain/many_pug.webp" alt="Many pugs"
srcset="https://bernat.tech/posts/growing-pain/many_pug_hu_8020c5ceaa728414.webp 500w" sizes="(min-width: 35em) 1200px, 100vw"
width="700" height="525"
loading="lazy" decoding="async"&gt;
&lt;/figure&gt;
&lt;h2 id="conclusion"&gt;
Conclusion
&lt;a class="heading-link" href="#conclusion"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h2&gt;
&lt;p&gt;Packaging is hard. Improving a packaging system without any breakage where users can write and run arbitrary code during
the packaging in their free time is probably impossible. With PEP-518, though now build dependencies are explicit and
build environments easy to create. With PEP-517, we can start moving into a more declarative packaging namespace that
allows less space for users to make mistakes and provide better messages when things inevitably go wrong. Granted, as we
go through these changes, some packages might break, and we might disallow some practices that worked until now. We
(PyPa maintainers) don&amp;rsquo;t do it in bad faith, so when errors do pop up please do fill in a detailed error report with
what went wrong, how you tried to use it, and what is your use case.&lt;/p&gt;
&lt;p&gt;We&amp;rsquo;re trying to improve the packaging ecosystem genuinely. As such, we&amp;rsquo;ve created the
&lt;a href="https://github.com/pypa/integration-test" class="external-link" target="_blank" rel="noopener"&gt;integration-test&lt;/a&gt; repository, as an effort to ensure that in the future, we
can catch at least some of these edge cases before they land on your machine. If you have any suggestion or requirements
for any part of the packaging feel free to start a discussion on the
&lt;a href="https://discuss.python.org/c/packaging/14" class="external-link" target="_blank" rel="noopener"&gt;Discuss Python forums&lt;/a&gt; packaging section, or open an issue for the relevant
tool at hand.&lt;/p&gt;
&lt;figure&gt;
&lt;img src="https://bernat.tech/posts/growing-pain/final_pug.webp" alt="Pug saying goodbye"
width="480" height="600"
loading="lazy" decoding="async"&gt;
&lt;/figure&gt;
&lt;p&gt;That&amp;rsquo;s all for now. Thanks for reading through it all! I would like to thank
&lt;a href="https://twitter.com/pganssle" class="external-link" target="_blank" rel="noopener"&gt;Paul Ganssle&lt;/a&gt; for reviewing the packaging series post, and
&lt;a href="https://twitter.com/techatbloomberg" class="external-link" target="_blank" rel="noopener"&gt;Tech At Bloomberg&lt;/a&gt; for allowing me to do open source contributions during my
working hours.&lt;/p&gt;</description><category>python</category><category>packaging</category><category>pip</category><category>setuptools</category><category>pep517</category><category>pep518</category></item><item><title>Python packaging - Past, Present, Future</title><link>https://bernat.tech/posts/pep-517-518/</link><pubDate>Thu, 07 Feb 2019 13:40:59 +0000</pubDate><author>Bernát Gábor</author><guid>https://bernat.tech/posts/pep-517-518/</guid><description>&lt;p&gt;Have you ever wondered what happens exactly when you run pip install? This post will give you a detailed overview of the
steps involved in the past, and how it all changes with the adoption of PEP-517 and PEP-518.&lt;/p&gt;
&lt;p&gt;[In my previous post](https://bernat.tech/posts/pep-517-and-python-packaging/) I&amp;rsquo;ve described how it&amp;rsquo;s possible to install three
types of content: source tree, source distribution, and wheels. Only the last two types are uploaded to PyPI, the
central Python repository. However, one could get its hands on a source tree (by feeding, for example, a git protocol
for pip). The advantage of wheels over the others is that it does not require any build operation to happen on the user
machine; it&amp;rsquo;s just downloading and extract.&lt;/p&gt;
&lt;h2 id="building-python-packages"&gt;
Building python packages
&lt;a class="heading-link" href="#building-python-packages"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h2&gt;
&lt;p&gt;Now independent of where the build happens (user or the developer machine), you still need to build the package (either
the sdist or wheel). To do this, you need some builders in place. Historically, the need for third-party packages
manifested itself early on. Following the principle that Python has batteries included in the year 2000 with Python 1.6,
the &lt;a href="https://packaging.python.org/key_projects/#distutils" class="external-link" target="_blank" rel="noopener"&gt;distutils&lt;/a&gt; package was added to the Python standard library.
It introduced the concept of the &lt;code&gt;setup.py&lt;/code&gt; file containing the build logic and is triggered via &lt;code&gt;python setup.py cmd&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;It allowed users to package code as libraries but did not have features such as declaration and automatic installation
of dependencies. Furthermore, its improvement lifecycle was directly tied to the core interpreter release cycle. In 2004
&lt;code&gt;setuptools&lt;/code&gt; was created, built on top of &lt;code&gt;distutils&lt;/code&gt;, and extended with other excellent features. It quickly became so
prevalent that most python installations started to provide it together with the core interpreter itself.&lt;/p&gt;
&lt;p&gt;Back in those days, all packages were source distributions. Wheel distributions came along a lot later, in 2014.
&lt;em&gt;distutils&lt;/em&gt; was created back when only a few highly proficient people did the packaging. It is very flexible and
imperative; you write a python script to modify every step in the package generation process.&lt;/p&gt;
&lt;p&gt;The downside of this, though, is that it&amp;rsquo;s anything but easy to learn and understand. This started to become more and
more an issue as Python grew in popularity and we had more and more users who were less proficient in the inner workings
of Python.&lt;/p&gt;
&lt;figure&gt;
&lt;img src="https://bernat.tech/posts/pep-517-518/smart_pug.webp" alt="Smart pug"
width="400" height="600"
loading="lazy" decoding="async"&gt;
&lt;/figure&gt;
&lt;h3 id="build-requirements"&gt;
build requirements
&lt;a class="heading-link" href="#build-requirements"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h3&gt;
&lt;p&gt;For installing a source distribution pip mostly &lt;strong&gt;did&lt;/strong&gt; the following:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;discover the package&lt;/li&gt;
&lt;li&gt;download the source distribution and extract it&lt;/li&gt;
&lt;li&gt;run &lt;code&gt;python setup.py install&lt;/code&gt; on the extracted folder (does a build + install).&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Developers did &lt;code&gt;python setup.py sdist&lt;/code&gt; to generate the distribution and &lt;code&gt;python setup.py upload&lt;/code&gt; to upload it to a
central repository (the upload command has been deprecated with 2013 in favor of the
&lt;a href="https://pypi.org/project/twine/" class="external-link" target="_blank" rel="noopener"&gt;twine&lt;/a&gt; tool most notably due to the upload using a non-secure HTTP connection, and
upload command also did a fresh build, not allowing the end-user to inspect the generated package before the actual
upload).&lt;/p&gt;
&lt;p&gt;When pip ran the &lt;code&gt;python setup.py install&lt;/code&gt;, it did so with the python interpreter for which it was installing the
package. As such the build operation had access to all third-party packages already available inside that interpreter.
Most notably, it used exactly the &lt;em&gt;setuptools&lt;/em&gt; version that was installed on the host python interpreter. If a package
used a &lt;em&gt;setuptools&lt;/em&gt; feature available on a newer release than currently installed, the only way one could complete the
installation was to update first the installed &lt;em&gt;setuptools.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;This potentially can cause problems if a new release contained a bug that broke other packages. It is especially
troublesome on systems where the users can&amp;rsquo;t alter installed packages. Then there was also the problem of what happens
when the builder (e.g., setuptools) wants to use other helper packages, such as cython.&lt;/p&gt;
&lt;p&gt;If any of these helpers were missing the build usually just broke with a failed to import package error:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-Python" data-lang="Python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;File&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;setup_build.py&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;line&lt;/span&gt; &lt;span class="mi"&gt;99&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;run&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;Cython.Build&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;cythonize&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="ne"&gt;ImportError&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;No&lt;/span&gt; &lt;span class="n"&gt;module&lt;/span&gt; &lt;span class="n"&gt;named&lt;/span&gt; &lt;span class="n"&gt;Cython&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Build&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;There was no way to provide such build dependencies from the developers&amp;rsquo; side. It also meant that users needed to
install all packaging build dependencies even if they did not want to use that at runtime. To solve this issue
&lt;a href="https://peps.python.org/pep-0518/" class="external-link" target="_blank" rel="noopener"&gt;PEP-518&lt;/a&gt; was created.&lt;/p&gt;
&lt;p&gt;The idea is that instead of using the host python with its currently installed packages for the build, the package
provides the ability to be explicit about what they need for their build operation. Instead of making this available on
the host python, we create an isolated python (think of a virtual environment) to run the packaging command.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;python setup.py install&lt;/code&gt; now becomes:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;create a temporary folder&lt;/li&gt;
&lt;li&gt;create an isolated (from the third-party &lt;code&gt;site-packages&lt;/code&gt;) python environment &lt;code&gt;python -m virtualenv our_build_env&lt;/code&gt;,
let&amp;rsquo;s refer to this python executable as &lt;code&gt;python_isolated&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;install the build dependencies&lt;/li&gt;
&lt;li&gt;generate a wheel we can install via &lt;code&gt;python_isolated setup.py bdist_wheel&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;extract wheel to site packages of &lt;code&gt;python&lt;/code&gt;.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;With this we can install packages that depend on &lt;code&gt;cython&lt;/code&gt; without actually installing &lt;code&gt;cython&lt;/code&gt; inside the runtime python
environment. The file and method of specifying the build dependencies is the &lt;code&gt;pyproject.toml&lt;/code&gt; metadata file:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-toml" data-lang="toml"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nx"&gt;build-system&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nx"&gt;requires&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="s2"&gt;&amp;#34;setuptools&amp;gt;=44&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="s2"&gt;&amp;#34;wheel&amp;gt;=0.30.0&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="s2"&gt;&amp;#34;cython&amp;gt;=0.29.4&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Furthermore, this also allows for whoever does the packaging to be explicit about what minimum versions they require for
the packaging and these can be quickly provisioned via pip transparently on the user machines.&lt;/p&gt;
&lt;p&gt;The same mechanism can also be used when generating the source distribution or the wheel on the developers&amp;rsquo; machine.
When one invokes the &lt;code&gt;pip wheel . --no-deps&lt;/code&gt; command that will automatically create in the background an isolated python
that satisfies the build systems dependencies, and then call inside that environment the &lt;code&gt;python setup.py bdist_wheel&lt;/code&gt;
or &lt;code&gt;python setup.py sdist&lt;/code&gt; command.&lt;/p&gt;
&lt;figure&gt;
&lt;img src="https://bernat.tech/posts/pep-517-518/jump_pug.webp" alt="Jumping pug"
width="400" height="600"
loading="lazy" decoding="async"&gt;
&lt;/figure&gt;
&lt;h3 id="packaging-tool-diversity"&gt;
packaging tool diversity
&lt;a class="heading-link" href="#packaging-tool-diversity"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h3&gt;
&lt;p&gt;Now there&amp;rsquo;s one more problem here, though. Note all these operations still go through the mechanism introduced twenty
years ago, aka executing &lt;code&gt;setup.py&lt;/code&gt;. The whole ecosystem still builds on the top of the &lt;em&gt;distutils&lt;/em&gt; and &lt;em&gt;setuptools&lt;/em&gt;
interface that cannot change much due to trying to preserving backward compatibility.&lt;/p&gt;
&lt;p&gt;Also, executing arbitrary user-side Python code during packaging though is dangerous, leading to subtle errors hard to
debug by less experienced users. Imperative build systems were great for flexibility twenty years ago when we were not
aware of all the use cases. Still, now that we have a good understanding, we can probably make very robust and easy
package builders for various use cases.&lt;/p&gt;
&lt;p&gt;To quote &lt;a href="https://twitter.com/pganssle" class="external-link" target="_blank" rel="noopener"&gt;Paul Ganssle&lt;/a&gt; (maintainer of &lt;code&gt;setuptools&lt;/code&gt;and &lt;code&gt;dateutil&lt;/code&gt; on this):&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Ideally, the default option would be a declarative build configuration that works well for the 99% case, with an
option to fall back to an imperative system when you need the flexibility. At this point, it&amp;rsquo;s feasible for us to move
to a world where it&amp;rsquo;s considered a code smell if you find you need to reach for the imperative build options.&lt;/p&gt;
&lt;/blockquote&gt;&lt;blockquote&gt;
&lt;p&gt;The biggest problem with &lt;code&gt;setup.py&lt;/code&gt; is that most people use it declaratively, and when they use it imperatively, they
tend to introduce bugs into the build system. One example of this: if you have a Python 2.7-only dependency, you may
be tempted to specify it conditionally with &lt;code&gt;sys.version&lt;/code&gt; in your &lt;code&gt;setup.py&lt;/code&gt;, but &lt;code&gt;sys.version&lt;/code&gt; only refers to the
interpreter that &lt;em&gt;executed&lt;/em&gt; the build; instead, you should be using the declarative environment markers for your
install requirements.&lt;/p&gt;
&lt;/blockquote&gt;&lt;p&gt;&lt;a href="https://pypi.org/project/flit/" class="external-link" target="_blank" rel="noopener"&gt;flit&lt;/a&gt; proved this assumption correct already with its introduction in 2015. It has
become the favorite packaging tool for many newcomers to Python, making sure new users avoid many foot guns. However, to
get to this point, &lt;code&gt;flit&lt;/code&gt; had to again build on top of &lt;em&gt;distutils&lt;/em&gt;/&lt;em&gt;setuptools,&lt;/em&gt; which makes its implementation
non-trivial, and the codebase quite a few shim layers (it still generates the &lt;code&gt;setup.py&lt;/code&gt; file, for example, for its
source distributions).&lt;/p&gt;
&lt;p&gt;It&amp;rsquo;s time to free it from these shackles and encourage other people to build their packaging tools that make packaging
easy for their use cases, making &lt;code&gt;setup.py&lt;/code&gt; the exception rather than the default.
&lt;a href="https://github.com/pypa/setuptools/pull/1675" class="external-link" target="_blank" rel="noopener"&gt;&lt;code&gt;setuptools&lt;/code&gt; plans to offer a &lt;code&gt;setup.cfg&lt;/code&gt;&lt;/a&gt; the only user interface to
lead the way, and when a PEP-517 system is in place, you should prefer that overusing the &lt;code&gt;setup.py&lt;/code&gt; for most cases. To
not tie everything back to &lt;code&gt;setuptools&lt;/code&gt; and &lt;code&gt;distutils&lt;/code&gt; and facilitate the creation of new-build backends
&lt;a href="https://peps.python.org/pep-0517/" class="external-link" target="_blank" rel="noopener"&gt;PEP-517&lt;/a&gt; was created. It separates builders into a backend and frontend. The
frontend provides an isolated python environment satisfying all the declared build dependencies; the backend provides
hooks that the frontend can call from its isolated environment to generate either a source distribution or wheel.&lt;/p&gt;
&lt;p&gt;Furthermore, instead of talking with the backend via the &lt;code&gt;setup.py&lt;/code&gt; file and its commands, we move to python modules and
functions. All packaging backends must provide a python object API that implements two methods
&lt;a href="https://peps.python.org/pep-0517/#build-wheel" class="external-link" target="_blank" rel="noopener"&gt;build_wheel&lt;/a&gt; and &lt;a href="https://peps.python.org/pep-0517/#id9" class="external-link" target="_blank" rel="noopener"&gt;build_sdist&lt;/a&gt; at
the minimum. The API object point is specified via the &lt;code&gt;pyproject.toml&lt;/code&gt; file under the &lt;code&gt;build-backend&lt;/code&gt; key:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-toml" data-lang="toml"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nx"&gt;build-system&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nx"&gt;requires&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;flit&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nx"&gt;build-backend&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;flit.api:main&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The above code effectively means for the frontend that you can get hold of the backend by running the above code inside
the isolated python environment:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;flit.api&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;backend&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;flit&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;api&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;main&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c1"&gt;# build wheel via&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;backend&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;build_wheel&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c1"&gt;# build source distribution via&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;backend&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;build_sdist&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;It&amp;rsquo;s up to the backend where and how they want to expose their official API:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href="https://flit.readthedocs.io/en/latest/" class="external-link" target="_blank" rel="noopener"&gt;flit&lt;/a&gt; does it via &lt;code&gt;flit.buildapi&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://setuptools.readthedocs.io/en/latest/history.html#v40-8-0" class="external-link" target="_blank" rel="noopener"&gt;setuptools&lt;/a&gt; provides two variants:
&lt;code&gt;setuptools.build_meta&lt;/code&gt; (on why read on later)&lt;/li&gt;
&lt;li&gt;&lt;a href="https://poetry.eustace.io/docs/pyproject/#poetry-and-pep-517" class="external-link" target="_blank" rel="noopener"&gt;poetry&lt;/a&gt; does it via &lt;code&gt;poetry.masonry.api&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;With this, we can start having packaging tools that are no longer bound to the legacy decisions of the &lt;code&gt;distutils&lt;/code&gt; in
the frontend.&lt;/p&gt;
&lt;figure&gt;
&lt;img src="https://bernat.tech/posts/pep-517-518/curious_pug.webp" alt="Curious pug"
width="400" height="600"
loading="lazy" decoding="async"&gt;
&lt;/figure&gt;
&lt;h1 id="tox-and-packaging"&gt;
tox and packaging
&lt;a class="heading-link" href="#tox-and-packaging"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h1&gt;
&lt;p&gt;&lt;a href="https://tox.readthedocs.io/en/latest/" class="external-link" target="_blank" rel="noopener"&gt;tox is testing tool&lt;/a&gt; and used by most projects to ensure compatibility against
multiple Python interpreter versions of a given package. It also allows the quick creation of Python environments with
the package under inspection installed in it, making reproducing failures faster.&lt;/p&gt;
&lt;p&gt;To be able to test a package, it first needs to build a source distribution, though. While both PEP-518 and PEP-517
should make things better, turning them on can break packaging under some use cases. Therefore when
&lt;a href="https://tox.readthedocs.io/en/latest/" class="external-link" target="_blank" rel="noopener"&gt;&lt;code&gt;tox&lt;/code&gt;&lt;/a&gt; added isolated build in version
&lt;a href="https://tox.readthedocs.io/en/latest/" class="external-link" target="_blank" rel="noopener"&gt;&lt;code&gt;3.3.0&lt;/code&gt;&lt;/a&gt; decided not to enable it by default, for now. You need to enable it
manually (it will be turned on by default in version &lt;code&gt;4&lt;/code&gt; sometime later this year - 2021).&lt;/p&gt;
&lt;p&gt;Once you&amp;rsquo;ve specified a &lt;code&gt;pyproject.toml&lt;/code&gt; with appropriate &lt;code&gt;requires&lt;/code&gt; and &lt;code&gt;build-backend&lt;/code&gt;, you need to turn on the
&lt;code&gt;isolated_build&lt;/code&gt; flag inside &lt;code&gt;tox.ini&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-ini" data-lang="ini"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;[tox]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="na"&gt;isolated_build&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;True&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;After this, tox in the &lt;a href="https://tox.readthedocs.io/en/latest/#system-overview" class="external-link" target="_blank" rel="noopener"&gt;packaging phase&lt;/a&gt; will build the source
distribution (by providing the build dependencies into an isolated python environment as per PEP-518). Afterward will
call the build backend as stated in PEP-517. Otherwise, tox will use the old way of building source distributions,
invoking the &lt;code&gt;python setup.py sdist&lt;/code&gt; command with the same interpreter tox is installed into.&lt;/p&gt;
&lt;figure&gt;
&lt;img src="https://bernat.tech/posts/pep-517-518/moody_pug.webp" alt="Moody pug"
srcset="https://bernat.tech/posts/pep-517-518/moody_pug_hu_94a4de09c68b721d.webp 500w" sizes="(min-width: 35em) 1200px, 100vw"
width="700" height="467"
loading="lazy" decoding="async"&gt;
&lt;/figure&gt;
&lt;h2 id="conclusion"&gt;
Conclusion
&lt;a class="heading-link" href="#conclusion"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h2&gt;
&lt;p&gt;The Python Packaging Authority hopes that all this makes sense and will have more user-friendly, error-proof and stable
builds. The specifications for these standards were written up and debated in long threads between 2015 and 2017. The
proposals were deemed good enough to benefit the most, but some less mainstream use cases could have been overlooked.&lt;/p&gt;
&lt;p&gt;If your use case is such, don&amp;rsquo;t worry the PEPs are open to enhancement at any point if we deem required. [In my next
post of this series here](https://bernat.tech/posts/growing-pain/) I&amp;rsquo;ll go over some of the pain points the community bumped into
while releasing these two PEPs. These should serve as lessons learned and show that there&amp;rsquo;s still some work to be done.
It&amp;rsquo;s not everything perfect yet. However, we&amp;rsquo;re getting better. Join the packaging community if you can help out, and
let&amp;rsquo;s make things better together!&lt;/p&gt;</description><category>python</category><category>pip</category><category>install</category><category>packaging</category><category>setuptools</category><category>pep517</category><category>pep518</category></item><item><title>The state of Python Packaging</title><link>https://bernat.tech/posts/pep-517-and-python-packaging/</link><pubDate>Thu, 07 Feb 2019 13:40:54 +0000</pubDate><author>Bernát Gábor</author><guid>https://bernat.tech/posts/pep-517-and-python-packaging/</guid><description>&lt;p&gt;pip 19.0 has been released on 22nd January 2019. On the feature list, most notably, it now supports PEP-517, which by
default is turned &lt;strong&gt;on&lt;/strong&gt; when that the project has a &lt;code&gt;pyproject.toml&lt;/code&gt; at the root folder. The PEP in question has been
created in 2015 and accepted in 2017. Even though it took a while until pip implemented it, the release and the issues
that followed confirmed that many people are not familiar with it. Read on if you want to get a picture of how the
Python packaging ecosystem evolved today and where we hope to see it down the line. We expect that even though the
introduction of the aforementioned python enhancement proposal may cause some discomfort, we will benefit from it in the
long term.&lt;/p&gt;
&lt;p&gt;I joined the Python open-source community around three years ago (though I have used it for more than 8 years). I&amp;rsquo;ve
remarked that the Python packaging has a reputation of a somewhat black box from the early days. There are many unknown
parts, and people mostly get by with just copying other projects, build configurations, and roll with them. On my path
to better understanding this black box and improving it, I&amp;rsquo;ve become the maintainer of both the virtualenv and tox
project, occasionally contributing to both &lt;code&gt;setuptools&lt;/code&gt; and &lt;code&gt;pip&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;As I hope to give an exhausting (hopefully still a relatively high level) overview of the subject, I decided to split it
up into three posts. In this first post, I will give a broad overview of how Python packaging works and the type of
packages it has. In a subsequent post, I will present in detail how the installation of packages works and how
PEP-517/518 tries to improve on it. Finally, I dedicate a whole other post to explain some of the painful lessons we
learned while introducing these improvements. A heads up, I will focus mainly on the Python Packaging Authorities
systems (&lt;code&gt;pip&lt;/code&gt;, &lt;code&gt;setuptools&lt;/code&gt;, so no &lt;code&gt;conda&lt;/code&gt; or operating system-specific packagers).&lt;/p&gt;
&lt;figure&gt;
&lt;img src="https://bernat.tech/posts/pep-517-and-python-packaging/sad_pug.webp" alt="Sad pug"
srcset="https://bernat.tech/posts/pep-517-and-python-packaging/sad_pug_hu_2c310c7e3a7f8e56.webp 500w" sizes="(min-width: 35em) 1200px, 100vw"
width="700" height="468"
loading="lazy" decoding="async"&gt;
&lt;/figure&gt;
&lt;h1 id="an-example-project"&gt;
An example project
&lt;a class="heading-link" href="#an-example-project"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h1&gt;
&lt;p&gt;To tell this story, I&amp;rsquo;ll need to tell how to distribute python packages; more specifically, explain how to package
installation worked in the past and how we hope it will work in the future. To have a concrete example of what to
demonstrate, let me introduce my excellent example library: &lt;code&gt;pugs&lt;/code&gt;. This library reasonably simple: it generates a
single package called &lt;code&gt;pugs&lt;/code&gt; containing only a single module called &lt;code&gt;logic&lt;/code&gt;. The logic is to generate random quotes, you
guessed right, about &lt;em&gt;pugs&lt;/em&gt;. Here&amp;rsquo;s a simple example structure of it viewed as a source tree (also available under
&lt;a href="https://github.com/gaborbernat/pugs" class="external-link" target="_blank" rel="noopener"&gt;gaborbernat/pugs&lt;/a&gt;):&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;pugs-project
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;├── README.rst
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;├── setup.cfg
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;├── setup.py
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;├── LICENSE.txt
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;├── src
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;│   └── pugs
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;│   ├── __init__.py
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;│   └── logic.py
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;├── tests
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;│   ├── test_init.py
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;│   └── test_logic.py
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;├── tox.ini
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;└── azure-pipelines.yml
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;We have four distinct content type here:&lt;/p&gt;
&lt;p&gt;What would it mean for our &lt;code&gt;pugs&lt;/code&gt; package to be available on a user machine&amp;rsquo;s interpreter? Ideally, the user should be
able to import it and call functions from it once it starts up the interpreter:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;the business logic code (what&amp;rsquo;s inside the &lt;code&gt;src&lt;/code&gt; folder),&lt;/li&gt;
&lt;li&gt;the test code (&lt;code&gt;tests&lt;/code&gt; folder and &lt;code&gt;tox.ini&lt;/code&gt;),&lt;/li&gt;
&lt;li&gt;the packaging code and metadata (&lt;code&gt;setup.py&lt;/code&gt;, &lt;code&gt;setup.cfg&lt;/code&gt;, &lt;code&gt;LICENSE.txt&lt;/code&gt;, &lt;code&gt;README.rst&lt;/code&gt; - note we use nowadays the de
facto standard packaging tool &lt;a href="https://pypi.org/project/setuptools" class="external-link" target="_blank" rel="noopener"&gt;setuptools&lt;/a&gt;),&lt;/li&gt;
&lt;li&gt;files helping with project management and maintenance:
&lt;ul&gt;
&lt;li&gt;continuous-integration (&lt;code&gt;azure-pipelines.yml&lt;/code&gt;)&lt;/li&gt;
&lt;li&gt;version control (&lt;code&gt;.git&lt;/code&gt;)&lt;/li&gt;
&lt;li&gt;project management (for example, a potential &lt;code&gt;.github&lt;/code&gt; folder).&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;Python&lt;/span&gt; &lt;span class="mf"&gt;3.7.2&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;v3&lt;/span&gt;&lt;span class="mf"&gt;.7.2&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;9&lt;/span&gt;&lt;span class="n"&gt;a3ffc0492&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Dec&lt;/span&gt; &lt;span class="mi"&gt;24&lt;/span&gt; &lt;span class="mi"&gt;2018&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;02&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;44&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;43&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;Clang&lt;/span&gt; &lt;span class="mf"&gt;6.0&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;clang&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mf"&gt;600.0.57&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt; &lt;span class="n"&gt;on&lt;/span&gt; &lt;span class="n"&gt;darwin&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;Type&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;help&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;copyright&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;credits&amp;#34;&lt;/span&gt; &lt;span class="ow"&gt;or&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;license&amp;#34;&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;more&lt;/span&gt; &lt;span class="n"&gt;information&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;pugs&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;pugs&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;do_tell&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="s2"&gt;&amp;#34;An enlightened pug knows how to make the best of whatever he has to work with - A Pug&amp;#39;s Guide to Dating - Gemma Correll&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;figure&gt;
&lt;img src="https://bernat.tech/posts/pep-517-and-python-packaging/enlightened_pug.webp" alt="Enlightened pug"
srcset="https://bernat.tech/posts/pep-517-and-python-packaging/enlightened_pug_hu_d9656d45932712d8.webp 500w" sizes="(min-width: 35em) 1200px, 100vw"
width="700" height="468"
loading="lazy" decoding="async"&gt;
&lt;/figure&gt;
&lt;h1 id="python-package-availability"&gt;
Python package availability
&lt;a class="heading-link" href="#python-package-availability"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h1&gt;
&lt;p&gt;How does Python knows what&amp;rsquo;s available or not? The short answer is it does not. Not upfront, at least, that is. Instead,
it will try to load and see if it succeeds dynamically. From where does it load it? There are many possible locations,
but in most cases, we are talking about loading it from a folder on the file system. Where is this folder? For a given
module, one can print out the representation of the module to find out:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;pugs&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;pugs&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;module&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;pugs&amp;#39;&lt;/span&gt; &lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;/Users/bernat/Library/Python/3.7/lib/python/site-packages/pugs/__init__.py&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The folder under you&amp;rsquo;ll find it depends on:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;the type of the package it is (third-party or built-in/aka part of the standard library)&lt;/li&gt;
&lt;li&gt;if it&amp;rsquo;s globally or just for the current user available (see &lt;a href="https://peps.python.org/pep-0370/" class="external-link" target="_blank" rel="noopener"&gt;PEP-370&lt;/a&gt;),&lt;/li&gt;
&lt;li&gt;and if it&amp;rsquo;s a system python or a virtual environment.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Generally speaking, though, for a given python interpreter, one can find a list of possible directories by printing out
the &lt;code&gt;sys.path&lt;/code&gt; variables content, for example, on my macOS:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;sys&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;Library&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;Frameworks&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;Python&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;framework&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;Versions&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mf"&gt;3.7&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;lib&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;python37&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;zip&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;Library&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;Frameworks&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;Python&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;framework&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;Versions&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mf"&gt;3.7&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;lib&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;python3&lt;/span&gt;&lt;span class="mf"&gt;.7&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;Library&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;Frameworks&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;Python&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;framework&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;Versions&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mf"&gt;3.7&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;lib&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;python3&lt;/span&gt;&lt;span class="mf"&gt;.7&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;lib&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;dynload&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;Users&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;bernat&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;Library&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;Python&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mf"&gt;3.7&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;lib&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;python&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;site&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;packages&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;Library&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;Frameworks&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;Python&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;framework&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;Versions&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mf"&gt;3.7&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;lib&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;python3&lt;/span&gt;&lt;span class="mf"&gt;.7&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;site&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;packages&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;For third-party packages, it&amp;rsquo;s going to be some &lt;code&gt;site-packages&lt;/code&gt; folder. Note in the above example how there&amp;rsquo;s a
system-wide and a user-specific instance of this. How do packages end up inside this folder? It must be put there by
some installer.&lt;/p&gt;
&lt;p&gt;The following diagram displays how most of the time things go:&lt;/p&gt;
&lt;figure&gt;
&lt;img src="https://bernat.tech/posts/pep-517-and-python-packaging/diagram.webp" alt="Python packaging diagram"
srcset="https://bernat.tech/posts/pep-517-and-python-packaging/diagram_hu_697fb3e41a71dcd2.webp 500w" sizes="(min-width: 35em) 1200px, 100vw"
width="700" height="425"
loading="lazy" decoding="async"&gt;
&lt;/figure&gt;
&lt;ol&gt;
&lt;li&gt;The developer writes some python code inside a folder (referred to as the source tree).&lt;/li&gt;
&lt;li&gt;Some tool (such as &lt;code&gt;setuptools&lt;/code&gt;) then takes the source tree and packages it up for redistribution.&lt;/li&gt;
&lt;li&gt;The generated package is uploaded via another tool (twine) to a central repository (usually
&lt;a href="https://pypi.org" class="external-link" target="_blank" rel="noopener"&gt;https://pypi.org&lt;/a&gt;) the end-user machine has access to.&lt;/li&gt;
&lt;li&gt;The end-user machine uses some installer that discovers, downloads, and installs the package in question. The
installation operation boils down by creating the correct directory structure and metadata inside the &lt;code&gt;site-packages&lt;/code&gt;
folder.&lt;/li&gt;
&lt;/ol&gt;
&lt;figure&gt;
&lt;img src="https://bernat.tech/posts/pep-517-and-python-packaging/discover_pug.webp" alt="Pug discovering something"
srcset="https://bernat.tech/posts/pep-517-and-python-packaging/discover_pug_hu_f731d5a9f88dfc52.webp 500w" sizes="(min-width: 35em) 1200px, 100vw"
width="700" height="554"
loading="lazy" decoding="async"&gt;
&lt;/figure&gt;
&lt;h1 id="python-package-types"&gt;
Python package types
&lt;a class="heading-link" href="#python-package-types"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h1&gt;
&lt;p&gt;A package during installation must generate at least two types of content to be put in the site package: a metadata
folder about the package contents the &lt;code&gt;{package}-{version}.dist-info&lt;/code&gt; and the business logic files.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;/Users/bernat/Library/Python/3.7/lib/python/site-packages/pugs
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;├── __init__.py
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;├── __pycache__
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;│ ├── __init__.cpython-37.pyc
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;│ └── logic.cpython-37.pyc
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;└── logic.py
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;/Users/bernat/Library/Python/3.7/lib/python/site-packages/pugs-0.0.1.dist-info
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;├── INSTALLER
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;├── LICENSE.txt
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;├── METADATA
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;├── RECORD
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;├── WHEEL
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;├── top_level.txt
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;└── zip-safe
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The distribution info folder describes the package: what installer was used to put it there, what license the package
has attached to it, what files were created as part of the installation process, what is the top-level python package,
what entry points the package exposes and so on. A good description of each file can be found inside
&lt;a href="https://peps.python.org/pep-0427/#id14" class="external-link" target="_blank" rel="noopener"&gt;PEP-427&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;How do we get from our source tree to these two content types? We have two distinct paths in front of us:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Generate this directory structure and metadata from our source tree, compress it into a single file, and publish it
to the central package repository. In this case, the installer has to download the package and extract it to the
&lt;code&gt;site-packages&lt;/code&gt; folder. We refer to this type of package as a &lt;code&gt;wheel&lt;/code&gt; package.&lt;/li&gt;
&lt;li&gt;Alternatively, you can create an archive containing the package source, build scripts and metadata required to
generate the installable directory structure, then upload that to the central repository. This is called a source
distribution or &lt;code&gt;sdist&lt;/code&gt;. In this case, the installer has a lot more work to do, extracts the archive, runs the
builder, and only then copies it over.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;The difference between the two options is mainly about where the package &lt;em&gt;compile/build&lt;/em&gt; operation happens: the
developers&amp;rsquo; machine or the end-users machine. If it occurs on the developers&amp;rsquo; side (such as wheels), the installation
process is very lightweight. Everything has already been done on the developer machine side. The user machine side
operation is just a simple download and decompress.&lt;/p&gt;
&lt;p&gt;In our case, we used &lt;code&gt;setuptools&lt;/code&gt; as our builder (the part that generates from the source tree the content to be put
inside the site-packages folder). Therefore, to perform the build operation on the user machine, we would need to ensure
that an &lt;em&gt;appropriate&lt;/em&gt; version of &lt;code&gt;setuptools&lt;/code&gt; is available on the user machine (if you&amp;rsquo;re using a feature from version
&lt;code&gt;40.6.0&lt;/code&gt; you must guarantee that the user has at least that version).&lt;/p&gt;
&lt;p&gt;Another use case to consider is that Python offers access to C/C++ libraries from within Python (to get that extra
performance where you need it). Packages that do so are referred to as C-extension packages, as they take advantage of
the C-extension API CPython offers.&lt;/p&gt;
&lt;p&gt;Such extensions to work though, need to C/C++ compile their functionality against both the C/C++ library they interact
with and the current Python interpreters C-API library. In these cases, the build operation involves calling a binary
compiler, not just metadata and folder structure generation as was the case with pure python packages (such as our
&lt;code&gt;pugs&lt;/code&gt; library was).&lt;/p&gt;
&lt;p&gt;If the build happens on the user machine, one needs to ensure that the correct libraries and compilers are also
available at build time. This is now a much harder job, as these are platform-specific binaries distributed via the
platform&amp;rsquo;s packaging tools. The lack or version miss-match of these libraries often triggers cryptic errors during the
build, which leaves users frustrated and puzzled.&lt;/p&gt;
&lt;p&gt;Therefore, if possible, always prefer packaging your package as a &lt;strong&gt;&lt;em&gt;wheel&lt;/em&gt;&lt;/strong&gt;. This will altogether avoid the problem of
users not having all the correct build dependencies (both pure python types such as setuptools or binary ones as is the
C/C++ compiler). Even if those build dependencies are easy to provision (such as in the case of pure python builders -
e.g. setuptools) you can save install time by avoiding this step entirely.&lt;/p&gt;
&lt;p&gt;That being said they are still two use cases that warrant providing source distributions (even when you provide a
wheel):&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;C-extension source distributions tend to be more auditable, as one can read the source code and thus offer greater
transparency in what it offers: many big corporate environments prefer using these over wheels for this sole reason
(they generally extend the rule to pure python wheels, mostly to avoid the need of categorizing what is pure python
wheel and what is not).&lt;/li&gt;
&lt;li&gt;You might not be able to provide a wheel for every possible platform out there (especially true in case of
c-extension packages), in this case, the source distribution may allow these platforms to generate the wheel
themselves.&lt;/li&gt;
&lt;/ol&gt;
&lt;h1 id="conclusion"&gt;
Conclusion
&lt;a class="heading-link" href="#conclusion"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h1&gt;
&lt;p&gt;The difference between a source tree, a source distribution, and a wheel:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;source tree &lt;em&gt;-&lt;/em&gt;&lt;/strong&gt; contains all project files available on the developers&amp;rsquo; machine/repository (business logic, tests,
packaging data, CI files, IDE files, SVC, etc.) - for example, see example project above.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;source distribution&lt;/strong&gt; - contains code files required to build a wheel (business logic + packaging data + often also
the unit tests files to validate the build; notably lacks developer environment content such as CI/IDE/version control
files) - format: &lt;code&gt;pugs-0.0.1.tar.gz&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;wheel&lt;/strong&gt; - contains the package metadata and source files to be put into the &lt;code&gt;site-packages&lt;/code&gt; folder - format:
&lt;code&gt;pugs-0.0.1-py2.py3-none-any.whl&lt;/code&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;figure&gt;
&lt;img src="https://bernat.tech/posts/pep-517-and-python-packaging/smart_pug.webp" alt="Smart pug"
srcset="https://bernat.tech/posts/pep-517-and-python-packaging/smart_pug_hu_a239ae4645d0da08.webp 500w" sizes="(min-width: 35em) 1200px, 100vw"
width="600" height="614"
loading="lazy" decoding="async"&gt;
&lt;/figure&gt;
&lt;p&gt;[Read the next post of the series here](https://bernat.tech/posts/pep-517-518/) to determine what happens when we install a
package. Thanks for reading!&lt;/p&gt;</description><category>python</category><category>packaging</category><category>pip</category><category>setuptools</category><category>pep517</category><category>pep518</category><category>wheel</category><category>sdist</category></item><item><title>The state of type hints in Python</title><link>https://bernat.tech/posts/the-state-of-type-hints-in-python/</link><pubDate>Wed, 30 May 2018 09:51:55 +0000</pubDate><author>Bernát Gábor</author><guid>https://bernat.tech/posts/the-state-of-type-hints-in-python/</guid><description>&lt;p&gt;One of the main selling points for Python is that it is dynamically-typed. There is no plan to change this.
Nevertheless, in September 2014 &lt;a href="https://twitter.com/gvanrossum" class="external-link" target="_blank" rel="noopener"&gt;Guido van Rossum&lt;/a&gt; (Python
&lt;a href="https://en.wikipedia.org/wiki/Benevolent_dictator_for_life" class="external-link" target="_blank" rel="noopener"&gt;BDFL&lt;/a&gt;) created a python enhancement proposal
(&lt;a href="https://peps.python.org/pep-0484/" class="external-link" target="_blank" rel="noopener"&gt;PEP-484&lt;/a&gt;) to add type hints to Python. It has been released for general usage a
year later, in September 2015, as part of Python &lt;code&gt;3.5.0&lt;/code&gt;.
&lt;a href="http://python-history.blogspot.com/2009/01/brief-timeline-of-python.html" class="external-link" target="_blank" rel="noopener"&gt;Twenty-five years into its existence&lt;/a&gt; now
there was a standard way to add type information to Python code. In this blog post, I&amp;rsquo;ll explore how the system matured,
how you can use it, and what&amp;rsquo;s next for type hints.&lt;/p&gt;
&lt;p&gt;Disclaimer: throughout this blog post, you&amp;rsquo;ll see many seals and penguin pictures. The reason for this is mostly my
admiration for these animals, and hey, nothing like some cute animals to help digest some tricky topics, not?&lt;/p&gt;
&lt;h1 id="why-do-we-need-this"&gt;
Why do we need this?
&lt;a class="heading-link" href="#why-do-we-need-this"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h1&gt;
&lt;figure&gt;
&lt;img src="https://bernat.tech/posts/the-state-of-type-hints-in-python/why.webp" alt="Seal asking why"
srcset="https://bernat.tech/posts/the-state-of-type-hints-in-python/why_hu_e0deed3d1627845f.webp 500w" sizes="(min-width: 35em) 1200px, 100vw"
width="700" height="525"
loading="lazy" decoding="async"&gt;
&lt;/figure&gt;
&lt;h2 id="what-it-was-designed-to-do"&gt;
What it was designed to do?
&lt;a class="heading-link" href="#what-it-was-designed-to-do"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h2&gt;
&lt;p&gt;First, let&amp;rsquo;s see why do we need type hints in Python. There are multiple advantages of this, and I&amp;rsquo;ll try to enumerate
it in their order of importance:&lt;/p&gt;
&lt;h3 id="1-easier-to-reason-about-code"&gt;
1. Easier to reason about code
&lt;a class="heading-link" href="#1-easier-to-reason-about-code"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h3&gt;
&lt;p&gt;Knowing the type of parameters makes it a lot easier to understand and maintain a codebase. For example, let&amp;rsquo;s assume
you have a function. While we know the types of the parameters at the time of creating the function, a few months down
the line, this is no longer the case. Having stated the types of all parameters and return types right beside the code
can speed up significantly the time required to catch up with a code snippet. Always remember that code you read code a
lot more often than you write it. Therefore you should optimize for ease of reading.&lt;/p&gt;
&lt;p&gt;Having type hints informs you of what parameter types you need to pass on when calling a function and when you need to
extend/modify the function tells you about the type of data you get both as input and output. For example, imagine the
following the send request function,&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;send_request&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;request_data&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Any&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;headers&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Optional&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;Dict&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;]],&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;user_id&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Optional&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;UserId&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;as_json&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;bool&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kc"&gt;True&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;):&lt;/span&gt; &lt;span class="o"&gt;...&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Just looking at the signature of this, I know that while the &lt;code&gt;request_data&lt;/code&gt; could be anything, the &lt;code&gt;headers&lt;/code&gt; content is
a dictionary of strings. The user information is optional (defaulting to &lt;code&gt;None&lt;/code&gt;), or it needs to be whatever &lt;code&gt;UserId&lt;/code&gt;
encodes it too. The contract for &lt;code&gt;as_json&lt;/code&gt; is that it needs to be always a boolean value, being a flag essentially even
though the name might not suggest that at first.&lt;/p&gt;
&lt;p&gt;The truth is many of us already understand that type of information is essential. However, in lack of better options
until now, this was often mentioned inside the docstring. The type hint system moves this closer to the function
interface and provides a well-defined way to declare complex type requirements. Building linters that can check these
type hint constraints ensure that they never become out of date, granted that you run them after every code change.&lt;/p&gt;
&lt;h3 id="2easier-refactoring"&gt;
2.Easier refactoring
&lt;a class="heading-link" href="#2easier-refactoring"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h3&gt;
&lt;p&gt;Type hints make it trivial to find where a given class is used when you&amp;rsquo;re trying to refactor your codebase. While many
IDEs already have some heuristic in place to achieve this. Type hints allow them to have &lt;code&gt;100%&lt;/code&gt; detection and accuracy
ratio. Generally offers a smoother and more accurate detection of how types run through your code. Remember, while
dynamic typing means any variable can become any of types, all your variables have at all time one and only one type.
The type system still is very much a core component of programming. Remember all the time you&amp;rsquo;ve used &lt;code&gt;isinstance&lt;/code&gt; to
drive your application logic.&lt;/p&gt;
&lt;h3 id="3-easier-to-use-libraries"&gt;
3. Easier to use libraries
&lt;a class="heading-link" href="#3-easier-to-use-libraries"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h3&gt;
&lt;p&gt;Having type hints mean IDEs can have a more accurate and smarter suggestion engine. Now when you invoke auto-complete,
the IDE knows with complete confidence, what methods/attributes are available on an object. Furthermore, if the user
tries to call something non-existent or passes arguments of an incorrect type, the IDE can instantly warn about it.&lt;/p&gt;
&lt;figure&gt;
&lt;img src="https://bernat.tech/posts/the-state-of-type-hints-in-python/editor_suggest.webp" alt="IDE suggestion"
srcset="https://bernat.tech/posts/the-state-of-type-hints-in-python/editor_suggest_hu_5003627f3aff6bd6.webp 500w" sizes="(min-width: 35em) 1200px, 100vw"
width="500" height="225"
loading="lazy" decoding="async"&gt;
&lt;/figure&gt;
&lt;h3 id="4-type-linters"&gt;
4. Type linters
&lt;a class="heading-link" href="#4-type-linters"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h3&gt;
&lt;figure&gt;
&lt;img src="https://bernat.tech/posts/the-state-of-type-hints-in-python/type_mismatch.webp" alt="Type mismatch warning"
srcset="https://bernat.tech/posts/the-state-of-type-hints-in-python/type_mismatch_hu_c9f9874cfa53e93c.webp 500w" sizes="(min-width: 35em) 1200px, 100vw"
width="500" height="181"
loading="lazy" decoding="async"&gt;
&lt;/figure&gt;
&lt;p&gt;While the IDE suggesting incorrect argument types is excellent, an extension of this is to have a linter tool that makes
sure that type wise the logic of your application is sound. Running this tool can help you catch bugs early on (e.g., in
the example that follows, the input must be of type &lt;code&gt;str&lt;/code&gt;, passing in &lt;code&gt;None&lt;/code&gt; throws an exception):&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;transform&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;arg&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;transformed value &lt;/span&gt;&lt;span class="si"&gt;{}&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;arg&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;upper&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c1"&gt;# if arg would be type hinted as str the type linter could warn that this is an invalid call&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;transform&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;While in this trivial case, some could argue that it&amp;rsquo;s easy to see the mismatch, remember this works in more complicated
cases too, where such mismatches get harder and harder to see; such as nested function calls:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;construct&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;param&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;param&lt;/span&gt; &lt;span class="ow"&gt;is&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt; &lt;span class="k"&gt;else&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;append&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;arg&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;arg&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34; appended&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;transform&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;construct&lt;/span&gt;&lt;span class="p"&gt;()))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;While there are more and more linters out there, the reference implementation of the Python type checking is
&lt;a href="http://mypy-lang.org/" class="external-link" target="_blank" rel="noopener"&gt;mypy&lt;/a&gt;. mypy is a Python command-line application, making it easy to integrate into a continuous
integration pipeline.&lt;/p&gt;
&lt;h3 id="5-runtime-data-validation"&gt;
5. Runtime data validation
&lt;a class="heading-link" href="#5-runtime-data-validation"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h3&gt;
&lt;p&gt;Type hints can be used to validate at runtime to ensure that the caller does not break the contract of methods. It is no
longer needed to start your function with a long list of type asserts; instead, use a framework that re-uses type hints
and automatically checks that they are meet before your business logic runs (for example, with
&lt;a href="https://github.com/samuelcolvin/pydantic" class="external-link" target="_blank" rel="noopener"&gt;pydantic&lt;/a&gt;):&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;datetime&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;datetime&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;typing&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;List&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;pydantic&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;BaseModel&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;ValidationError&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;User&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;BaseModel&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="nb"&gt;id&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;name&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;John Doe&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;signup_ts&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;datetime&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;friends&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;List&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;external_data&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;id&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;123&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;signup_ts&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;2017-06-01 12:22&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;friends&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="p"&gt;]}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;user&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;User&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;external_data&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;User&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;signup_ts&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;broken&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;friends&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;not number&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;except&lt;/span&gt; &lt;span class="n"&gt;ValidationError&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;json&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="what-it-wasnt-designed-to-do"&gt;
What it wasn&amp;rsquo;t designed to do?
&lt;a class="heading-link" href="#what-it-wasnt-designed-to-do"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h2&gt;
&lt;p&gt;From the get-go, Guido clearly stated that type hints are not meant to be used for the following use cases (of course
that does not mean that people do not have libraries/tools outside, which do just that - open source power for the
win!):&lt;/p&gt;
&lt;h3 id="1-no-runtime-type-inference"&gt;
1. No runtime type inference
&lt;a class="heading-link" href="#1-no-runtime-type-inference"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h3&gt;
&lt;p&gt;The runtime interpreter (CPython) does not try to deduce type information at runtime and perhaps validate arguments
passed around based on that.&lt;/p&gt;
&lt;h3 id="2-no-performance-tuning"&gt;
2. No performance tuning
&lt;a class="heading-link" href="#2-no-performance-tuning"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h3&gt;
&lt;p&gt;The runtime interpreter (CPython) does not use the type of information to optimize the generated byte-code for either
security or performance. When executing a Python script type hints are treated just like comments; the interpreter
discards it.&lt;/p&gt;
&lt;p&gt;The key takeaway should be that type hints are designed to improve developer experience, not influencing how your script
evaluates. It creates happy developers, not faster code!&lt;/p&gt;
&lt;figure&gt;
&lt;img src="https://bernat.tech/posts/the-state-of-type-hints-in-python/happy_programmer.webp" alt="Happy programmer seal"
srcset="https://bernat.tech/posts/the-state-of-type-hints-in-python/happy_programmer_hu_f7b979985975e24b.webp 500w" sizes="(min-width: 35em) 1200px, 100vw"
width="700" height="466"
loading="lazy" decoding="async"&gt;
&lt;/figure&gt;
&lt;h1 id="what-kind-of-type-system"&gt;
What kind of type system?
&lt;a class="heading-link" href="#what-kind-of-type-system"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h1&gt;
&lt;p&gt;Python has gradual type hinting, meaning that whenever for a given function or variable, the type hint is not specified.
We assume that it can have any type (that is, it remains a dynamically typed section). Use this to make your gradually
codebase type-aware, one function, or variable at a time. It is possible to type hint:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;function arguments,&lt;/li&gt;
&lt;li&gt;function return values,&lt;/li&gt;
&lt;li&gt;variables.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;em&gt;Remember only type hinted code is type-checked!&lt;/em&gt; When you run the linter (e.g., mypy) on a type hinted code, you&amp;rsquo;ll get
errors if there are type miss-matches:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c1"&gt;# tests/test_magic_field.py&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;MagicField&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;MagicType&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;DEFAULT&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;names&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;This code will generate the following output:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;bernat@uvm ~/python-magic &lt;span class="o"&gt;(&lt;/span&gt;master●&lt;span class="o"&gt;)&lt;/span&gt;$ mypy --ignore-missing-imports tests/test_magic_field.py
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;tests/test_magic_field.py:21: error: Argument &lt;span class="m"&gt;1&lt;/span&gt; to &lt;span class="s2"&gt;&amp;#34;MagicField&amp;#34;&lt;/span&gt; has incompatible &lt;span class="nb"&gt;type&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;int&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;expected &lt;span class="s2"&gt;&amp;#34;Union[str, bytes]&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;tests/test_magic_field.py:22: error: &lt;span class="s2"&gt;&amp;#34;MagicField&amp;#34;&lt;/span&gt; has no attribute &lt;span class="s2"&gt;&amp;#34;names&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; maybe &lt;span class="s2"&gt;&amp;#34;name&amp;#34;&lt;/span&gt; or &lt;span class="s2"&gt;&amp;#34;_name&amp;#34;&lt;/span&gt;?
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Note we can detect both type incompatibility for the argument passed in and accesses to inexistent attributes on
objects. The latter even suggests valid options available, making it easy to notice and fix typos.&lt;/p&gt;
&lt;h2 id="how-to-add-it"&gt;
How to add it
&lt;a class="heading-link" href="#how-to-add-it"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h2&gt;
&lt;p&gt;Once you decide to add type hints, you&amp;rsquo;ll come to realize that you can add it in more than one way to the codebase.
Let&amp;rsquo;s see what your options are.&lt;/p&gt;
&lt;figure&gt;
&lt;img src="https://bernat.tech/posts/the-state-of-type-hints-in-python/interested.webp" alt="Interested seal"
srcset="https://bernat.tech/posts/the-state-of-type-hints-in-python/interested_hu_911eb9cee3c648cd.webp 500w" sizes="(min-width: 35em) 1200px, 100vw"
width="700" height="532"
loading="lazy" decoding="async"&gt;
&lt;/figure&gt;
&lt;h3 id="1-type-annotations"&gt;
1. Type annotations
&lt;a class="heading-link" href="#1-type-annotations"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;typing&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;List&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;A&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;object&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;elements&lt;/span&gt; &lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;List&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;element&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;elements&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;element&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;em&gt;Type annotations&lt;/em&gt; is the straightforward way and is the one you&amp;rsquo;ll find mostly mentioned on the
&lt;a href="https://docs.python.org/3/library/typing.html" class="external-link" target="_blank" rel="noopener"&gt;typing&lt;/a&gt; documentation. It uses function annotations added to language
via &lt;a href="https://peps.python.org/pep-3107/" class="external-link" target="_blank" rel="noopener"&gt;PEP-3107&lt;/a&gt; (Python &lt;code&gt;3.0+&lt;/code&gt;) and variable annotations via
&lt;a href="https://peps.python.org/pep-0526/" class="external-link" target="_blank" rel="noopener"&gt;PEP-526&lt;/a&gt; (Python &lt;code&gt;3.6+&lt;/code&gt;). These allow you to use the &lt;code&gt;:&lt;/code&gt; syntax to attach
information to variables and function arguments. The &lt;code&gt;-&amp;gt;&lt;/code&gt; operator is used to attach information to the return value of
a function/method.&lt;/p&gt;
&lt;p&gt;The &lt;strong&gt;upside&lt;/strong&gt; of this method is that:&lt;/p&gt;
&lt;!-- raw HTML omitted --&gt;
&lt;ul&gt;
&lt;li&gt;It is the canonical way of doing this, which means it is the cleanest out of them all.&lt;/li&gt;
&lt;li&gt;Because the type of information is attached right alongside the code means you&amp;rsquo;ll have packaged this data out of the
box.
&lt;!-- raw HTML omitted --&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The &lt;strong&gt;downside&lt;/strong&gt; of it is that:&lt;/p&gt;
&lt;!-- raw HTML omitted --&gt;
&lt;ul&gt;
&lt;li&gt;It isn&amp;rsquo;t backward compatible. You need Python &lt;code&gt;3.6&lt;/code&gt; at least to use it.&lt;/li&gt;
&lt;li&gt;It also forces you to import &lt;strong&gt;all&lt;/strong&gt; of your type dependencies, even though they are not used at runtime at all.&lt;/li&gt;
&lt;li&gt;In the type hints, you can have compound types, for example, &lt;code&gt;List[int]&lt;/code&gt;. To construct these complex types, the
interpreter does need to do some operations when first loading this file.
&lt;!-- raw HTML omitted --&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The last two points contradict the initial goal of the type system we enlisted before: handling all type information
basically as a comment during runtime. To resolve some of this contradiction &lt;code&gt;Python 3.7&lt;/code&gt; introduces
&lt;a href="https://peps.python.org/pep-0563/" class="external-link" target="_blank" rel="noopener"&gt;PEP-563 ~ postponed evaluation of annotations&lt;/a&gt;. Once you add the import of:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;__future__&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;annotations&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The interpreter will no longer construct these compound types. Once the interpreter parses the scripts syntax tree, it
identifies type hints and bypasses evaluating it, keeping it as raw strings. This mechanism allows for type hint
interpretation to happen where they need to: by the linter when it runs type checks. Once the mythical &lt;code&gt;Python 4&lt;/code&gt; comes
to life, this mechanism shall be the default behavior.&lt;/p&gt;
&lt;h3 id="2-type-comments"&gt;
2. Type comments
&lt;a class="heading-link" href="#2-type-comments"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h3&gt;
&lt;p&gt;When the annotation syntax is not available, one can use the type comments:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;typing&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;List&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;A&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;object&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="c1"&gt;# type: () -&amp;gt; None&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;elements&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="c1"&gt;# type: List[int]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;element&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="c1"&gt;# type: (List[int]) -&amp;gt; None&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;elements&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;element&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Going down this path, we do get some benefits:&lt;/p&gt;
&lt;!-- raw HTML omitted --&gt;
&lt;ul&gt;
&lt;li&gt;Type comments work under any Python version. Although the typing library has been added to the standard library with
Python &lt;code&gt;3.5+&lt;/code&gt; is available as a PyPi package for Python &lt;code&gt;2.7+&lt;/code&gt;. Moreover, because Python comments is a valid language
feature under virtually any Python code, this allows you to type-hint any codebase at or above Python &lt;code&gt;2.7&lt;/code&gt;. There are
a few requirements: the type hint comment &lt;strong&gt;must&lt;/strong&gt; be on the same or the next line where the function/variable
definition is. It also starts with the &lt;code&gt;type:&lt;/code&gt; constant.&lt;/li&gt;
&lt;li&gt;This solution also has packaging solved because comments are rarely stripped of your code once you stripped it.
Packaging type hint information with your source code allows people using your library to use your type hint
information to improve their developer experience.
&lt;!-- raw HTML omitted --&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;But we also generate some new problems:&lt;/p&gt;
&lt;!-- raw HTML omitted --&gt;
&lt;ul&gt;
&lt;li&gt;The downside is that although the type of information is close to the arguments, it&amp;rsquo;s not right beside it, making the
code a bit messier than otherwise would be. It must also be in a single line, causing issues if you have a long type
of expression, and your codebase enforces line length limits.&lt;/li&gt;
&lt;li&gt;Another problem is that now the type hint information competes with other tools using these types of comment markers
(e.g., suppressing other linter tools errors).&lt;/li&gt;
&lt;li&gt;Besides forcing you to import all of your type information, this leaves you in an even more precarious place. Now the
imported types are only used in the code, which leaves most linter tools to believe all those imports are unused. Were
you to allow them to remove it, and it does break your type linter. Note &lt;code&gt;pylint&lt;/code&gt; fixed this by moving its AST parser
to a &lt;a href="https://github.com/PyCQA/pylint/issues/1063" class="external-link" target="_blank" rel="noopener"&gt;typed-ast parser&lt;/a&gt;, and is going to be released with version 2 just
after Python &lt;code&gt;3.7&lt;/code&gt; comes out.
&lt;!-- raw HTML omitted --&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;To avoid having long lines of code as type hint, it&amp;rsquo;s possible to type hint arguments one by one via type comments, and
then put in the line after only the return type annotation:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;element&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="c1"&gt;# type: List[int]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="c1"&gt;# type: (...) -&amp;gt; None&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;elements&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;element&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Let&amp;rsquo;s have a quick use look at how type comments can make your code messier. Below is a code snippet that swaps out two
properties values inside a class. Fairly trivial:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nd"&gt;@contextmanager&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;swap_in_state&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;state&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;overrides&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;old_config&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;old_overrides&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;state&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;state&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;overrides&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;state&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;state&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;overrides&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;overrides&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;yield&lt;/span&gt; &lt;span class="n"&gt;old_config&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;old_overrides&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;state&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;state&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;overrides&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;old_config&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;old_overrides&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;First, you must add type hints. Because the type hint would be long-winded, you attach type hint argument by argument:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nd"&gt;@contextmanager&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;swap_in_state&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;state&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="c1"&gt;# type: State&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="c1"&gt;# type: HasGetSetMutable&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;overrides&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="c1"&gt;# type: Optional[HasGetSetMutable]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="c1"&gt;# type: (...) -&amp;gt; Generator[Tuple[HasGetSetMutable, Optional[HasGetSetMutable]], None, None]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;old_config&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;old_overrides&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;state&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;state&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;overrides&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;state&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;state&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;overrides&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;overrides&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;yield&lt;/span&gt; &lt;span class="n"&gt;old_config&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;old_overrides&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;state&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;state&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;overrides&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;old_config&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;old_overrides&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;However, wait, you need to import your types used:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;typing&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Generator&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Tuple&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Optional&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Dict&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Union&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;List&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;magic&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;RunSate&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;HasGetSetMutable&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Union&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;Dict&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;List&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nd"&gt;@contextmanager&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;swap_in_state&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;state&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="c1"&gt;# type: State&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="c1"&gt;# type: HasGetSetMutable&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;overrides&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="c1"&gt;# type: Optional[HasGetSetMutable]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="c1"&gt;# type: (...) -&amp;gt; Generator[Tuple[HasGetSetMutable, Optional[HasGetSetMutable]], None, None]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;old_config&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;old_overrides&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;state&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;state&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;overrides&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;state&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;state&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;overrides&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;overrides&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;yield&lt;/span&gt; &lt;span class="n"&gt;old_config&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;old_overrides&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;state&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;state&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;overrides&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;old_config&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;old_overrides&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Now formatting like this, the code causes some false positives in the static linter (e.g. &lt;code&gt;pylint&lt;/code&gt; here), so you add a
few suppress comments for this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;typing&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Generator&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Tuple&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Optional&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Dict&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;List&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;magic&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;RunSate&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;HasGetSetMutable&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Union&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;Dict&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;List&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="c1"&gt;# pylint: disable=invalid-name&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nd"&gt;@contextmanager&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;swap_in_state&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;state&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="c1"&gt;# type: State&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="c1"&gt;# type: HasGetSetMutable&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;overrides&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="c1"&gt;# type: Optional[HasGetSetMutable]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;):&lt;/span&gt; &lt;span class="c1"&gt;# pylint: disable=bad-continuation&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="c1"&gt;# type: (...) -&amp;gt; Generator[Tuple[HasGetSetMutable, Optional[HasGetSetMutable]], None, None]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;old_config&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;old_overrides&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;state&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;state&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;overrides&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;state&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;state&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;overrides&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;overrides&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;yield&lt;/span&gt; &lt;span class="n"&gt;old_config&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;old_overrides&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;state&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;state&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;overrides&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;old_config&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;old_overrides&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Now you&amp;rsquo;re done. Nevertheless, you made your six lines of code sixteen lines long. Yay, more code to maintain!
Increasing your codebase only sounds good if you&amp;rsquo;re getting paid by the number line of code written, and your manager is
complaining you&amp;rsquo;re not performing well enough.&lt;/p&gt;
&lt;h3 id="3-interface-stub-files"&gt;
3. Interface stub files
&lt;a class="heading-link" href="#3-interface-stub-files"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h3&gt;
&lt;p&gt;This option allows you to keep your code as it is:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;A&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;object&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;elements&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;element&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;elements&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;element&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;and instead, add another file with &lt;code&gt;pyi&lt;/code&gt; extension right beside it:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c1"&gt;# a.pyi alongside a.py&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;typing&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;List&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;A&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;object&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;elements&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;...&lt;/span&gt; &lt;span class="c1"&gt;# type: List[int]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="o"&gt;...&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;element&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="o"&gt;...&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Interface files are not a new thing; C/C++ had it for decades now. Because Python is an interpreted language, it does
not need it usually, however as every problem in computer science can be solved by adding a new level of indirection, we
can add it to store the type of information.&lt;/p&gt;
&lt;p&gt;The upside of this is that:&lt;/p&gt;
&lt;!-- raw HTML omitted --&gt;
&lt;ul&gt;
&lt;li&gt;You don&amp;rsquo;t need to modify the source code; works under any Python version as the interpreter never touches these.&lt;/li&gt;
&lt;li&gt;Inside the stub files, you can use the latest syntax (e.g., type annotations) because these are never looked at during
your application&amp;rsquo;s execution. Because you do not touch your source code, you cannot introduce bugs by adding type
hints, nor can you add conflict with other linter tools.&lt;/li&gt;
&lt;li&gt;It is a well-tested design; the &lt;a href="https://github.com/python/typeshed" class="external-link" target="_blank" rel="noopener"&gt;&lt;code&gt;typeshed&lt;/code&gt;&lt;/a&gt; project uses it to type hint the
entire standard library, plus some other popular libraries such as &lt;code&gt;requests&lt;/code&gt;, &lt;code&gt;yaml&lt;/code&gt;, &lt;code&gt;dateutil&lt;/code&gt; and
&lt;a href="https://github.com/python/typeshed/tree/master/stubs/" class="external-link" target="_blank" rel="noopener"&gt;so on&lt;/a&gt;. It can provide type information for source code that
you do not own or cannot change easily.
&lt;!-- raw HTML omitted --&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Now there are also some hefty penalties to pay:&lt;/p&gt;
&lt;!-- raw HTML omitted --&gt;
&lt;ul&gt;
&lt;li&gt;You just duplicated your codebase, as every function now has two definitions (note you don&amp;rsquo;t need to replicate your
body or default arguments, the &lt;code&gt;...&lt;/code&gt; - ellipsis - is used as a placeholder for these).&lt;/li&gt;
&lt;li&gt;Now, you have some extra files that need to be packaged and shipped with your code.&lt;/li&gt;
&lt;li&gt;It&amp;rsquo;s impossible to annotate contents inside functions (this means both methods inside methods and local variables).&lt;/li&gt;
&lt;li&gt;There is no check that your implementation file matches your stub&amp;rsquo;s signature (furthermore, IDEs always use the stub
definition).&lt;/li&gt;
&lt;li&gt;However, the heaviest penalty is that you cannot type check the code you&amp;rsquo;re type hinting via a stub. Stub file type
hints were designed to be used to type-check code that uses the library. But not too type check the codebase itself
what your type hinting.&lt;/li&gt;
&lt;/ul&gt;
&lt;!-- raw HTML omitted --&gt;
&lt;p&gt;The last two drawback makes it incredibly hard to check that the type hinted codebase via a stub file is in sync or not.
In this current form, type stubs are a way to provide type hints to your users, but not for yourself, and are incredibly
hard to maintain. To fix these, I&amp;rsquo;ve taken up the task of merging stub files with source files inside mypy; in theory,
fix both problems - you can follow on its progress under
&lt;a href="https://github.com/python/mypy/issues/5028" class="external-link" target="_blank" rel="noopener"&gt;python/mypy ~ issue 5208&lt;/a&gt;.&lt;/p&gt;
&lt;h3 id="4-docstrings"&gt;
4. Docstrings
&lt;a class="heading-link" href="#4-docstrings"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h3&gt;
&lt;p&gt;It is possible to add type information into docstrings too. Even though this is not part of Python&amp;rsquo;s type-hint
framework, it is supported by most mainstream IDEs. They are mostly the legacy way of doing this.&lt;/p&gt;
&lt;p&gt;On the plus side:&lt;/p&gt;
&lt;!-- raw HTML omitted --&gt;
&lt;ul&gt;
&lt;li&gt;Works under any Python version. It was defined back in &lt;a href="https://peps.python.org/pep-0257/" class="external-link" target="_blank" rel="noopener"&gt;PEP-257&lt;/a&gt;. It does not clash
with other linter tools, as most of these do not check the docstrings but usually resume just inspecting the other
code sections instead.
&lt;!-- raw HTML omitted --&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;However, it has serious flaws in the form of:&lt;/p&gt;
&lt;!-- raw HTML omitted --&gt;
&lt;ul&gt;
&lt;li&gt;There is no standard way to specify complex type hints (for example, either &lt;code&gt;int&lt;/code&gt; or &lt;code&gt;bool&lt;/code&gt;). PyCharm has
&lt;a href="https://www.jetbrains.com/help/pycharm/type-hinting-in-product.html#legacy" class="external-link" target="_blank" rel="noopener"&gt;it&amp;rsquo;s the proprietary way&lt;/a&gt; but Sphinx, for
example, uses a different method. T- Docstring types do not clash with other linter tools.&lt;/li&gt;
&lt;li&gt;Requires changing the documentation, and it is hard to keep accurate/up to date as there is no tool to check it&amp;rsquo;s
validity.&lt;/li&gt;
&lt;li&gt;Docstring types do not play well with type hinted code. If both type annotations and docstrings are specified, which
takes precedence over which?
&lt;!-- raw HTML omitted --&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="what-to-add"&gt;
What to add?
&lt;a class="heading-link" href="#what-to-add"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h2&gt;
&lt;figure&gt;
&lt;img src="https://bernat.tech/posts/the-state-of-type-hints-in-python/deep_dive.webp" alt="Seal diving deep"
srcset="https://bernat.tech/posts/the-state-of-type-hints-in-python/deep_dive_hu_d391ef35a52d4dab.webp 500w" sizes="(min-width: 35em) 1200px, 100vw"
width="700" height="467"
loading="lazy" decoding="async"&gt;
&lt;/figure&gt;
&lt;p&gt;Let&amp;rsquo;s dive into the specifics, though. For an exhaustive list of what type of information you can add, please see the
&lt;a href="https://docs.python.org/3/library/typing.html" class="external-link" target="_blank" rel="noopener"&gt;official documentation&lt;/a&gt;. Here I&amp;rsquo;ll do a quick 3-minute overview for you
to get the idea of it. There are two types of type categories: nominal types and duck types (protocols).&lt;/p&gt;
&lt;h3 id="1-nominal-type"&gt;
1. Nominal type
&lt;a class="heading-link" href="#1-nominal-type"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h3&gt;
&lt;p&gt;Nominal types are types that have a name to it within the Python interpreter. For example all builtin types (&lt;code&gt;int&lt;/code&gt;,
&lt;code&gt;boolean&lt;/code&gt;, &lt;code&gt;float&lt;/code&gt;, &lt;code&gt;type&lt;/code&gt;, &lt;code&gt;object&lt;/code&gt; etc). Then we have the generic types which mostly manifest in form of the
containers:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;t&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Tuple&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;float&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mf"&gt;1.2&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;d&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Dict&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;a&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;b&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;d&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;MutableMapping&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;a&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;b&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;l&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;List&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Iterable&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;Text&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;1&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;2&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;3&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;For compound types, it can become cumbersome to keep writing it again and again, so the system allows you to alias
types, via:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;OptFList&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Optional&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;List&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;float&lt;/span&gt;&lt;span class="p"&gt;]]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;One can even elevate builtin types to represent their own type, which can be useful to avoid errors where for example
you pass in two arguments with the same type in the wrong order to a function:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;UserId&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;NewType&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;UserId&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;user_id&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;UserId&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;524313&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;count&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;call_with_user_id_n_times&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;user_id&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;count&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;For &lt;code&gt;namedtuple&lt;/code&gt; you can attach your type information directly (note the strong resemblance to a
&lt;a href="https://peps.python.org/pep-0557/" class="external-link" target="_blank" rel="noopener"&gt;data class&lt;/a&gt; from Python &lt;code&gt;3.7+&lt;/code&gt; or the great
&lt;a href="https://github.com/python-attrs/attrs" class="external-link" target="_blank" rel="noopener"&gt;&lt;code&gt;attrs&lt;/code&gt; library&lt;/a&gt;):&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Employee&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;NamedTuple&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;str&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="nb"&gt;id&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;You have the composing types of &lt;em&gt;one of&lt;/em&gt; and &lt;em&gt;optional of&lt;/em&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;Union&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="c1"&gt;# one of&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;Optional&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;float&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="c1"&gt;# either None or float&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;You can even type hint your callback functions:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c1"&gt;# syntax is Callable[[Arg1Type, Arg2Type], ReturnType]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;feeder&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;get_next_item&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Callable&lt;/span&gt;&lt;span class="p"&gt;[[],&lt;/span&gt; &lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;One can define it&amp;rsquo;s own generic containers by using the &lt;code&gt;TypeVar&lt;/code&gt; construction:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;T&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;TypeVar&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;T&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Magic&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Generic&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;T&lt;/span&gt;&lt;span class="p"&gt;]):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;value&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;T&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;value&lt;/span&gt; &lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;T&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;value&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;square_values&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;vars&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Iterable&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;Magic&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;]])&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;v&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;value&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;v&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;value&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="n"&gt;v&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;value&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Finally, disable type checking wherever it&amp;rsquo;s not needed by using the &lt;code&gt;Any&lt;/code&gt; type hint:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;foo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;item&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Any&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;item&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;bar&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="2-duck-types---protocols"&gt;
2. Duck types - protocols
&lt;a class="heading-link" href="#2-duck-types---protocols"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h3&gt;
&lt;p&gt;In this case, instead of having an actual type, one can be more Pythonic and go with the theorem that if it quacks like
a duck, and acts like a duck, then most definitely for all intended purposes, it is a duck. In this case, you define
what operations and attributes you expect on objects instead of explicitly stating their types. The grounds of this were
laid down in &lt;a href="https://peps.python.org/pep-0544/" class="external-link" target="_blank" rel="noopener"&gt;PEP-544 ~ Protocols&lt;/a&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;KEY&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;TypeVar&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;KEY&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;contravariant&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;true&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c1"&gt;# this is a protocol having a generic type as an argument&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c1"&gt;# it has a class variable of type var, and a getter with the same key type&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;MagicGetter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Protocol&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;KEY&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="n"&gt;Sized&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;var&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;KEY&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="fm"&gt;__getitem__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;item&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;KEY&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="o"&gt;...&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;func_int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;param&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;MagicGetter&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;param&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;a&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;func_str&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;param&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;MagicGetter&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;&lt;/span&gt;&lt;span class="si"&gt;{}&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;param&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;a&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h1 id="gotchas"&gt;
Gotchas
&lt;a class="heading-link" href="#gotchas"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h1&gt;
&lt;p&gt;Once you start adding type hints to a codebase, watch out that sometimes you may experience some oddities. During these
moments, you might have the *what the hell** expression of the following seal:&lt;/p&gt;
&lt;figure&gt;
&lt;img src="https://bernat.tech/posts/the-state-of-type-hints-in-python/gotcha.webp" alt="Confused seal"
srcset="https://bernat.tech/posts/the-state-of-type-hints-in-python/gotcha_hu_36e0e0742c89d325.webp 500w" sizes="(min-width: 35em) 1200px, 100vw"
width="700" height="408"
loading="lazy" decoding="async"&gt;
&lt;/figure&gt;
&lt;p&gt;In this section, I&amp;rsquo;ll try to present a few of these to give you a heads up on what kind of oddities you may run into
while adding type information to your codebase.&lt;/p&gt;
&lt;h3 id="1-str-difference-in-between-python-23"&gt;
1. str difference in between Python 2/3
&lt;a class="heading-link" href="#1-str-difference-in-between-python-23"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h3&gt;
&lt;p&gt;Here&amp;rsquo;s a quick implementation of the &lt;code&gt;repr&lt;/code&gt; dunder method for a class:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;__future__&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;unicode_literals&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;A&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;object&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="fm"&gt;__repr__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;A(&lt;/span&gt;&lt;span class="si"&gt;{}&lt;/span&gt;&lt;span class="s2"&gt;)&amp;#34;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;full_name&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;This code has a bug in it. While this is correct under Python 3, it is not under Python 2 (because Python 2 expects to
return &lt;code&gt;bytes&lt;/code&gt; from &lt;code&gt;repr&lt;/code&gt;. However, the &lt;code&gt;unicode_literals&lt;/code&gt; import makes the returned value of type &lt;code&gt;unicode&lt;/code&gt;). Having
the from future import in place means it&amp;rsquo;s not possible to write a &lt;code&gt;repr&lt;/code&gt; that satisfies the type requirements for both
Python 2 and 3. You need to add runtime logic to do the right thing:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;__future__&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;unicode_literals&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;A&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;object&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="fm"&gt;__repr__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;res&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;A(&lt;/span&gt;&lt;span class="si"&gt;{}&lt;/span&gt;&lt;span class="s2"&gt;)&amp;#34;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;full_name&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;version_info&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="c1"&gt;# noinspection PyTypeChecker&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;res&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="c1"&gt;# noinspection PyTypeChecker&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;res&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;encode&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;utf-8&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;To fight the IDE to accept this form, you need to add a few linter comments, making this code ever so complicated to
read. More importantly, now you have an extra runtime check forced to your type checker.&lt;/p&gt;
&lt;h3 id="2-multiple-return-types"&gt;
2. Multiple return types
&lt;a class="heading-link" href="#2-multiple-return-types"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h3&gt;
&lt;p&gt;Imagine you want to write a function that multiplies either a string or an int by two. The first take on this would be:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;magic&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Union&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;Union&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;]:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Your input is either &lt;code&gt;str&lt;/code&gt; or &lt;code&gt;int&lt;/code&gt;, and your return value accordingly is also either &lt;code&gt;str&lt;/code&gt; or &lt;code&gt;int&lt;/code&gt;. However, if you do
it like so, you&amp;rsquo;re telling the type hint that it really can be either of for both types of inputs. Therefore on the call
side, you need to assert the type your calling with:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;other_func&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;result&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;magic&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;assert&lt;/span&gt; &lt;span class="nb"&gt;isinstance&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;result&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;result&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;This inconvenience may determine some people to avoid the call side hassle by making the return value &lt;code&gt;Any&lt;/code&gt;. However,
there&amp;rsquo;s a better solution. The type hint system allows you to define overloads. Overloads express that for a given input
type, and only a given output type is returned. So, in this case:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;typing&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;overload&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nd"&gt;@overload&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;magic&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;pass&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nd"&gt;@overload&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;magic&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;pass&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;magic&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Union&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;Union&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;]:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;other_func&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;result&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;magic&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;result&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;There is a downside to this, though. Now your static linter tool is complaining that you&amp;rsquo;re redefining functions with
the the same name; this is a false positive so add the static linter disable comment mark
(&lt;code&gt;# pylint: disable=function-redefined&lt;/code&gt; ).&lt;/p&gt;
&lt;h3 id="3-type-lookup"&gt;
3. Type lookup
&lt;a class="heading-link" href="#3-type-lookup"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h3&gt;
&lt;p&gt;Imagine you have a class that allows representing the contained data as multiple types or that has fields of the
different type. You want the user to have a quick and easy way to refer to them, so you add a function, having a
built-in types name:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;A&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;object&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;float&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="c1"&gt;# type: () -&amp;gt; float&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="mf"&gt;1.0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Once you run the linter, you&amp;rsquo;ll see:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;test.py:3: error: Invalid &lt;span class="nb"&gt;type&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;test.A.float&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;One might ask, at this point, what the hell? I&amp;rsquo;ve defined the return value as &lt;code&gt;float&lt;/code&gt;, not as &lt;code&gt;test.A.float&lt;/code&gt;. This
obscure error is that the type hinter resolves types by evaluating each scope outbound from the definition location.
Once it finds a name match, it stops. The first level where it looks is within &lt;code&gt;class A&lt;/code&gt; where it finds a &lt;code&gt;float&lt;/code&gt; (a
function that is) and substitutes that float in.&lt;/p&gt;
&lt;p&gt;Now the solution to not run into this issue is to explicitly define that we don&amp;rsquo;t just want any &lt;code&gt;float&lt;/code&gt;, but that we
want the &lt;code&gt;builtin.float&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;typing&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;TYPE_CHECKING&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;builtins&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;A&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;object&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;float&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="c1"&gt;# type: () -&amp;gt; builtins.float&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="mf"&gt;1.0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Note that to do this, you also need to import &lt;code&gt;builtins&lt;/code&gt;, and to avoid this causing issues at runtime, you can guard it
with the &lt;code&gt;typing.TYPE_CHECKING&lt;/code&gt; flag, which is true only during the type linter evaluation, always false otherwise.&lt;/p&gt;
&lt;h3 id="4-contra-variant-argument"&gt;
4. Contra-variant argument
&lt;a class="heading-link" href="#4-contra-variant-argument"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h3&gt;
&lt;p&gt;Examine the following use case. You define an abstract base class that contains everyday operations. Then you have
specific classes that handle one type and one type only. You control the creation of the classes, which ensures the
correct type is passed, and the base is abstract, so this seems an agreeable design:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;abc&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;ABCMeta&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;abstractmethod&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;typing&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Union&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;A&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;metaclass&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;ABCMeta&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="nd"&gt;@abstractmethod&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;func&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;key&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt; &lt;span class="c1"&gt;# type: (Union[int, str]) -&amp;gt; str&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;raise&lt;/span&gt; &lt;span class="ne"&gt;NotImplementedError&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;B&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;func&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;key&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt; &lt;span class="c1"&gt;# type: (int) -&amp;gt; str&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;key&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;C&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;func&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;key&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt; &lt;span class="c1"&gt;# type: (str) -&amp;gt; str&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;key&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;However, once you run a type linter check on this, you&amp;rsquo;ll find:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;test.py:12: error: Argument &lt;span class="m"&gt;1&lt;/span&gt; of &lt;span class="s2"&gt;&amp;#34;func&amp;#34;&lt;/span&gt; incompatible with supertype &lt;span class="s2"&gt;&amp;#34;A&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;test.py:17: error: Argument &lt;span class="m"&gt;1&lt;/span&gt; of &lt;span class="s2"&gt;&amp;#34;func&amp;#34;&lt;/span&gt; incompatible with supertype &lt;span class="s2"&gt;&amp;#34;A&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The reason for this is that arguments to classes are contra-variant. This translates in on scientific terms in your
derived class you &lt;strong&gt;must&lt;/strong&gt; handle all types from your parents. However, you may add additional types too. That is even
in the function arguments; you can only extend what you cover, but not to constrain it in any way:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;abc&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;ABCMeta&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;abstractmethod&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;typing&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Union&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;A&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;metaclass&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;ABCMeta&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="nd"&gt;@abstractmethod&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;func&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;key&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt; &lt;span class="c1"&gt;# type: (Union[int, str]) -&amp;gt; str&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;raise&lt;/span&gt; &lt;span class="ne"&gt;NotImplementedError&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;B&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;func&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;key&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt; &lt;span class="c1"&gt;# type: (Union[int, str, bool]) -&amp;gt; str&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;key&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;C&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;func&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;key&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt; &lt;span class="c1"&gt;# type: (Union[int, str, List]) -&amp;gt; str&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;key&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="5-compatibility"&gt;
5. Compatibility
&lt;a class="heading-link" href="#5-compatibility"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h3&gt;
&lt;p&gt;See if you can spot the error in the following code snippet:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;A&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="nd"&gt;@classmethod&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;magic&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;cls&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;A&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="bp"&gt;cls&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;B&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="nd"&gt;@classmethod&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;magic&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;cls&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;b&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;bool&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;B&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="bp"&gt;cls&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;If you did not manage yet, consider what will happen if you write the following script:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;typing&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;List&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Type&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;elements&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;List&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;Type&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="p"&gt;]]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;B&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;([&lt;/span&gt;&lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;magic&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;elements&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Were you to try to run it this would fail with the following runtime error:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;magic&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;elements&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="ne"&gt;TypeError&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;magic&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="n"&gt;missing&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt; &lt;span class="n"&gt;required&lt;/span&gt; &lt;span class="n"&gt;positional&lt;/span&gt; &lt;span class="n"&gt;argument&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;b&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The reason being that &lt;code&gt;B&lt;/code&gt; is a subtype of &lt;code&gt;A&lt;/code&gt;. Therefore it can go into a container of &lt;code&gt;A&lt;/code&gt; types (because it extends it
to do more than &lt;code&gt;A&lt;/code&gt;). However, the class method definition for &lt;code&gt;B&lt;/code&gt; breaks this contract, it can no longer call magic
with just one argument. Moreover, the type linter would fail to point out only this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;test.py:9: error: Signature of &lt;span class="s2"&gt;&amp;#34;magic&amp;#34;&lt;/span&gt; incompatible with supertype &lt;span class="s2"&gt;&amp;#34;A&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;A quick and easy fix for this is to make sure &lt;code&gt;B.magic&lt;/code&gt; does work with one argument by making the second optional for
example. Now take what we learned to take a look at the following:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;A&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;pass&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;B&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;b&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;bool&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="nb"&gt;super&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;What do you think will happen here? Note we moved class methods into constructors and made no other change, so our the
script also needs just a slight modification:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;typing&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;List&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Type&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;elements&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;List&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;Type&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="p"&gt;]]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;B&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;([&lt;/span&gt;&lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;elements&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Here&amp;rsquo;s the runtime error, being mostly the same, just now complaining about &lt;code&gt;__init__&lt;/code&gt; instead of &lt;code&gt;magic&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;print&lt;span class="o"&gt;(&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;e&lt;span class="o"&gt;(&lt;/span&gt;1&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; e in elements&lt;span class="o"&gt;])&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;TypeError: __init__&lt;span class="o"&gt;()&lt;/span&gt; missing &lt;span class="m"&gt;1&lt;/span&gt; required positional argument: &lt;span class="s1"&gt;&amp;#39;b&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;So what do you think mypy will say? Were you to run it; you&amp;rsquo;ll find that mypy chooses to stay silent. Yes, it will mark
this as correct, even though at runtime, it fails. The mypy creators said that they found &lt;em&gt;too common of type miss-match
to prohibit incompatible &lt;code&gt;__init__&lt;/code&gt; and &lt;code&gt;__new__&lt;/code&gt;&lt;/em&gt;.&lt;/p&gt;
&lt;h2 id="when-you-hit-the-wall"&gt;
When you hit the wall
&lt;a class="heading-link" href="#when-you-hit-the-wall"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h2&gt;
&lt;p&gt;So, in conclusion, watch out. Type hints sometimes cause strange warnings, which brings out the following feelings
summarized in a tweet:&lt;/p&gt;
&lt;figure&gt;
&lt;img src="https://bernat.tech/posts/the-state-of-type-hints-in-python/david.webp" alt="Frustrated tweet about type hints"
srcset="https://bernat.tech/posts/the-state-of-type-hints-in-python/david_hu_ee85eb4f11166eb9.webp 500w" sizes="(min-width: 35em) 1200px, 100vw"
width="700" height="448"
loading="lazy" decoding="async"&gt;
&lt;/figure&gt;
&lt;p&gt;Remember you have some tools at hand that help you discover, understand and perhaps handle these edge cases:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;use &lt;code&gt;reveal_type&lt;/code&gt; to see inferred type
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;a&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;reveal_type&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;# -&amp;gt; error: Revealed type is &amp;#39;builtins.list[builtins.int*]&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;use &lt;code&gt;cast&lt;/code&gt; to force a given type:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;typing&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;List&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;cast&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;a&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;b&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;cast&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;List&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;# passes fine&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;c&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;cast&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;List&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;# type: List[str] # passes fine (no runtime check)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;reveal_type&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;c&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;# -&amp;gt; error: Revealed type is &amp;#39;builtins.list[builtins.str]&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;use the type ignore marker to disable an error in a line:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;confusing_function&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="c1"&gt;# type: ignore # see mypy/issues/1167&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;ask the community; expose a minimal reproducible version of the problem under the
&lt;a href="https://gitter.im/python/typing" class="external-link" target="_blank" rel="noopener"&gt;python/typing&lt;/a&gt; &lt;code&gt;Gitter&lt;/code&gt; chat.&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id="tools"&gt;
Tools
&lt;a class="heading-link" href="#tools"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h1&gt;
&lt;p&gt;Here&amp;rsquo;s a non-exhaustive list of tools built around the type hint system.&lt;/p&gt;
&lt;h2 id="type-checkers"&gt;
type checkers
&lt;a class="heading-link" href="#type-checkers"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h2&gt;
&lt;p&gt;Use these tools to check against type safety inside your library or application:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href="http://mypy-lang.org/" class="external-link" target="_blank" rel="noopener"&gt;&lt;code&gt;mypy&lt;/code&gt; - Python&lt;/a&gt; (the reference type linting tool)&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/facebook/pyre-check" class="external-link" target="_blank" rel="noopener"&gt;&lt;code&gt;pyre&lt;/code&gt; - Facebook&lt;/a&gt; - Python 3 only, but faster than mypy. An interesting use
case of this is the ability to do taint/security code analysis with it - see
&lt;a href="https://www.youtube.com/watch?v=hWV8t494N88" class="external-link" target="_blank" rel="noopener"&gt;Pieter Hooimeijer - Types, Deeper Static Analysis, and you&lt;/a&gt;.&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/google/pytype" class="external-link" target="_blank" rel="noopener"&gt;&lt;code&gt;pytype&lt;/code&gt; - Google&lt;/a&gt;.&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id="type-annotation-generators"&gt;
type annotation generators
&lt;a class="heading-link" href="#type-annotation-generators"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h2&gt;
&lt;p&gt;When you want to add type annotations to an existing codebase, use these to automate the boring part:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code&gt;mypy stubgen&lt;/code&gt; command line (&lt;a href="https://github.com/python/mypy/blob/master/mypy/stubgen.py" class="external-link" target="_blank" rel="noopener"&gt;see&lt;/a&gt;)&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/dropbox/pyannotate" class="external-link" target="_blank" rel="noopener"&gt;&lt;code&gt;pyannotate&lt;/code&gt; - Dropbox&lt;/a&gt; - use your tests to generate type information.&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/Instagram/MonkeyType" class="external-link" target="_blank" rel="noopener"&gt;&lt;code&gt;monkeytype&lt;/code&gt; - Instagram&lt;/a&gt;. Fun fact: Instagram uses to run it in their
production system: it&amp;rsquo;s triggered once for every million cal (makes the code run five times slower, but once every
million calls makes it not that noticeable).&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id="runtime-code-evaluator"&gt;
runtime code evaluator
&lt;a class="heading-link" href="#runtime-code-evaluator"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h2&gt;
&lt;p&gt;Use these tools to check at runtime if the input arguments to your function/method are of the correct type or not:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href="https://github.com/samuelcolvin/pydantic" class="external-link" target="_blank" rel="noopener"&gt;&lt;code&gt;pydantic&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/RussBaz/enforce" class="external-link" target="_blank" rel="noopener"&gt;&lt;code&gt;enforce&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/Stewori/pytypes" class="external-link" target="_blank" rel="noopener"&gt;&lt;code&gt;pytypes&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id="documentation-enrichment---merge-docstrings-and-type-hints"&gt;
Documentation enrichment - merge docstrings and type hints
&lt;a class="heading-link" href="#documentation-enrichment---merge-docstrings-and-type-hints"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h2&gt;
&lt;p&gt;In the first part of this blog article, we mentioned that historically people have already stored type information
inside docstrings. This is because your type of data is part of your contract. You do want to have type information for
your library inside the documentation. So the question remains, given that you did not choose to use docstrings as the
primary type of information storage system, how can you still have them in the docstrings for your documentation?&lt;/p&gt;
&lt;p&gt;The answer varies depending on the tool you&amp;rsquo;re using to generate that documentation. However, I&amp;rsquo;m going to present here
an option by using the most popular tool and format in Python: Sphinx and HTML.&lt;/p&gt;
&lt;p&gt;Having type information explicitly stated in both the type hints and the docstring is the sure way of eventually having
conflicts between them. You can count on someone at some point is going to update in one place but not in the other.
Therefore let&amp;rsquo;s strip all type data from the docstring and have it only as type hints. Now, all we need to do is at
documentation build time, fetch it from the type hints and insert it into the documentation.&lt;/p&gt;
&lt;p&gt;In Sphinx, you can achieve this by having a plugin. The most popular already made version of this is
&lt;a href="https://github.com/agronholm/sphinx-autodoc-typehints" class="external-link" target="_blank" rel="noopener"&gt;&lt;code&gt;agronholm/sphinx-autodoc-typehints&lt;/code&gt;&lt;/a&gt;. This tool does two
things:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;first, for each function/variable to be documented, it fetches the type hint information;&lt;/li&gt;
&lt;li&gt;then, it transforms the Python types into a docstring representation (this involves recursively unwrapping all the
nested type classes, and replacing the type with its string representation);&lt;/li&gt;
&lt;li&gt;finally, appending to the correct parameter into the docstring.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;For example &lt;code&gt;Any&lt;/code&gt; maps to &lt;code&gt;py:data:`~typing.Any`&lt;/code&gt;. Things can get even more complicated for compound types such as
&lt;code&gt;Mapping[str, bool]&lt;/code&gt; needs to be translated for example too
&lt;code&gt;:class:`~typing.Mapping`\\[:class:`str`, :class:`bool`]&lt;/code&gt;. Getting the translation here right (e.g. having &lt;code&gt;class&lt;/code&gt;
or &lt;code&gt;data&lt;/code&gt; namespace) is essential so that the &lt;code&gt;intersphinx&lt;/code&gt; plugin will work correctly (a plugin that links types
directly to their respective Python standard library documentation link).&lt;/p&gt;
&lt;p&gt;In order to use it one needs to install it via &lt;code&gt;pip install sphinx-autodoc-types&amp;gt;=2.1.1&lt;/code&gt; and then enable in inside the
&lt;code&gt;conf.py&lt;/code&gt; file:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c1"&gt;# conf.py&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;extensions&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;sphinx_autodoc_typehints&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;That&amp;rsquo;s it all. An example use case of this is &lt;a href="https://github.com/RookieGameDevs/revived" class="external-link" target="_blank" rel="noopener"&gt;RookieGameDevs/revived&lt;/a&gt;
documentation. For example, given the following source code:&lt;/p&gt;
&lt;figure&gt;
&lt;img src="https://bernat.tech/posts/the-state-of-type-hints-in-python/sphinx_doc_src.webp" alt="Sphinx documentation source code"
srcset="https://bernat.tech/posts/the-state-of-type-hints-in-python/sphinx_doc_src_hu_76bc09199564bbeb.webp 500w, https://bernat.tech/posts/the-state-of-type-hints-in-python/sphinx_doc_src_hu_9701ca0e9a360ff0.webp 800w" sizes="(min-width: 35em) 1200px, 100vw"
width="800" height="428"
loading="lazy" decoding="async"&gt;
&lt;/figure&gt;
&lt;p&gt;You can get the following output:&lt;/p&gt;
&lt;figure&gt;
&lt;img src="https://bernat.tech/posts/the-state-of-type-hints-in-python/sphinx_doc.webp" alt="Sphinx documentation output"
srcset="https://bernat.tech/posts/the-state-of-type-hints-in-python/sphinx_doc_hu_9b06b72eb02fae21.webp 500w, https://bernat.tech/posts/the-state-of-type-hints-in-python/sphinx_doc_hu_98d291f2ffb9559e.webp 800w" sizes="(min-width: 35em) 1200px, 100vw"
width="800" height="425"
loading="lazy" decoding="async"&gt;
&lt;/figure&gt;
&lt;h1 id="conclusion"&gt;
Conclusion
&lt;a class="heading-link" href="#conclusion"&gt;
&lt;i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"&gt;&lt;/i&gt;
&lt;span class="sr-only"&gt;Link to heading&lt;/span&gt;
&lt;/a&gt;
&lt;/h1&gt;
&lt;p&gt;So at the end of this long blog post, you may ask: is it worth using type hints, or when should one use them? I think
type hinting is at the end of the day virtually the same as your unit tests, just expressed differently in code. They
provide a standard (and re-usable for other goals) way to test the input and output types of your codebase.&lt;/p&gt;
&lt;p&gt;Therefore, type hints &lt;strong&gt;should be used whenever the unit test is worth writing.&lt;/strong&gt; This can be even just ten lines of
code if you need to maintain it later. Similarly, you should start adding type hints whenever you start writing unit
tests. The only place when I would not add them is when I don&amp;rsquo;t write unit tests, such REPL lines, or throw away
one-time usage scripts.&lt;/p&gt;
&lt;p&gt;Remember that, similar to unit tests, while it does makes your codebase contain an extra number of lines, at the end of
the day, all the code you add is code that is automatically checked and enforced to be correct. It acts as a safety net
to ensure that things keep working when you change things around later on, so probably worth paying this extra cost.&lt;/p&gt;
&lt;figure&gt;
&lt;img src="https://bernat.tech/posts/the-state-of-type-hints-in-python/thats_all_folks.webp" alt="Seal waving goodbye"
srcset="https://bernat.tech/posts/the-state-of-type-hints-in-python/thats_all_folks_hu_2dff252a02830b01.webp 500w" sizes="(min-width: 35em) 1200px, 100vw"
width="700" height="467"
loading="lazy" decoding="async"&gt;
&lt;/figure&gt;</description><category>mypy</category><category>python</category><category>types</category><category>type-hint</category></item></channel></rss>