<!doctype html><html lang=en><head><title>The state of type hints in Python · Tech articles by Bernát Gábor</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Bernát Gábor"><meta name=description content="How to use typing in Python via mypy"><meta name=keywords content="blog,developer,personal,python,packaging"><meta name=twitter:card content="summary"><meta name=twitter:title content="The state of type hints in Python"><meta name=twitter:description content="How to use typing in Python via mypy"><meta property="og:title" content="The state of type hints in Python"><meta property="og:description" content="How to use typing in Python via mypy"><meta property="og:type" content="article"><meta property="og:url" content="https://bernat.tech/posts/the-state-of-type-hints-in-python/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-05-30T09:51:55+00:00"><meta property="article:modified_time" content="2022-06-04T10:36:09+01:00"><link rel=canonical href=https://bernat.tech/posts/the-state-of-type-hints-in-python/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.c4d7e93a158eda5a65b3df343745d2092a0a1e2170feeec909b8a89443903c6a.css integrity="sha256-xNfpOhWO2lpls980N0XSCSoKHiFw/u7JCbiolEOQPGo=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.78b5fe3864945faf5207fb8fe3ab2320d49c3365def0e88ac1df0ddadc54a03c.css integrity="sha256-eLX+OGSUX69SB/uP46sjINScM2Xe8OiKwd8N2txUoDw=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/custom.min.6082c0515eae1732c35248ff50ce1f958fdc3f006b8c7abc91c15ce78b2e0fe4.css integrity="sha256-YILAUV6uFzLDUkj/UM4flY/cPwBrjHq8kcFc54suD+Q=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/syntax.min.5ef6ece76ad413dd701da34ae4be6e9509707d3a12eb90066e18abb1c9f96dd3.css integrity="sha256-Xvbs52rUE91wHaNK5L5ulQlwfToS65AGbhirscn5bdM=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/img/android-chrome-192x192.png sizes=32x32><link rel=icon type=image/png href=/img/android-chrome-192x192.png sizes=16x16><link rel=apple-touch-icon href=/img/android-chrome-192x192.png><link rel=apple-touch-icon sizes=180x180 href=/img/android-chrome-192x192.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.115.4"></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Tech articles by Bernát Gábor</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts>Blog</a></li><li class=navigation-item><a class=navigation-link href=/about>About</a></li><li class=navigation-item><a class=navigation-link href=/presentations>Presentations</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://bernat.tech/posts/the-state-of-type-hints-in-python/>The state of type hints in Python</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2018-05-30T09:51:55Z>2018-05-05</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
28-minute read</span></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/mypy/>mypy</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tags/python/>python</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tags/types/>types</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tags/type-hint/>type-hint</a></span></div></div></header><div><p>One of the main selling points for Python is that it is dynamically-typed. There is no plan to change this.
Nevertheless, in September 2014 <a href=https://twitter.com/gvanrossum>Guido van Rossum</a> (Python
<a href=https://en.wikipedia.org/wiki/Benevolent_dictator_for_life>BDFL</a>) created a python enhancement proposal
(<a href=https://www.python.org/dev/peps/pep-0484>PEP-484</a>) to add type hints to Python. It has been released for general
usage a year later, in September 2015, as part of Python <code>3.5.0</code>.
<a href=http://python-history.blogspot.com/2009/01/brief-timeline-of-python.html>Twenty-five years into its existence</a> now
there was a standard way to add type information to Python code. In this blog post, I&rsquo;ll explore how the system matured,
how you can use it, and what&rsquo;s next for type hints.</p><p>Disclaimer: throughout this blog post, you&rsquo;ll see many seals and penguin pictures. The reason for this is mostly my
admiration for these animals, and hey, nothing like some cute animals to help digest some tricky topics, not?</p><h1 id=why-do-we-need-this>Why do we need this?
<a class=heading-link href=#why-do-we-need-this><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><figure><img src=why.webp width=700px></figure><h2 id=what-it-was-designed-to-do>What it was designed to do?
<a class=heading-link href=#what-it-was-designed-to-do><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>First, let&rsquo;s see why do we need type hints in Python. There are multiple advantages of this, and I&rsquo;ll try to enumerate
it in their order of importance:</p><h3 id=1-easier-to-reason-about-code>1. Easier to reason about code
<a class=heading-link href=#1-easier-to-reason-about-code><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Knowing the type of parameters makes it a lot easier to understand and maintain a codebase. For example, let&rsquo;s assume
you have a function. While we know the types of the parameters at the time of creating the function, a few months down
the line, this is no longer the case. Having stated the types of all parameters and return types right beside the code
can speed up significantly the time required to catch up with a code snippet. Always remember that code you read code a
lot more often than you write it. Therefore you should optimize for ease of reading.</p><p>Having type hints informs you of what parameter types you need to pass on when calling a function and when you need to
extend/modify the function tells you about the type of data you get both as input and output. For example, imagine the
following the send request function,</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>send_request</span><span class=p>(</span><span class=n>request_data</span> <span class=p>:</span> <span class=n>Any</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>headers</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>str</span><span class=p>]],</span>
</span></span><span class=line><span class=cl>                 <span class=n>user_id</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>UserId</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>as_json</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span></code></pre></div><p>Just looking at the signature of this, I know that while the <code>request_data</code> could be anything, the <code>headers</code> content is
a dictionary of strings. The user information is optional (defaulting to <code>None</code>), or it needs to be whatever <code>UserId</code>
encodes it too. The contract for <code>as_json</code> is that it needs to be always a boolean value, being a flag essentially even
though the name might not suggest that at first.</p><p>The truth is many of us already understand that type of information is essential. However, in lack of better options
until now, this was often mentioned inside the docstring. The type hint system moves this closer to the function
interface and provides a well-defined way to declare complex type requirements. Building linters that can check these
type hint constraints ensure that they never become out of date, granted that you run them after every code change.</p><h3 id=2easier-refactoring>2.Easier refactoring
<a class=heading-link href=#2easier-refactoring><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Type hints make it trivial to find where a given class is used when you&rsquo;re trying to refactor your codebase. While many
IDEs already have some heuristic in place to achieve this. Type hints allow them to have <code>100%</code> detection and accuracy
ratio. Generally offers a smoother and more accurate detection of how types run through your code. Remember, while
dynamic typing means any variable can become any of types, all your variables have at all time one and only one type.
The type system still is very much a core component of programming. Remember all the time you&rsquo;ve used <code>isinstance</code> to
drive your application logic.</p><h3 id=3-easier-to-use-libraries>3. Easier to use libraries
<a class=heading-link href=#3-easier-to-use-libraries><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Having type hints mean IDEs can have a more accurate and smarter suggestion engine. Now when you invoke auto-complete,
the IDE knows with complete confidence, what methods/attributes are available on an object. Furthermore, if the user
tries to call something non-existent or passes arguments of an incorrect type, the IDE can instantly warn about it.</p><figure><img src=editor_suggest.webp alt="IDE suggestion" width=500px></figure><h3 id=4-type-linters>4. Type linters
<a class=heading-link href=#4-type-linters><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><figure><img src=type_mismatch.webp alt="IDE suggestion" width=500px></figure><p>While the IDE suggesting incorrect argument types is excellent, an extension of this is to have a linter tool that makes
sure that type wise the logic of your application is sound. Running this tool can help you catch bugs early on (e.g., in
the example that follows, the input must be of type <code>str</code>, passing in <code>None</code> throws an exception):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>transform</span><span class=p>(</span><span class=n>arg</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s1>&#39;transformed value </span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>arg</span><span class=o>.</span><span class=n>upper</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=c1># if arg would be type hinted as str the type linter could warn that this is an invalid call</span>
</span></span><span class=line><span class=cl><span class=n>transform</span><span class=p>(</span><span class=kc>None</span><span class=p>)</span>
</span></span></code></pre></div><p>While in this trivial case, some could argue that it&rsquo;s easy to see the mismatch, remember this works in more complicated
cases too, where such mismatches get harder and harder to see; such as nested function calls:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>construct</span><span class=p>(</span><span class=n>param</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>None</span> <span class=k>if</span> <span class=n>param</span> <span class=ow>is</span> <span class=kc>None</span> <span class=k>else</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>append</span><span class=p>(</span><span class=n>arg</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>arg</span> <span class=o>+</span> <span class=s1>&#39; appended&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>transform</span><span class=p>(</span> <span class=n>append</span><span class=p>(</span> <span class=n>construct</span><span class=p>()</span> <span class=p>)</span> <span class=p>)</span>
</span></span></code></pre></div><p>While there are more and more linters out there, the reference implementation of the Python type checking is
<a href=http://mypy-lang.org/>mypy</a>. mypy is a Python command-line application, making it easy to integrate into a continuous
integration pipeline.</p><h3 id=5-runtime-data-validation>5. Runtime data validation
<a class=heading-link href=#5-runtime-data-validation><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Type hints can be used to validate at runtime to ensure that the caller does not break the contract of methods. It is no
longer needed to start your function with a long list of type asserts; instead, use a framework that re-uses type hints
and automatically checks that they are meet before your business logic runs (for example, with
<a href=https://github.com/samuelcolvin/pydantic>pydantic</a>):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span><span class=p>,</span> <span class=n>ValidationError</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>User</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span> <span class=o>=</span> <span class=s1>&#39;John Doe&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>signup_ts</span><span class=p>:</span> <span class=n>datetime</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>friends</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>external_data</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;id&#39;</span><span class=p>:</span> <span class=s1>&#39;123&#39;</span><span class=p>,</span> <span class=s1>&#39;signup_ts&#39;</span><span class=p>:</span> <span class=s1>&#39;2017-06-01 12:22&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=s1>&#39;friends&#39;</span><span class=p>:</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>]}</span>
</span></span><span class=line><span class=cl><span class=n>user</span> <span class=o>=</span> <span class=n>User</span><span class=p>(</span><span class=o>**</span><span class=n>external_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>User</span><span class=p>(</span><span class=n>signup_ts</span><span class=o>=</span><span class=s1>&#39;broken&#39;</span><span class=p>,</span> <span class=n>friends</span><span class=o>=</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=s1>&#39;not number&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>except</span> <span class=n>ValidationError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>e</span><span class=o>.</span><span class=n>json</span><span class=p>())</span>
</span></span></code></pre></div><h2 id=what-it-wasnt-designed-to-do>What it wasn&rsquo;t designed to do?
<a class=heading-link href=#what-it-wasnt-designed-to-do><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>From the get-go, Guido clearly stated that type hints are not meant to be used for the following use cases (of course
that does not mean that people do not have libraries/tools outside, which do just that - open source power for the
win!):</p><h3 id=1-no-runtime-type-inference>1. No runtime type inference
<a class=heading-link href=#1-no-runtime-type-inference><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>The runtime interpreter (CPython) does not try to deduce type information at runtime and perhaps validate arguments
passed around based on that.</p><h3 id=2-no-performance-tuning>2. No performance tuning
<a class=heading-link href=#2-no-performance-tuning><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>The runtime interpreter (CPython) does not use the type of information to optimize the generated byte-code for either
security or performance. When executing a Python script type hints are treated just like comments; the interpreter
discards it.</p><p>The key takeaway should be that type hints are designed to improve developer experience, not influencing how your script
evaluates. It creates happy developers, not faster code!</p><figure><img src=happy_programmer.webp width=700px></figure><h1 id=what-kind-of-type-system>What kind of type system?
<a class=heading-link href=#what-kind-of-type-system><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><p>Python has gradual type hinting, meaning that whenever for a given function or variable, the type hint is not specified.
We assume that it can have any type (that is, it remains a dynamically typed section). Use this to make your gradually
codebase type-aware, one function, or variable at a time. It is possible to type hint:</p><ul><li>function arguments,</li><li>function return values,</li><li>variables.</li></ul><p><em>Remember only type hinted code is type-checked!</em> When you run the linter (e.g., mypy) on a type hinted code, you&rsquo;ll get
errors if there are type miss-matches:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># tests/test_magic_field.py</span>
</span></span><span class=line><span class=cl><span class=n>f</span> <span class=o>=</span> <span class=n>MagicField</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>MagicType</span><span class=o>.</span><span class=n>DEFAULT</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>f</span><span class=o>.</span><span class=n>names</span><span class=p>()</span>
</span></span></code></pre></div><p>This code will generate the following output:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>bernat@uvm ~/python-magic <span class=o>(</span>master●<span class=o>)</span>$ mypy --ignore-missing-imports tests/test_magic_field.py
</span></span><span class=line><span class=cl>tests/test_magic_field.py:21: error: Argument <span class=m>1</span> to <span class=s2>&#34;MagicField&#34;</span> has incompatible <span class=nb>type</span> <span class=s2>&#34;int&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    expected <span class=s2>&#34;Union[str, bytes]&#34;</span>
</span></span><span class=line><span class=cl>tests/test_magic_field.py:22: error: <span class=s2>&#34;MagicField&#34;</span> has no attribute <span class=s2>&#34;names&#34;</span><span class=p>;</span> maybe <span class=s2>&#34;name&#34;</span> or <span class=s2>&#34;_name&#34;</span>?
</span></span></code></pre></div><p>Note we can detect both type incompatibility for the argument passed in and accesses to inexistent attributes on
objects. The latter even suggests valid options available, making it easy to notice and fix typos.</p><h2 id=how-to-add-it>How to add it
<a class=heading-link href=#how-to-add-it><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Once you decide to add type hints, you&rsquo;ll come to realize that you can add it in more than one way to the codebase.
Let&rsquo;s see what your options are.</p><figure><img src=interested.webp width=700px></figure><h3 id=1-type-annotations>1. Type annotations
<a class=heading-link href=#1-type-annotations><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>A</span><span class=p>(</span><span class=nb>object</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>         <span class=bp>self</span><span class=o>.</span><span class=n>elements</span> <span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>def</span> <span class=nf>add</span><span class=p>(</span><span class=n>element</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>         <span class=bp>self</span><span class=o>.</span><span class=n>elements</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>element</span><span class=p>)</span>
</span></span></code></pre></div><p><em>Type annotations</em> is the straightforward way and is the one you&rsquo;ll find mostly mentioned on the
<a href=https://docs.python.org/3/library/typing.html>typing</a> documentation. It uses function annotations added to language
via <a href=https://www.python.org/dev/peps/pep-3107/>PEP-3107</a> (Python <code>3.0+</code>) and variable annotations via
<a href=https://www.python.org/dev/peps/pep-0526/>PEP-526</a> (Python <code>3.6+</code>). These allow you to use the <code>:</code> syntax to attach
information to variables and function arguments. The <code>-></code> operator is used to attach information to the return value of
a function/method.</p><p>The <strong>upside</strong> of this method is that:</p><ul><li>It is the canonical way of doing this, which means it is the cleanest out of them all.</li><li>Because the type of information is attached right alongside the code means you&rsquo;ll have packaged this data out of the
box.</li></ul><p>The <strong>downside</strong> of it is that:</p><ul><li>It isn&rsquo;t backward compatible. You need Python <code>3.6</code> at least to use it.</li><li>It also forces you to import <strong>all</strong> of your type dependencies, even though they are not used at runtime at all.</li><li>In the type hints, you can have compound types, for example, <code>List[int]</code>. To construct these complex types, the
interpreter does need to do some operations when first loading this file.</li></ul><p>The last two points contradict the initial goal of the type system we enlisted before: handling all type information
basically as a comment during runtime. To resolve some of this contradiction <code>Python 3.7</code> introduces
<a href=https://www.python.org/dev/peps/pep-0563/>PEP-563 ~ postponed evaluation of annotations</a>. Once you add the import of:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>__future__</span> <span class=kn>import</span> <span class=n>annotations</span>
</span></span></code></pre></div><p>The interpreter will no longer construct these compound types. Once the interpreter parses the scripts syntax tree, it
identifies type hints and bypasses evaluating it, keeping it as raw strings. This mechanism allows for type hint
interpretation to happen where they need to: by the linter when it runs type checks. Once the mythical <code>Python 4</code> comes
to life, this mechanism shall be the default behavior.</p><h3 id=2-type-comments>2. Type comments
<a class=heading-link href=#2-type-comments><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>When the annotation syntax is not available, one can use the type comments:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>A</span><span class=p>(</span><span class=nb>object</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>():</span>
</span></span><span class=line><span class=cl>         <span class=c1># type: () -&gt; None</span>
</span></span><span class=line><span class=cl>         <span class=bp>self</span><span class=o>.</span><span class=n>elements</span> <span class=o>=</span> <span class=p>[]</span>  <span class=c1># type: List[int]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>def</span> <span class=nf>add</span><span class=p>(</span><span class=n>element</span><span class=p>):</span>
</span></span><span class=line><span class=cl>         <span class=c1># type: (List[int]) -&gt; None</span>
</span></span><span class=line><span class=cl>         <span class=bp>self</span><span class=o>.</span><span class=n>elements</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>element</span><span class=p>)</span>
</span></span></code></pre></div><p>Going down this path, we do get some benefits:</p><ul><li>Type comments work under any Python version. Although the typing library has been added to the standard library with
Python <code>3.5+</code> is available as a PyPi package for Python <code>2.7+</code>. Moreover, because Python comments is a valid language
feature under virtually any Python code, this allows you to type-hint any codebase at or above Python <code>2.7</code>. There are
a few requirements: the type hint comment <strong>must</strong> be on the same or the next line where the function/variable
definition is. It also starts with the <code>type:</code> constant.</li><li>This solution also has packaging solved because comments are rarely stripped of your code once you stripped it.
Packaging type hint information with your source code allows people using your library to use your type hint
information to improve their developer experience.</li></ul><p>But we also generate some new problems:</p><ul><li>The downside is that although the type of information is close to the arguments, it&rsquo;s not right beside it, making the
code a bit messier than otherwise would be. It must also be in a single line, causing issues if you have a long type
of expression, and your codebase enforces line length limits.</li><li>Another problem is that now the type hint information competes with other tools using these types of comment markers
(e.g., suppressing other linter tools errors).</li><li>Besides forcing you to import all of your type information, this leaves you in an even more precarious place. Now the
imported types are only used in the code, which leaves most linter tools to believe all those imports are unused. Were
you to allow them to remove it, and it does break your type linter. Note <code>pylint</code> fixed this by moving its AST parser
to a <a href=https://github.com/PyCQA/pylint/issues/1063>typed-ast parser</a>, and is going to be released with version 2 just
after Python <code>3.7</code> comes out.</li></ul><p>To avoid having long lines of code as type hint, it&rsquo;s possible to type hint arguments one by one via type comments, and
then put in the line after only the return type annotation:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>add</span><span class=p>(</span><span class=n>element</span> <span class=c1># type: List[int]</span>
</span></span><span class=line><span class=cl>       <span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># type: (...) -&gt; None</span>
</span></span><span class=line><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>elements</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>element</span><span class=p>)</span>
</span></span></code></pre></div><p>Let&rsquo;s have a quick use look at how type comments can make your code messier. Below is a code snippet that swaps out two
properties values inside a class. Fairly trivial:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@contextmanager</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>swap_in_state</span><span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=n>config</span><span class=p>,</span> <span class=n>overrides</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>old_config</span><span class=p>,</span> <span class=n>old_overrides</span> <span class=o>=</span> <span class=n>state</span><span class=o>.</span><span class=n>config</span><span class=p>,</span> <span class=n>state</span><span class=o>.</span><span class=n>overrides</span>
</span></span><span class=line><span class=cl>    <span class=n>state</span><span class=o>.</span><span class=n>config</span><span class=p>,</span> <span class=n>state</span><span class=o>.</span><span class=n>overrides</span> <span class=o>=</span> <span class=n>config</span><span class=p>,</span> <span class=n>overrides</span>
</span></span><span class=line><span class=cl>    <span class=k>yield</span> <span class=n>old_config</span><span class=p>,</span> <span class=n>old_overrides</span>
</span></span><span class=line><span class=cl>    <span class=n>state</span><span class=o>.</span><span class=n>config</span><span class=p>,</span> <span class=n>state</span><span class=o>.</span><span class=n>overrides</span> <span class=o>=</span> <span class=n>old_config</span><span class=p>,</span> <span class=n>old_overrides</span>
</span></span></code></pre></div><p>First, you must add type hints. Because the type hint would be long-winded, you attach type hint argument by argument:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@contextmanager</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>swap_in_state</span><span class=p>(</span><span class=n>state</span><span class=p>,</span>  <span class=c1># type: State</span>
</span></span><span class=line><span class=cl>                  <span class=n>config</span><span class=p>,</span>  <span class=c1># type: HasGetSetMutable</span>
</span></span><span class=line><span class=cl>                  <span class=n>overrides</span>  <span class=c1># type: Optional[HasGetSetMutable]</span>
</span></span><span class=line><span class=cl>                 <span class=p>):</span>
</span></span><span class=line><span class=cl><span class=c1># type: (...) -&gt; Generator[Tuple[HasGetSetMutable, Optional[HasGetSetMutable]], None, None]</span>
</span></span><span class=line><span class=cl>    <span class=n>old_config</span><span class=p>,</span> <span class=n>old_overrides</span> <span class=o>=</span> <span class=n>state</span><span class=o>.</span><span class=n>config</span><span class=p>,</span> <span class=n>state</span><span class=o>.</span><span class=n>overrides</span>
</span></span><span class=line><span class=cl>    <span class=n>state</span><span class=o>.</span><span class=n>config</span><span class=p>,</span> <span class=n>state</span><span class=o>.</span><span class=n>overrides</span> <span class=o>=</span> <span class=n>config</span><span class=p>,</span> <span class=n>overrides</span>
</span></span><span class=line><span class=cl>    <span class=k>yield</span> <span class=n>old_config</span><span class=p>,</span> <span class=n>old_overrides</span>
</span></span><span class=line><span class=cl>    <span class=n>state</span><span class=o>.</span><span class=n>config</span><span class=p>,</span> <span class=n>state</span><span class=o>.</span><span class=n>overrides</span> <span class=o>=</span> <span class=n>old_config</span><span class=p>,</span> <span class=n>old_overrides</span>
</span></span></code></pre></div><p>However, wait, you need to import your types used:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Generator</span><span class=p>,</span> <span class=n>Tuple</span><span class=p>,</span> <span class=n>Optional</span><span class=p>,</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Union</span><span class=p>,</span> <span class=n>List</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>magic</span> <span class=kn>import</span> <span class=n>RunSate</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>HasGetSetMutable</span> <span class=o>=</span> <span class=n>Union</span><span class=p>[</span><span class=n>Dict</span><span class=p>,</span> <span class=n>List</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@contextmanager</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>swap_in_state</span><span class=p>(</span><span class=n>state</span><span class=p>,</span>  <span class=c1># type: State</span>
</span></span><span class=line><span class=cl>                  <span class=n>config</span><span class=p>,</span>  <span class=c1># type: HasGetSetMutable</span>
</span></span><span class=line><span class=cl>                  <span class=n>overrides</span>  <span class=c1># type: Optional[HasGetSetMutable]</span>
</span></span><span class=line><span class=cl>                  <span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># type: (...) -&gt; Generator[Tuple[HasGetSetMutable, Optional[HasGetSetMutable]], None, None]</span>
</span></span><span class=line><span class=cl>    <span class=n>old_config</span><span class=p>,</span> <span class=n>old_overrides</span> <span class=o>=</span> <span class=n>state</span><span class=o>.</span><span class=n>config</span><span class=p>,</span> <span class=n>state</span><span class=o>.</span><span class=n>overrides</span>
</span></span><span class=line><span class=cl>    <span class=n>state</span><span class=o>.</span><span class=n>config</span><span class=p>,</span> <span class=n>state</span><span class=o>.</span><span class=n>overrides</span> <span class=o>=</span> <span class=n>config</span><span class=p>,</span> <span class=n>overrides</span>
</span></span><span class=line><span class=cl>    <span class=k>yield</span> <span class=n>old_config</span><span class=p>,</span> <span class=n>old_overrides</span>
</span></span><span class=line><span class=cl>    <span class=n>state</span><span class=o>.</span><span class=n>config</span><span class=p>,</span> <span class=n>state</span><span class=o>.</span><span class=n>overrides</span> <span class=o>=</span> <span class=n>old_config</span><span class=p>,</span> <span class=n>old_overrides</span>
</span></span></code></pre></div><p>Now formatting like this, the code causes some false positives in the static linter (e.g. <code>pylint</code> here), so you add a
few suppress comments for this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Generator</span><span class=p>,</span> <span class=n>Tuple</span><span class=p>,</span> <span class=n>Optional</span><span class=p>,</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>List</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>magic</span> <span class=kn>import</span> <span class=n>RunSate</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>HasGetSetMutable</span> <span class=o>=</span> <span class=n>Union</span><span class=p>[</span><span class=n>Dict</span><span class=p>,</span> <span class=n>List</span><span class=p>]</span>  <span class=c1># pylint: disable=invalid-name</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@contextmanager</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>swap_in_state</span><span class=p>(</span><span class=n>state</span><span class=p>,</span>  <span class=c1># type: State</span>
</span></span><span class=line><span class=cl>                   <span class=n>config</span><span class=p>,</span>  <span class=c1># type: HasGetSetMutable</span>
</span></span><span class=line><span class=cl>                   <span class=n>overrides</span>  <span class=c1># type: Optional[HasGetSetMutable]</span>
</span></span><span class=line><span class=cl>                   <span class=p>):</span>  <span class=c1># pylint: disable=bad-continuation</span>
</span></span><span class=line><span class=cl>    <span class=c1># type: (...) -&gt; Generator[Tuple[HasGetSetMutable, Optional[HasGetSetMutable]], None, None]</span>
</span></span><span class=line><span class=cl>    <span class=n>old_config</span><span class=p>,</span> <span class=n>old_overrides</span> <span class=o>=</span> <span class=n>state</span><span class=o>.</span><span class=n>config</span><span class=p>,</span> <span class=n>state</span><span class=o>.</span><span class=n>overrides</span>
</span></span><span class=line><span class=cl>    <span class=n>state</span><span class=o>.</span><span class=n>config</span><span class=p>,</span> <span class=n>state</span><span class=o>.</span><span class=n>overrides</span> <span class=o>=</span> <span class=n>config</span><span class=p>,</span> <span class=n>overrides</span>
</span></span><span class=line><span class=cl>    <span class=k>yield</span> <span class=n>old_config</span><span class=p>,</span> <span class=n>old_overrides</span>
</span></span><span class=line><span class=cl>    <span class=n>state</span><span class=o>.</span><span class=n>config</span><span class=p>,</span> <span class=n>state</span><span class=o>.</span><span class=n>overrides</span> <span class=o>=</span> <span class=n>old_config</span><span class=p>,</span> <span class=n>old_overrides</span>
</span></span></code></pre></div><p>Now you&rsquo;re done. Nevertheless, you made your six lines of code sixteen lines long. Yay, more code to maintain!
Increasing your codebase only sounds good if you&rsquo;re getting paid by the number line of code written, and your manager is
complaining you&rsquo;re not performing well enough.</p><h3 id=3-interface-stub-files>3. Interface stub files
<a class=heading-link href=#3-interface-stub-files><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>This option allows you to keep your code as it is:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>A</span><span class=p>(</span><span class=nb>object</span><span class=p>):</span>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=fm>__init__</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=bp>self</span><span class=o>.</span><span class=n>elements</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=nf>add</span><span class=p>(</span><span class=n>element</span><span class=p>):</span>
</span></span><span class=line><span class=cl>      <span class=bp>self</span><span class=o>.</span><span class=n>elements</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>element</span><span class=p>)</span>
</span></span></code></pre></div><p>and instead, add another file with <code>pyi</code> extension right beside it:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># a.pyi alongside a.py</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>A</span><span class=p>(</span><span class=nb>object</span><span class=p>):</span>
</span></span><span class=line><span class=cl>  <span class=n>elements</span> <span class=o>=</span> <span class=o>...</span> <span class=c1># type: List[int]</span>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=fm>__init__</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span> <span class=o>...</span>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=nf>add</span><span class=p>(</span><span class=n>element</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span> <span class=o>...</span>
</span></span></code></pre></div><p>Interface files are not a new thing; C/C++ had it for decades now. Because Python is an interpreted language, it does
not need it usually, however as every problem in computer science can be solved by adding a new level of indirection, we
can add it to store the type of information.</p><p>The upside of this is that:</p><ul><li>You don&rsquo;t need to modify the source code; works under any Python version as the interpreter never touches these.</li><li>Inside the stub files, you can use the latest syntax (e.g., type annotations) because these are never looked at during
your application&rsquo;s execution. Because you do not touch your source code, you cannot introduce bugs by adding type
hints, nor can you add conflict with other linter tools.</li><li>It is a well-tested design; the <a href=https://github.com/python/typeshed><code>typeshed</code></a> project uses it to type hint the
entire standard library, plus some other popular libraries such as <code>requests</code>, <code>yaml</code>, <code>dateutil</code> and
<a href=https://github.com/python/typeshed/tree/master/stubs/>so on</a>. It can provide type information for source code that
you do not own or cannot change easily.</li></ul><p>Now there are also some hefty penalties to pay:</p><ul><li>You just duplicated your codebase, as every function now has two definitions (note you don&rsquo;t need to replicate your body or default arguments, the <code>...</code> - ellipsis - is used as a placeholder for these).</li><li>Now, you have some extra files that need to be packaged and shipped with your code.</li><li>It&rsquo;s impossible to annotate contents inside functions (this means both methods inside methods and local variables).</li><li>There is no check that your implementation file matches your stub&rsquo;s signature (furthermore, IDEs always use the stub definition).</li><li>However, the heaviest penalty is that you cannot type check the code you&rsquo;re type hinting via a stub. Stub file type hints were designed to be used to type-check code that uses the library. But not too type check the codebase itself what your type hinting.</li></ul><p>The last two drawback makes it incredibly hard to check that the type hinted codebase via a stub file is in sync or not.
In this current form, type stubs are a way to provide type hints to your users, but not for yourself, and are incredibly
hard to maintain. To fix these, I&rsquo;ve taken up the task of merging stub files with source files inside mypy; in theory,
fix both problems - you can follow on its progress under
<a href=https://github.com/python/mypy/issues/5028>python/mypy ~ issue 5208</a>.</p><h3 id=4-docstrings>4. Docstrings
<a class=heading-link href=#4-docstrings><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>It is possible to add type information into docstrings too. Even though this is not part of Python&rsquo;s type-hint
framework, it is supported by most mainstream IDEs. They are mostly the legacy way of doing this.</p><p>On the plus side:</p><ul><li>Works under any Python version. It was defined back in <a href=https://www.python.org/dev/peps/pep-0257/>PEP-257</a>. It does
not clash with other linter tools, as most of these do not check the docstrings but usually resume just inspecting the
other code sections instead.</li></ul><p>However, it has serious flaws in the form of:</p><ul><li>There is no standard way to specify complex type hints (for example, either <code>int</code> or <code>bool</code>). PyCharm has
<a href=https://www.jetbrains.com/help/pycharm/type-hinting-in-product.html#legacy>it&rsquo;s the proprietary way</a> but Sphinx, for
example, uses a different method. T- Docstring types do not clash with other linter tools.</li><li>Requires changing the documentation, and it is hard to keep accurate/up to date as there is no tool to check it&rsquo;s
validity.</li><li>Docstring types do not play well with type hinted code. If both type annotations and docstrings are specified, which
takes precedence over which?</li></ul><h2 id=what-to-add>What to add?
<a class=heading-link href=#what-to-add><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><figure><img src=deep_dive.webp width=700px></figure><p>Let&rsquo;s dive into the specifics, though. For an exhaustive list of what type of information you can add, please see the
<a href=https://docs.python.org/3/library/typing.html>official documentation</a>. Here I&rsquo;ll do a quick 3-minute overview for you
to get the idea of it. There are two types of type categories: nominal types and duck types (protocols).</p><h3 id=1-nominal-type>1. Nominal type
<a class=heading-link href=#1-nominal-type><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Nominal types are types that have a name to it within the Python interpreter. For example all builtin types (<code>int</code>,
<code>boolean</code>, <code>float</code>, <code>type</code>, <code>object</code> etc). Then we have the generic types which mostly manifest in form of the
containers:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>t</span> <span class=p>:</span> <span class=n>Tuple</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>float</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=mf>1.2</span>
</span></span><span class=line><span class=cl><span class=n>d</span> <span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;a&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=s2>&#34;b&#34;</span><span class=p>:</span> <span class=mi>2</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>d</span> <span class=p>:</span> <span class=n>MutableMapping</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;a&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=s2>&#34;b&#34;</span><span class=p>:</span> <span class=mi>2</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>l</span> <span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>i</span> <span class=p>:</span> <span class=n>Iterable</span><span class=p>[</span><span class=n>Text</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span> <span class=sa>u</span><span class=s1>&#39;1&#39;</span><span class=p>,</span> <span class=sa>u</span><span class=s1>&#39;2&#39;</span><span class=p>,</span> <span class=sa>u</span><span class=s1>&#39;3&#39;</span><span class=p>]</span>
</span></span></code></pre></div><p>For compound types, it can become cumbersome to keep writing it again and again, so the system allows you to alias
types, via:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>OptFList</span> <span class=o>=</span> <span class=n>Optional</span><span class=p>[</span><span class=n>List</span><span class=p>[</span><span class=nb>float</span><span class=p>]]</span>
</span></span></code></pre></div><p>One can even elevate builtin types to represent their own type, which can be useful to avoid errors where for example
you pass in two arguments with the same type in the wrong order to a function:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>UserId</span> <span class=o>=</span> <span class=n>NewType</span><span class=p>(</span><span class=s1>&#39;UserId&#39;</span><span class=p>,</span> <span class=nb>int</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>user_id</span> <span class=o>=</span> <span class=n>UserId</span><span class=p>(</span><span class=mi>524313</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>count</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>call_with_user_id_n_times</span><span class=p>(</span><span class=n>user_id</span><span class=p>,</span> <span class=n>count</span><span class=p>)</span>
</span></span></code></pre></div><p>For <code>namedtuple</code> you can attach your type information directly (note the strong resemblance to a
<a href=https://www.python.org/dev/peps/pep-0557/>data class</a> from Python <code>3.7+</code> or the great
<a href=https://github.com/python-attrs/attrs><code>attrs</code> library</a>):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>Employee</span><span class=p>(</span><span class=n>NamedTuple</span><span class=p>):</span>
</span></span><span class=line><span class=cl>     <span class=n>name</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>     <span class=nb>id</span><span class=p>:</span> <span class=nb>int</span>
</span></span></code></pre></div><p>You have the composing types of <em>one of</em> and <em>optional of</em>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>Union</span><span class=p>[</span><span class=kc>None</span><span class=p>,</span> <span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>]</span> <span class=c1># one of</span>
</span></span><span class=line><span class=cl><span class=n>Optional</span><span class=p>[</span><span class=nb>float</span><span class=p>]</span> <span class=c1># either None or float</span>
</span></span></code></pre></div><p>You can even type hint your callback functions:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># syntax is Callable[[Arg1Type, Arg2Type], ReturnType]</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>feeder</span><span class=p>(</span><span class=n>get_next_item</span><span class=p>:</span> <span class=n>Callable</span><span class=p>[[],</span> <span class=nb>str</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span></code></pre></div><p>One can define it&rsquo;s own generic containers by using the <code>TypeVar</code> construction:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>T</span> <span class=o>=</span> <span class=n>TypeVar</span><span class=p>(</span><span class=s1>&#39;T&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Magic</span><span class=p>(</span><span class=n>Generic</span><span class=p>[</span><span class=n>T</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>      <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>:</span> <span class=n>T</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>         <span class=bp>self</span><span class=o>.</span><span class=n>value</span> <span class=p>:</span> <span class=n>T</span> <span class=o>=</span> <span class=n>value</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=k>def</span> <span class=nf>square_values</span><span class=p>(</span><span class=nb>vars</span><span class=p>:</span> <span class=n>Iterable</span><span class=p>[</span><span class=n>Magic</span><span class=p>[</span><span class=nb>int</span><span class=p>]])</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>     <span class=n>v</span><span class=o>.</span><span class=n>value</span> <span class=o>=</span> <span class=n>v</span><span class=o>.</span><span class=n>value</span> <span class=o>*</span> <span class=n>v</span><span class=o>.</span><span class=n>value</span>
</span></span></code></pre></div><p>Finally, disable type checking wherever it&rsquo;s not needed by using the <code>Any</code> type hint:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>foo</span><span class=p>(</span><span class=n>item</span><span class=p>:</span> <span class=n>Any</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>int</span><span class=p>:</span>
</span></span><span class=line><span class=cl>     <span class=n>item</span><span class=o>.</span><span class=n>bar</span><span class=p>()</span>
</span></span></code></pre></div><h3 id=2-duck-types---protocols>2. Duck types - protocols
<a class=heading-link href=#2-duck-types---protocols><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>In this case, instead of having an actual type, one can be more Pythonic and go with the theorem that if it quacks like
a duck, and acts like a duck, then most definitely for all intended purposes, it is a duck. In this case, you define
what operations and attributes you expect on objects instead of explicitly stating their types. The grounds of this were
laid down in <a href=https://www.python.org/dev/peps/pep-0544/>PEP-544 ~ Protocols</a>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>KEY</span> <span class=o>=</span> <span class=n>TypeVar</span><span class=p>(</span><span class=s1>&#39;KEY&#39;</span><span class=p>,</span> <span class=n>contravariant</span><span class=o>=</span><span class=n>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># this is a protocol having a generic type as an argument</span>
</span></span><span class=line><span class=cl><span class=c1># it has a class variable of type var, and a getter with the same key type</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MagicGetter</span><span class=p>(</span><span class=n>Protocol</span><span class=p>[</span><span class=n>KEY</span><span class=p>],</span> <span class=n>Sized</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>var</span> <span class=p>:</span> <span class=n>KEY</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__getitem__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>item</span><span class=p>:</span> <span class=n>KEY</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>int</span><span class=p>:</span> <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>func_int</span><span class=p>(</span><span class=n>param</span><span class=p>:</span> <span class=n>MagicGetter</span><span class=p>[</span><span class=nb>int</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=nb>int</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>param</span><span class=p>[</span><span class=s1>&#39;a&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>func_str</span><span class=p>(</span><span class=n>param</span><span class=p>:</span> <span class=n>MagicGetter</span><span class=p>[</span><span class=nb>str</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s1>&#39;</span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>param</span><span class=p>[</span><span class=s1>&#39;a&#39;</span><span class=p>])</span>
</span></span></code></pre></div><h1 id=gotchas>Gotchas
<a class=heading-link href=#gotchas><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><p>Once you start adding type hints to a codebase, watch out that sometimes you may experience some oddities. During these
moments, you might have the *what the hell** expression of the following seal:</p><figure><img src=gotcha.webp width=700px></figure><p>In this section, I&rsquo;ll try to present a few of these to give you a heads up on what kind of oddities you may run into
while adding type information to your codebase.</p><h3 id=1-str-difference-in-between-python-23>1. str difference in between Python 2/3
<a class=heading-link href=#1-str-difference-in-between-python-23><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Here&rsquo;s a quick implementation of the <code>repr</code> dunder method for a class:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>__future__</span> <span class=kn>import</span> <span class=n>unicode_literals</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>A</span><span class=p>(</span><span class=nb>object</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__repr__</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s1>&#39;A(</span><span class=si>{}</span><span class=s1>)&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>full_name</span><span class=p>)</span>
</span></span></code></pre></div><p>This code has a bug in it. While this is correct under Python 3, it is not under Python 2 (because Python 2 expects to
return <code>bytes</code> from <code>repr</code>. However, the <code>unicode_literals</code> import makes the returned value of type <code>unicode</code>). Having
the from future import in place means it&rsquo;s not possible to write a <code>repr</code> that satisfies the type requirements for both
Python 2 and 3. You need to add runtime logic to do the right thing:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>__future__</span> <span class=kn>import</span> <span class=n>unicode_literals</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>A</span><span class=p>(</span><span class=nb>object</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__repr__</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>res</span> <span class=o>=</span> <span class=s1>&#39;A(</span><span class=si>{}</span><span class=s1>)&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>full_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>sys</span><span class=o>.</span><span class=n>version_info</span> <span class=o>&gt;</span> <span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>0</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=c1># noinspection PyTypeChecker</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>res</span>
</span></span><span class=line><span class=cl>        <span class=c1># noinspection PyTypeChecker</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>res</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span>
</span></span></code></pre></div><p>To fight the IDE to accept this form, you need to add a few linter comments, making this code ever so complicated to
read. More importantly, now you have an extra runtime check forced to your type checker.</p><h3 id=2-multiple-return-types>2. Multiple return types
<a class=heading-link href=#2-multiple-return-types><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Imagine you want to write a function that multiplies either a string or an int by two. The first take on this would be:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>magic</span><span class=p>(</span><span class=n>i</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>int</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>Union</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>int</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>i</span> <span class=o>*</span> <span class=mi>2</span>
</span></span></code></pre></div><p>Your input is either <code>str</code> or <code>int</code>, and your return value accordingly is also either <code>str</code> or <code>int</code>. However, if you do
it like so, you&rsquo;re telling the type hint that it really can be either of for both types of inputs. Therefore on the call
side, you need to assert the type your calling with:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>other_func</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=nb>int</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>magic</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>result</span><span class=p>,</span> <span class=nb>int</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span>
</span></span></code></pre></div><p>This inconvenience may determine some people to avoid the call side hassle by making the return value <code>Any</code>. However,
there&rsquo;s a better solution. The type hint system allows you to define overloads. Overloads express that for a given input
type, and only a given output type is returned. So, in this case:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>overload</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@overload</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>magic</span><span class=p>(</span><span class=n>i</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>int</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@overload</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>magic</span><span class=p>(</span><span class=n>i</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>magic</span><span class=p>(</span><span class=n>i</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>i</span> <span class=o>*</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>other_func</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=nb>int</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>magic</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span>
</span></span></code></pre></div><p>There is a downside to this, though. Now your static linter tool is complaining that you&rsquo;re redefining functions with
the the same name; this is a false positive so add the static linter disable comment mark
(<code># pylint: disable=function-redefined</code> ).</p><h3 id=3-type-lookup>3. Type lookup
<a class=heading-link href=#3-type-lookup><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Imagine you have a class that allows representing the contained data as multiple types or that has fields of the
different type. You want the user to have a quick and easy way to refer to them, so you add a function, having a
built-in types name:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>A</span><span class=p>(</span><span class=nb>object</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>float</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=c1># type: () -&gt; float</span>
</span></span><span class=line><span class=cl>           <span class=k>return</span> <span class=mf>1.0</span>
</span></span></code></pre></div><p>Once you run the linter, you&rsquo;ll see:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>test.py:3: error: Invalid <span class=nb>type</span> <span class=s2>&#34;test.A.float&#34;</span>
</span></span></code></pre></div><p>One might ask, at this point, what the hell? I&rsquo;ve defined the return value as <code>float</code>, not as <code>test.A.float</code>. This
obscure error is that the type hinter resolves types by evaluating each scope outbound from the definition location.
Once it finds a name match, it stops. The first level where it looks is within <code>class A</code> where it finds a <code>float</code> (a
function that is) and substitutes that float in.</p><p>Now the solution to not run into this issue is to explicitly define that we don&rsquo;t just want any <code>float</code>, but that we
want the <code>builtin.float</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>if</span> <span class=n>typing</span><span class=o>.</span><span class=n>TYPE_CHECKING</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=kn>import</span> <span class=nn>builtins</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>A</span><span class=p>(</span><span class=nb>object</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>float</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=c1># type: () -&gt; builtins.float</span>
</span></span><span class=line><span class=cl>           <span class=k>return</span> <span class=mf>1.0</span>
</span></span></code></pre></div><p>Note that to do this, you also need to import <code>builtins</code>, and to avoid this causing issues at runtime, you can guard it
with the <code>typing.TYPE_CHECKING</code> flag, which is true only during the type linter evaluation, always false otherwise.</p><h3 id=4-contra-variant-argument>4. Contra-variant argument
<a class=heading-link href=#4-contra-variant-argument><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Examine the following use case. You define an abstract base class that contains everyday operations. Then you have
specific classes that handle one type and one type only. You control the creation of the classes, which ensures the
correct type is passed, and the base is abstract, so this seems an agreeable design:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>abc</span> <span class=kn>import</span> <span class=n>ABCMeta</span><span class=p>,</span> <span class=n>abstractmethod</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Union</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>A</span><span class=p>(</span><span class=n>metaclass</span><span class=o>=</span><span class=n>ABCMeta</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nd>@abstractmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>func</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>):</span>  <span class=c1># type: (Union[int, str]) -&gt; str</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>NotImplementedError</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>B</span><span class=p>(</span><span class=n>A</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>func</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>):</span>  <span class=c1># type: (int) -&gt; str</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>str</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>C</span><span class=p>(</span><span class=n>A</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>func</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>):</span>  <span class=c1># type: (str) -&gt; str</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>key</span>
</span></span></code></pre></div><p>However, once you run a type linter check on this, you&rsquo;ll find:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>test.py:12: error: Argument <span class=m>1</span> of <span class=s2>&#34;func&#34;</span> incompatible with supertype <span class=s2>&#34;A&#34;</span>
</span></span><span class=line><span class=cl>test.py:17: error: Argument <span class=m>1</span> of <span class=s2>&#34;func&#34;</span> incompatible with supertype <span class=s2>&#34;A&#34;</span>
</span></span></code></pre></div><p>The reason for this is that arguments to classes are contra-variant. This translates in on scientific terms in your
derived class you <strong>must</strong> handle all types from your parents. However, you may add additional types too. That is even
in the function arguments; you can only extend what you cover, but not to constrain it in any way:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>abc</span> <span class=kn>import</span> <span class=n>ABCMeta</span><span class=p>,</span> <span class=n>abstractmethod</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Union</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>A</span><span class=p>(</span><span class=n>metaclass</span><span class=o>=</span><span class=n>ABCMeta</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nd>@abstractmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>func</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>):</span>  <span class=c1># type: (Union[int, str]) -&gt; str</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>NotImplementedError</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>B</span><span class=p>(</span><span class=n>A</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>func</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>):</span>  <span class=c1># type: (Union[int, str, bool]) -&gt; str</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>str</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>C</span><span class=p>(</span><span class=n>A</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>func</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>):</span>  <span class=c1># type: (Union[int, str, List]) -&gt; str</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>key</span>
</span></span></code></pre></div><h3 id=5-compatibility>5. Compatibility
<a class=heading-link href=#5-compatibility><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>See if you can spot the error in the following code snippet:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>A</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nd>@classmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>magic</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>a</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=s1>&#39;A&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>cls</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>B</span><span class=p>(</span><span class=n>A</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nd>@classmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>magic</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>a</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>b</span><span class=p>:</span> <span class=nb>bool</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=s1>&#39;B&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>cls</span><span class=p>()</span>
</span></span></code></pre></div><p>If you did not manage yet, consider what will happen if you write the following script:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Type</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>elements</span> <span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Type</span><span class=p>[</span><span class=n>A</span><span class=p>]]</span> <span class=o>=</span> <span class=p>[</span><span class=n>A</span><span class=p>,</span> <span class=n>B</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span> <span class=p>[</span><span class=n>e</span><span class=o>.</span><span class=n>magic</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=k>for</span> <span class=n>e</span> <span class=ow>in</span> <span class=n>elements</span><span class=p>])</span>
</span></span></code></pre></div><p>Were you to try to run it this would fail with the following runtime error:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span> <span class=p>[</span><span class=n>e</span><span class=o>.</span><span class=n>magic</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=k>for</span> <span class=n>e</span> <span class=ow>in</span> <span class=n>elements</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=ne>TypeError</span><span class=p>:</span> <span class=n>magic</span><span class=p>()</span> <span class=n>missing</span> <span class=mi>1</span> <span class=n>required</span> <span class=n>positional</span> <span class=n>argument</span><span class=p>:</span> <span class=s1>&#39;b&#39;</span>
</span></span></code></pre></div><p>The reason being that <code>B</code> is a subtype of <code>A</code>. Therefore it can go into a container of <code>A</code> types (because it extends it
to do more than <code>A</code>). However, the class method definition for <code>B</code> breaks this contract, it can no longer call magic
with just one argument. Moreover, the type linter would fail to point out only this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>test.py:9: error: Signature of <span class=s2>&#34;magic&#34;</span> incompatible with supertype <span class=s2>&#34;A&#34;</span>
</span></span></code></pre></div><p>A quick and easy fix for this is to make sure <code>B.magic</code> does work with one argument by making the second optional for
example. Now take what we learned to take a look at the following:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>A</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>a</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>B</span><span class=p>(</span><span class=n>A</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>a</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>b</span><span class=p>:</span> <span class=nb>bool</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=n>a</span><span class=p>)</span>
</span></span></code></pre></div><p>What do you think will happen here? Note we moved class methods into constructors and made no other change, so our the
script also needs just a slight modification:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Type</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>elements</span> <span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Type</span><span class=p>[</span><span class=n>A</span><span class=p>]]</span><span class=o>=</span> <span class=p>[</span><span class=n>A</span><span class=p>,</span> <span class=n>B</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span> <span class=p>[</span><span class=n>e</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=k>for</span> <span class=n>e</span> <span class=ow>in</span> <span class=n>elements</span><span class=p>])</span>
</span></span></code></pre></div><p>Here&rsquo;s the runtime error, being mostly the same, just now complaining about <code>__init__</code> instead of <code>magic</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>    print<span class=o>(</span> <span class=o>[</span>e<span class=o>(</span>1<span class=o>)</span> <span class=k>for</span> e in elements<span class=o>])</span>
</span></span><span class=line><span class=cl>TypeError: __init__<span class=o>()</span> missing <span class=m>1</span> required positional argument: <span class=s1>&#39;b&#39;</span>
</span></span></code></pre></div><p>So what do you think mypy will say? Were you to run it; you&rsquo;ll find that mypy chooses to stay silent. Yes, it will mark
this as correct, even though at runtime, it fails. The mypy creators said that they found <em>too common of type miss-match
to prohibit incompatible <code>__init__</code> and <code>__new__</code></em>.</p><h2 id=when-you-hit-the-wall>When you hit the wall
<a class=heading-link href=#when-you-hit-the-wall><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>So, in conclusion, watch out. Type hints sometimes cause strange warnings, which brings out the following feelings
summarized in a tweet:</p><figure><img src=david.webp width=700px></figure><p>Remember you have some tools at hand that help you discover, understand and perhaps handle these edge cases:</p><ul><li>use <code>reveal_type</code> to see inferred type<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>a</span> <span class=o>=</span> <span class=p>[</span><span class=mi>4</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>reveal_type</span><span class=p>(</span><span class=n>a</span><span class=p>)</span>         <span class=c1># -&gt; error: Revealed type is &#39;builtins.list[builtins.int*]&#39;</span>
</span></span></code></pre></div></li><li>use <code>cast</code> to force a given type:<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>cast</span>
</span></span><span class=line><span class=cl><span class=n>a</span> <span class=o>=</span> <span class=p>[</span><span class=mi>4</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>b</span> <span class=o>=</span> <span class=n>cast</span><span class=p>(</span><span class=n>List</span><span class=p>[</span><span class=nb>int</span><span class=p>],</span> <span class=n>a</span><span class=p>)</span> <span class=c1># passes fine</span>
</span></span><span class=line><span class=cl><span class=n>c</span> <span class=o>=</span> <span class=n>cast</span><span class=p>(</span><span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>],</span> <span class=n>a</span><span class=p>)</span> <span class=c1># type: List[str] # passes fine (no runtime check)</span>
</span></span><span class=line><span class=cl><span class=n>reveal_type</span><span class=p>(</span><span class=n>c</span><span class=p>)</span>         <span class=c1># -&gt; error: Revealed type is &#39;builtins.list[builtins.str]&#39;</span>
</span></span></code></pre></div></li><li>use the type ignore marker to disable an error in a line:<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>x</span> <span class=o>=</span> <span class=n>confusing_function</span><span class=p>()</span> <span class=c1># type: ignore # see mypy/issues/1167</span>
</span></span></code></pre></div></li><li>ask the community; expose a minimal reproducible version of the problem under the
<a href=https://gitter.im/python/typing>python/typing</a> <code>Gitter</code> chat.</li></ul><h1 id=tools>Tools
<a class=heading-link href=#tools><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><p>Here&rsquo;s a non-exhaustive list of tools built around the type hint system.</p><h2 id=type-checkers>type checkers
<a class=heading-link href=#type-checkers><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Use these tools to check against type safety inside your library or application:</p><ol><li><a href=http://mypy-lang.org/><code>mypy</code> - Python</a> (the reference type linting tool)</li><li><a href=https://github.com/facebook/pyre-check><code>pyre</code> - Facebook</a> - Python 3 only, but faster than mypy. An interesting use
case of this is the ability to do taint/security code analysis with it - see
<a href="https://www.youtube.com/watch?v=hWV8t494N88">Pieter Hooimeijer - Types, Deeper Static Analysis, and you</a>.</li><li><a href=https://github.com/google/pytype><code>pytype</code> - Google</a>.</li></ol><h2 id=type-annotation-generators>type annotation generators
<a class=heading-link href=#type-annotation-generators><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>When you want to add type annotations to an existing codebase, use these to automate the boring part:</p><ol><li><code>mypy stubgen</code> command line (<a href=https://github.com/python/mypy/blob/master/mypy/stubgen.py>see</a>)</li><li><a href=https://github.com/dropbox/pyannotate><code>pyannotate</code> - Dropbox</a> - use your tests to generate type information.</li><li><a href=https://github.com/Instagram/MonkeyType><code>monkeytype</code> - Instagram</a>. Fun fact: Instagram uses to run it in their
production system: it&rsquo;s triggered once for every million cal (makes the code run five times slower, but once every
million calls makes it not that noticeable).</li></ol><h2 id=runtime-code-evaluator>runtime code evaluator
<a class=heading-link href=#runtime-code-evaluator><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Use these tools to check at runtime if the input arguments to your function/method are of the correct type or not:</p><ol><li><a href=https://github.com/samuelcolvin/pydantic><code>pydantic</code></a></li><li><a href=https://github.com/RussBaz/enforce><code>enforce</code></a></li><li><a href=https://github.com/Stewori/pytypes><code>pytypes</code></a></li></ol><h2 id=documentation-enrichment---merge-docstrings-and-type-hints>Documentation enrichment - merge docstrings and type hints
<a class=heading-link href=#documentation-enrichment---merge-docstrings-and-type-hints><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>In the first part of this blog article, we mentioned that historically people have already stored type information
inside docstrings. This is because your type of data is part of your contract. You do want to have type information for
your library inside the documentation. So the question remains, given that you did not choose to use docstrings as the
primary type of information storage system, how can you still have them in the docstrings for your documentation?</p><p>The answer varies depending on the tool you&rsquo;re using to generate that documentation. However, I&rsquo;m going to present here
an option by using the most popular tool and format in Python: Sphinx and HTML.</p><p>Having type information explicitly stated in both the type hints and the docstring is the sure way of eventually having
conflicts between them. You can count on someone at some point is going to update in one place but not in the other.
Therefore let&rsquo;s strip all type data from the docstring and have it only as type hints. Now, all we need to do is at
documentation build time, fetch it from the type hints and insert it into the documentation.</p><p>In Sphinx, you can achieve this by having a plugin. The most popular already made version of this is
<a href=https://github.com/agronholm/sphinx-autodoc-typehints><code>agronholm/sphinx-autodoc-typehints</code></a>. This tool does two
things:</p><ul><li>first, for each function/variable to be documented, it fetches the type hint information;</li><li>then, it transforms the Python types into a docstring representation (this involves recursively unwrapping all the
nested type classes, and replacing the type with its string representation);</li><li>finally, appending to the correct parameter into the docstring.</li></ul><p>For example <code>Any</code> maps to <code>py:data:`~typing.Any`</code>. Things can get even more complicated for compound types such as
<code>Mapping[str, bool]</code> needs to be translated for example too
<code>:class:`~typing.Mapping`\\[:class:`str`, :class:`bool`]</code>. Getting the translation here right (e.g. having <code>class</code>
or <code>data</code> namespace) is essential so that the <code>intersphinx</code> plugin will work correctly (a plugin that links types
directly to their respective Python standard library documentation link).</p><p>In order to use it one needs to install it via <code>pip install sphinx-autodoc-types>=2.1.1</code> and then enable in inside the
<code>conf.py</code> file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># conf.py</span>
</span></span><span class=line><span class=cl><span class=n>extensions</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;sphinx_autodoc_typehints&#39;</span><span class=p>]</span>
</span></span></code></pre></div><p>That&rsquo;s it all. An example use case of this is <a href=https://github.com/RookieGameDevs/revived>RookieGameDevs/revived</a>
documentation. For example, given the following source code:</p><figure><img src=sphinx_doc_src.webp width=800px></figure><p>You can get the following output:</p><figure><img src=sphinx_doc.webp width=800px></figure><h1 id=conclusion>Conclusion
<a class=heading-link href=#conclusion><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><p>So at the end of this long blog post, you may ask: is it worth using type hints, or when should one use them? I think
type hinting is at the end of the day virtually the same as your unit tests, just expressed differently in code. They
provide a standard (and re-usable for other goals) way to test the input and output types of your codebase.</p><p>Therefore, type hints <strong>should be used whenever the unit test is worth writing.</strong> This can be even just ten lines of
code if you need to maintain it later. Similarly, you should start adding type hints whenever you start writing unit
tests. The only place when I would not add them is when I don&rsquo;t write unit tests, such REPL lines, or throw away
one-time usage scripts.</p><p>Remember that, similar to unit tests, while it does makes your codebase contain an extra number of lines, at the end of
the day, all the code you add is code that is automatically checked and enforced to be correct. It acts as a safety net
to ensure that things keep working when you change things around later on, so probably worth paying this extra cost.</p><figure><img src=thats_all_folks.webp width=700px></figure></div><footer></footer></article></section></div><footer class=footer><section class=container><b>Opinions are my own</b> - Bernát Gábor software engineer.
Updated&nbsp;2022-06-04
via <a href=https://github.com/gaborbernat/bernat-tech/commit/2e9fcee9c5cf0e56b573ded4c891e4ac4339f5af>2e9fcee</a>
.
© 2018-2023</section></footer></main><script src=/js/coder.min.236049395dc3682fb2719640872958e12f1f24067bb09c327b233e6290c7edac.js integrity="sha256-I2BJOV3DaC+ycZZAhylY4S8fJAZ7sJwyeyM+YpDH7aw="></script>
<script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "3ead932f454449a799915b1721c18874"}'></script></body></html>